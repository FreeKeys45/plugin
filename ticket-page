<?php
/**
 * Support Ticket System - Ticket Page Functionality
 * Contains all ticket-related shortcodes and display functions
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

class Support_Ticket_Page_Functions {
    
    private static $instance = null;
    
    public static function get_instance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    public function __construct() {
        // This class is loaded by the main plugin file
    }

    // Shortcode implementations with improved styling
    public function support_form_shortcode($atts = array()) {
        if (!is_user_logged_in()) {
            return $this->login_required_message();
        }
       
        // Check if WooCommerce is active
        if (!class_exists('WooCommerce')) {
            return '<div class="support-ticket-container"><div class="support-ticket-card"><div class="support-ticket-alert support-ticket-alert-error">' . __('WooCommerce is required for this feature.', 'support-ticket-system') . '</div></div></div>';
        }
       
        $current_user = wp_get_current_user();
        $orders = $this->get_user_orders();
       
        // Get order_id from URL if present
        $order_id = isset($_GET['order_id']) ? intval($_GET['order_id']) : 0;
        $product_name = isset($_GET['product']) ? sanitize_text_field($_GET['product']) : '';
       
        ob_start();
        ?>
        <div class="support-ticket-system-wrapper">
            <div class="support-ticket-container">
                <div class="support-ticket-card">
                    <div class="support-ticket-submit-title">
                        <h1><?php _e('Create a Support Ticket', 'support-ticket-system'); ?></h1>
                        <p style="color: #718096; font-size: 16px; margin-top: 10px;"><?php _e('Fill out the form below to get help with your purchase', 'support-ticket-system'); ?></p>
                    </div>
                   
                    <div id="support-ticket-form-message"></div>
                   
                    <?php if (empty($orders)): ?>
                        <div class="support-ticket-alert support-ticket-alert-info">
                            <?php _e('You need to have at least one completed order to submit a support ticket.', 'support-ticket-system'); ?>
                        </div>
                    <?php else: ?>
                        <div class="support-ticket-form-container">
                            <form id="support-ticket-form" method="post" enctype="multipart/form-data">
                                <div class="support-ticket-form-section">
                                    <h3><?php _e('Order Information', 'support-ticket-system'); ?></h3>
                                    <?php if ($order_id): ?>
                                        <div class="support-ticket-order-info">
                                            <?php
                                            $order = wc_get_order($order_id);
                                            if ($order && $order->get_user_id() === $current_user->ID) {
                                                echo '<p><strong>' . __('Order ID:', 'support-ticket-system') . '</strong> #' . $order_id . '</p>';
                                                echo '<p><strong>' . __('Order Date:', 'support-ticket-system') . '</strong> ' . $order->get_date_created()->format('F j, Y') . '</p>';
                                                echo '<p><strong>' . __('Total:', 'support-ticket-system') . '</strong> ' . $order->get_formatted_order_total() . '</p>';
                                            }
                                            ?>
                                        </div>
                                        <input type="hidden" name="order_id" value="<?php echo $order_id; ?>">
                                    <?php else: ?>
                                        <div class="support-ticket-form-group">
                                            <label for="support-order-id"><?php _e('Order ID', 'support-ticket-system'); ?> *</label>
                                            <select id="support-order-id" name="order_id" class="support-ticket-form-control required" required>
                                                <option value=""><?php _e('Select your order', 'support-ticket-system'); ?></option>
                                                <?php foreach ($orders as $order): ?>
                                                    <option value="<?php echo $order->get_id(); ?>" <?php selected($order_id, $order->get_id()); ?>>
                                                        <?php printf(__('Order #%s - %s - %s', 'support-ticket-system'), $order->get_id(), $order->get_date_created()->format('M j, Y'), wc_price($order->get_total())); ?>
                                                    </option>
                                                <?php endforeach; ?>
                                            </select>
                                        </div>
                                    <?php endif; ?>
                                   
                                    <div class="support-ticket-form-group">
                                        <label for="support-product-name"><?php _e('Product', 'support-ticket-system'); ?> *</label>
                                        <select id="support-product-name" name="product_name" class="support-ticket-form-control required" required>
                                            <option value=""><?php _e('Select a product', 'support-ticket-system'); ?></option>
                                            <?php
                                            if ($order_id) {
                                                $selected_order = wc_get_order($order_id);
                                                if ($selected_order && $selected_order->get_user_id() === $current_user->ID) {
                                                    foreach ($selected_order->get_items() as $item) {
                                                        $product = $item->get_product();
                                                        if ($product) {
                                                            $selected = ($product_name && $product->get_name() === $product_name) ? 'selected' : '';
                                                            echo '<option value="' . esc_attr($product->get_name()) . '" ' . $selected . '>' . esc_html($product->get_name()) . '</option>';
                                                        }
                                                    }
                                                }
                                            }
                                            ?>
                                        </select>
                                    </div>
                                </div>

                                <div class="support-ticket-form-section">
                                    <h3><?php _e('Issue Details', 'support-ticket-system'); ?></h3>
                                   
                                    <div class="support-ticket-form-group">
                                        <label for="support-issue-category"><?php _e('Issue Category', 'support-ticket-system'); ?> *</label>
                                        <select id="support-issue-category" name="issue_category" class="support-ticket-form-control required" required>
                                            <option value=""><?php _e('Select a category', 'support-ticket-system'); ?></option>
                                            <option value="license_issue"><?php _e('Issue with License Key', 'support-ticket-system'); ?></option>
                                            <option value="technical"><?php _e('Technical Issue', 'support-ticket-system'); ?></option>
                                            <option value="billing"><?php _e('Billing Question', 'support-ticket-system'); ?></option>
                                            <option value="feature"><?php _e('Feature Request', 'support-ticket-system'); ?></option>
                                            <option value="other"><?php _e('Other', 'support-ticket-system'); ?></option>
                                        </select>
                                    </div>

                                    <div class="support-ticket-form-group support-ticket-license-section" style="display: none;">
                                        <div class="support-license-key-group">
                                            <label><?php _e('License Keys', 'support-ticket-system'); ?></label>
                                            <p class="support-license-key-description"><?php _e('Enter your license keys manually. Click the + button to add multiple keys.', 'support-ticket-system'); ?></p>
                                           
                                            <div class="support-license-keys-container">
                                                <div class="support-license-key-row">
                                                    <div class="support-license-key-input">
                                                        <input type="text" name="license_keys[]" class="support-ticket-form-control" placeholder="<?php _e('Enter license key manually', 'support-ticket-system'); ?>">
                                                    </div>
                                                    <button type="button" class="support-license-key-add">+ <?php _e('Add Key', 'support-ticket-system'); ?></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="support-ticket-form-group support-ticket-license-status-section" style="display: none;">
                                        <label for="support-license-status"><?php _e('License Key Status', 'support-ticket-system'); ?> *</label>
                                        <select id="support-license-status" name="license_status" class="support-ticket-form-control">
                                            <option value=""><?php _e('Select license status', 'support-ticket-system'); ?></option>
                                            <option value="invalid"><?php _e('Invalid License', 'support-ticket-system'); ?></option>
                                            <option value="revoked"><?php _e('License Revoked', 'support-ticket-system'); ?></option>
                                            <option value="duplicate"><?php _e('Duplicate License', 'support-ticket-system'); ?></option>
                                            <option value="expired"><?php _e('License Expired', 'support-ticket-system'); ?></option>
                                            <option value="activation_limit"><?php _e('Activation Limit Reached', 'support-ticket-system'); ?></option>
                                        </select>
                                    </div>
                                   
                                    <div class="support-ticket-form-group">
                                        <label for="support-priority"><?php _e('Priority', 'support-ticket-system'); ?></label>
                                        <select id="support-priority" name="priority" class="support-ticket-form-control">
                                            <option value="low"><?php _e('Low', 'support-ticket-system'); ?></option>
                                            <option value="medium" selected><?php _e('Medium', 'support-ticket-system'); ?></option>
                                            <option value="high"><?php _e('High', 'support-ticket-system'); ?></option>
                                            <option value="urgent"><?php _e('Urgent', 'support-ticket-system'); ?></option>
                                        </select>
                                    </div>
                                   
                                    <div class="support-ticket-form-group">
                                        <label for="support-description"><?php _e('Description', 'support-ticket-system'); ?> *</label>
                                        <textarea id="support-description" name="description" class="support-ticket-form-control required" rows="8" required placeholder="<?php _e('Please describe your issue in detail. Include any error messages, steps to reproduce, and what you were trying to accomplish.', 'support-ticket-system'); ?>"></textarea>
                                    </div>
                                </div>

                                <div class="support-ticket-form-section">
                                    <h3><?php _e('Attachments', 'support-ticket-system'); ?></h3>
                                    <div class="support-ticket-form-note">
                                        <strong><?php _e('Optional:', 'support-ticket-system'); ?></strong> <?php _e('You can upload screenshots or screen recordings to help us understand your issue better.', 'support-ticket-system'); ?>
                                    </div>
                                   
                                    <div class="support-ticket-form-group">
                                        <div class="support-ticket-file-upload">
                                            <input type="file" id="support-attachments" name="attachments[]" class="support-ticket-file-input" multiple accept=".png,.jpg,.jpeg,.pdf,.txt,.mp4,.mov,.avi,.webm">
                                            <small><?php _e('You can upload up to 5 files. Maximum file size: 50MB. Allowed types: PNG, JPG, JPEG, PDF, TXT, MP4, MOV, AVI, WEBM', 'support-ticket-system'); ?></small>
                                            <div class="support-ticket-file-list"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="support-ticket-form-section">
                                    <h3><?php _e('Contact Information', 'support-ticket-system'); ?></h3>
                                   
                                    <div class="support-ticket-form-group">
                                        <label for="support-name"><?php _e('Your Name', 'support-ticket-system'); ?> *</label>
                                        <input type="text" id="support-name" name="customer_name" class="support-ticket-form-control required" required value="<?php echo esc_attr($current_user->display_name); ?>">
                                    </div>
                                   
                                    <div class="support-ticket-form-group">
                                        <label for="support-email"><?php _e('Your Email', 'support-ticket-system'); ?> *</label>
                                        <input type="email" id="support-email" name="customer_email" class="support-ticket-form-control required" required value="<?php echo esc_attr($current_user->user_email); ?>">
                                    </div>
                                </div>
                               
                                <button type="submit" class="support-ticket-btn support-ticket-btn-primary support-ticket-btn-block" style="padding: 15px; font-size: 16px;">
                                    <?php _e('Create Support Ticket', 'support-ticket-system'); ?>
                                </button>
                            </form>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
   
    public function support_dashboard_shortcode($atts = array()) {
        if (!is_user_logged_in()) {
            return $this->login_required_message();
        }
       
        $current_user = wp_get_current_user();
        $tickets = $this->get_user_tickets($current_user->ID);
        $metrics = $this->get_ticket_metrics($current_user->ID);
       
        ob_start();
        ?>
        <div class="support-ticket-system-wrapper">
            <div class="support-ticket-container">
                <div class="support-ticket-card">
                    <div class="support-ticket-header">
                        <h1 class="support-ticket-title"><?php _e('My Support Tickets', 'support-ticket-system'); ?></h1>
                        <a href="<?php echo esc_url(home_url('/submit-ticket/')); ?>" class="support-ticket-btn support-ticket-btn-primary">
                            <?php _e('Create New Ticket', 'support-ticket-system'); ?>
                        </a>
                    </div>

                    <!-- Metrics Dashboard -->
                    <div class="support-ticket-metrics">
                        <div class="support-ticket-metric-card">
                            <div class="support-ticket-metric-value"><?php echo $metrics['total']; ?></div>
                            <div class="support-ticket-metric-label"><?php _e('Total Tickets', 'support-ticket-system'); ?></div>
                        </div>
                        <div class="support-ticket-metric-card">
                            <div class="support-ticket-metric-value"><?php echo $metrics['open']; ?></div>
                            <div class="support-ticket-metric-label"><?php _e('Open Tickets', 'support-ticket-system'); ?></div>
                        </div>
                        <div class="support-ticket-metric-card">
                            <div class="support-ticket-metric-value"><?php echo $metrics['closed']; ?></div>
                            <div class="support-ticket-metric-label"><?php _e('Closed Tickets', 'support-ticket-system'); ?></div>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="support-ticket-search">
                        <input type="text" id="support-ticket-search" placeholder="<?php _e('Search tickets...', 'support-ticket-system'); ?>">
                    </div>

                    <div class="support-ticket-filters">
                        <select id="support-status-filter">
                            <option value=""><?php _e('All Statuses', 'support-ticket-system'); ?></option>
                            <option value="open"><?php _e('Open', 'support-ticket-system'); ?></option>
                            <option value="pending"><?php _e('Pending', 'support-ticket-system'); ?></option>
                            <option value="closed"><?php _e('Closed', 'support-ticket-system'); ?></option>
                        </select>
                       
                        <select id="support-priority-filter">
                            <option value=""><?php _e('All Priorities', 'support-ticket-system'); ?></option>
                            <option value="urgent"><?php _e('Urgent', 'support-ticket-system'); ?></option>
                            <option value="high"><?php _e('High', 'support-ticket-system'); ?></option>
                            <option value="medium"><?php _e('Medium', 'support-ticket-system'); ?></option>
                            <option value="low"><?php _e('Low', 'support-ticket-system'); ?></option>
                        </select>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="support-ticket-bulk-actions">
                        <select id="support-bulk-action">
                            <option value=""><?php _e('Bulk Actions', 'support-ticket-system'); ?></option>
                            <option value="close"><?php _e('Close Tickets', 'support-ticket-system'); ?></option>
                        </select>
                        <button type="button" class="support-ticket-btn" id="support-apply-bulk"><?php _e('Apply', 'support-ticket-system'); ?></button>
                    </div>

                    <!-- Need Help Section -->
                    <div class="support-ticket-help-section-email">
                        <h3><?php _e('Need Help?', 'support-ticket-system'); ?></h3>
                        <p><?php _e('If you have any issues with your purchase, click the button below to report a problem:', 'support-ticket-system'); ?></p>
                        <a href="<?php echo esc_url(home_url('/submit-ticket/')); ?>" class="support-ticket-btn-report-email">
                            <span class="support-ticket-btn-icon">🔧</span>
                            <?php _e('Report a Problem', 'support-ticket-system'); ?>
                        </a>
                    </div>
                   
                    <?php if (empty($tickets)): ?>
                        <div class="support-ticket-no-tickets">
                            <p><?php _e('You haven\'t submitted any support tickets yet.', 'support-ticket-system'); ?></p>
                            <a href="<?php echo esc_url(home_url('/submit-ticket/')); ?>" class="support-ticket-btn support-ticket-btn-primary">
                                <?php _e('Create Your First Ticket', 'support-ticket-system'); ?>
                            </a>
                        </div>
                    <?php else: ?>
                        <div class="support-ticket-list">
                            <?php foreach ($tickets as $ticket):
                                $ticket_id = get_post_meta($ticket->ID, 'ticket_id', true);
                                $status = get_post_meta($ticket->ID, 'status', true);
                                $priority = get_post_meta($ticket->ID, 'priority', true);
                                $last_update = get_post_meta($ticket->ID, 'last_update', true);
                                $product_name = get_post_meta($ticket->ID, 'product_name', true);
                                $assigned_agent_id = get_post_meta($ticket->ID, 'assigned_agent', true);
                                $assigned_agent = $assigned_agent_id ? get_userdata($assigned_agent_id) : null;
                            ?>
                                <div class="support-ticket-item" data-ticket="<?php echo $ticket->ID; ?>">
                                    <input type="checkbox" class="support-ticket-checkbox" value="<?php echo $ticket->ID; ?>">
                                    <div class="support-ticket-id">#<?php echo esc_html($ticket_id ?: $ticket->ID); ?></div>
                                    <div class="support-ticket-product"><?php echo esc_html($product_name ?: __('No product', 'support-ticket-system')); ?></div>
                                    <?php if ($assigned_agent): ?>
                                        <div class="support-ticket-agent">
                                            <strong><?php _e('Agent:', 'support-ticket-system'); ?></strong> <?php echo esc_html($assigned_agent->display_name); ?>
                                        </div>
                                    <?php endif; ?>
                                    <div class="support-ticket-status support-status-<?php echo esc_attr($status ?: 'open'); ?>">
                                        <?php echo esc_html(ucfirst($status ?: 'open')); ?>
                                    </div>
                                    <div class="support-ticket-priority support-priority-<?php echo esc_attr($priority ?: 'medium'); ?>">
                                        <?php echo esc_html(ucfirst($priority ?: 'medium')); ?></div>
                                    <div class="support-ticket-date"><?php echo esc_html(date('M j, Y', strtotime($last_update ?: $ticket->post_date))); ?></div>
                                    <div class="support-ticket-quick-actions">
                                        <button class="support-ticket-quick-btn" data-action="view" data-ticket="<?php echo $ticket->ID; ?>">👁️</button>
                                        <?php if ($status !== 'closed'): ?>
                                            <button class="support-ticket-quick-btn" data-action="close" data-ticket="<?php echo $ticket->ID; ?>">✅</button>
                                        <?php endif; ?>
                                    </div>
                                    <a href="<?php echo esc_url($this->get_ticket_view_url($ticket_id ?: $ticket->ID)); ?>" class="support-ticket-btn support-ticket-btn-secondary">
                                        <?php _e('View', 'support-ticket-system'); ?>
                                    </a>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }

    // Agent Dashboard Shortcode with improved styling
    public function agent_dashboard_shortcode($atts = array()) {
        // Check if user is logged in and has agent role
        if (!is_user_logged_in()) {
            return $this->agent_login_form();
        }
       
        $current_user = wp_get_current_user();
        if (!in_array('support_agent', $current_user->roles) && !in_array('administrator', $current_user->roles)) {
            return '<div class="support-ticket-container"><div class="support-ticket-card"><div class="support-ticket-alert support-ticket-alert-error">' . __('You do not have permission to access this page.', 'support-ticket-system') . '</div></div></div>';
        }
       
        // Get tickets assigned to this agent or all tickets for admin
        $tickets = $this->get_agent_tickets($current_user->ID);
        $metrics = $this->get_agent_ticket_metrics($current_user->ID);
       
        ob_start();
        ?>
        <div class="support-ticket-system-wrapper">
            <div class="support-ticket-container">
                <div class="support-ticket-card">
                    <div class="support-ticket-header">
                        <h1 class="support-ticket-title"><?php _e('Agent Dashboard', 'support-ticket-system'); ?></h1>
                        <div>
                            <span class="support-ticket-welcome"><?php printf(__('Welcome, %s', 'support-ticket-system'), esc_html($current_user->display_name)); ?></span>
                            <a href="<?php echo wp_logout_url(home_url('/agent-dashboard/')); ?>" class="support-ticket-btn support-ticket-btn-danger">
                                <?php _e('Logout', 'support-ticket-system'); ?>
                            </a>
                        </div>
                    </div>

                    <!-- Metrics Dashboard -->
                    <div class="support-ticket-metrics">
                        <div class="support-ticket-metric-card">
                            <div class="support-ticket-metric-value"><?php echo $metrics['total']; ?></div>
                            <div class="support-ticket-metric-label"><?php _e('Total Tickets', 'support-ticket-system'); ?></div>
                        </div>
                        <div class="support-ticket-metric-card">
                            <div class="support-ticket-metric-value"><?php echo $metrics['open']; ?></div>
                            <div class="support-ticket-metric-label"><?php _e('Open Tickets', 'support-ticket-system'); ?></div>
                        </div>
                        <div class="support-ticket-metric-card">
                            <div class="support-ticket-metric-value"><?php echo $metrics['closed']; ?></div>
                            <div class="support-ticket-metric-label"><?php _e('Closed Tickets', 'support-ticket-system'); ?></div>
                        </div>
                        <div class="support-ticket-metric-card">
                            <div class="support-ticket-metric-value"><?php echo $metrics['pending']; ?></div>
                            <div class="support-ticket-metric-label"><?php _e('Pending Tickets', 'support-ticket-system'); ?></div>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="support-ticket-search">
                        <input type="text" id="support-ticket-search" placeholder="<?php _e('Search tickets...', 'support-ticket-system'); ?>">
                    </div>

                    <div class="support-ticket-filters">
                        <select id="support-status-filter">
                            <option value=""><?php _e('All Statuses', 'support-ticket-system'); ?></option>
                            <option value="open"><?php _e('Open', 'support-ticket-system'); ?></option>
                            <option value="pending"><?php _e('Pending', 'support-ticket-system'); ?></option>
                            <option value="closed"><?php _e('Closed', 'support-ticket-system'); ?></option>
                        </select>
                       
                        <select id="support-priority-filter">
                            <option value=""><?php _e('All Priorities', 'support-ticket-system'); ?></option>
                            <option value="urgent"><?php _e('Urgent', 'support-ticket-system'); ?></option>
                            <option value="high"><?php _e('High', 'support-ticket-system'); ?></option>
                            <option value="medium"><?php _e('Medium', 'support-ticket-system'); ?></option>
                            <option value="low"><?php _e('Low', 'support-ticket-system'); ?></option>
                        </select>
                       
                        <?php if (in_array('administrator', $current_user->roles)): ?>
                            <select id="support-agent-filter">
                                <option value=""><?php _e('All Agents', 'support-ticket-system'); ?></option>
                                <?php
                                $agents = get_users(array('role' => 'support_agent'));
                                foreach ($agents as $agent) {
                                    echo '<option value="' . $agent->ID . '">' . esc_html($agent->display_name) . '</option>';
                                }
                                ?>
                            </select>
                        <?php endif; ?>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="support-ticket-bulk-actions">
                        <select id="support-bulk-action">
                            <option value=""><?php _e('Bulk Actions', 'support-ticket-system'); ?></option>
                            <option value="close"><?php _e('Close Tickets', 'support-ticket-system'); ?></option>
                            <option value="assign"><?php _e('Assign to Me', 'support-ticket-system'); ?></option>
                        </select>
                        <button type="button" class="support-ticket-btn" id="support-apply-bulk"><?php _e('Apply', 'support-ticket-system'); ?></button>
                    </div>
               
                    <?php if (empty($tickets)): ?>
                        <div class="support-ticket-no-tickets">
                            <p><?php _e('No tickets found.', 'support-ticket-system'); ?></p>
                        </div>
                    <?php else: ?>
                        <div class="support-ticket-list">
                            <?php foreach ($tickets as $ticket):
                                $ticket_id = get_post_meta($ticket->ID, 'ticket_id', true);
                                $status = get_post_meta($ticket->ID, 'status', true);
                                $priority = get_post_meta($ticket->ID, 'priority', true);
                                $last_update = get_post_meta($ticket->ID, 'last_update', true);
                                $product_name = get_post_meta($ticket->ID, 'product_name', true);
                                $assigned_agent_id = get_post_meta($ticket->ID, 'assigned_agent', true);
                                $assigned_agent = $assigned_agent_id ? get_userdata($assigned_agent_id) : null;
                                $customer = get_userdata($ticket->post_author);
                            ?>
                                <div class="support-ticket-item" data-ticket="<?php echo $ticket->ID; ?>">
                                    <input type="checkbox" class="support-ticket-checkbox" value="<?php echo $ticket->ID; ?>">
                                    <div class="support-ticket-id">#<?php echo esc_html($ticket_id ?: $ticket->ID); ?></div>
                                    <div class="support-ticket-product"><?php echo esc_html($product_name ?: __('No product', 'support-ticket-system')); ?></div>
                                    <div class="support-ticket-customer">
                                        <strong><?php _e('Customer:', 'support-ticket-system'); ?></strong> <?php echo esc_html($customer ? $customer->display_name : __('Unknown', 'support-ticket-system')); ?>
                                    </div>
                                    <?php if ($assigned_agent): ?>
                                        <div class="support-ticket-agent">
                                            <strong><?php _e('Agent:', 'support-ticket-system'); ?></strong> <?php echo esc_html($assigned_agent->display_name); ?>
                                        </div>
                                    <?php endif; ?>
                                    <div class="support-ticket-status support-status-<?php echo esc_attr($status ?: 'open'); ?>">
                                        <?php echo esc_html(ucfirst($status ?: 'open')); ?>
                                    </div>
                                    <div class="support-ticket-priority support-priority-<?php echo esc_attr($priority ?: 'medium'); ?>">
                                        <?php echo esc_html(ucfirst($priority ?: 'medium')); ?>
                                    </div>
                                    <div class="support-ticket-date"><?php echo esc_html(date('M j, Y', strtotime($last_update ?: $ticket->post_date))); ?></div>
                                    <div class="support-ticket-quick-actions">
                                        <button class="support-ticket-quick-btn" data-action="view" data-ticket="<?php echo $ticket->ID; ?>">👁️</button>
                                        <?php if ($status !== 'closed'): ?>
                                            <button class="support-ticket-quick-btn" data-action="close" data-ticket="<?php echo $ticket->ID; ?>">✅</button>
                                        <?php endif; ?>
                                    </div>
                                    <a href="<?php echo esc_url($this->get_ticket_view_url($ticket_id ?: $ticket->ID)); ?>" class="support-ticket-btn support-ticket-btn-secondary">
                                        <?php _e('View', 'support-ticket-system'); ?>
                                    </a>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }

    // Agent login form with improved styling
    private function agent_login_form() {
        ob_start();
        ?>
        <div class="support-ticket-system-wrapper">
            <div class="support-ticket-container">
                <div class="support-ticket-card">
                    <div class="support-ticket-submit-title">
                        <h1><?php _e('Agent Login', 'support-ticket-system'); ?></h1>
                        <p style="color: #718096; font-size: 16px; margin-top: 10px;"><?php _e('Access the support agent dashboard', 'support-ticket-system'); ?></p>
                    </div>
                   
                    <div id="support-agent-login-message"></div>
                   
                    <form id="support-agent-login-form">
                        <div class="support-ticket-form-group">
                            <label for="agent-username"><?php _e('Username', 'support-ticket-system'); ?> *</label>
                            <input type="text" id="agent-username" name="log" class="support-ticket-form-control required" required>
                        </div>
                       
                        <div class="support-ticket-form-group">
                            <label for="agent-password"><?php _e('Password', 'support-ticket-system'); ?> *</label>
                            <input type="password" id="agent-password" name="pwd" class="support-ticket-form-control required" required>
                        </div>
                       
                        <div class="support-ticket-form-group">
                            <label>
                                <input type="checkbox" name="rememberme" value="forever">
                                <?php _e('Remember Me', 'support-ticket-system'); ?>
                            </label>
                        </div>
                       
                        <button type="submit" class="support-ticket-btn support-ticket-btn-primary support-ticket-btn-block">
                            <?php _e('Login to Dashboard', 'support-ticket-system'); ?>
                        </button>
                    </form>
                   
                    <p class="support-ticket-login-links">
                        <a href="<?php echo wp_lostpassword_url(home_url('/agent-dashboard/')); ?>">
                            <?php _e('Lost your password?', 'support-ticket-system'); ?>
                        </a>
                    </p>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
   
    public function ticket_view_shortcode($atts = array()) {
        if (!is_user_logged_in()) {
            return $this->login_required_message();
        }
       
        $ticket_id = isset($_GET['id']) ? sanitize_text_field($_GET['id']) : (isset($atts['id']) ? sanitize_text_field($atts['id']) : 0);
        if (!$ticket_id) {
            return '<div class="support-ticket-container"><div class="support-ticket-card"><div class="support-ticket-alert support-ticket-alert-error">' . __('Invalid ticket ID.', 'support-ticket-system') . '</div></div></div>';
        }
       
        // Find the ticket by ticket_id or post ID
        $tickets = get_posts(array(
            'post_type' => 'support_ticket',
            'meta_query' => array(
                'relation' => 'OR',
                array(
                    'key' => 'ticket_id',
                    'value' => $ticket_id,
                    'compare' => '=',
                )
            ),
            'posts_per_page' => 1,
        ));
       
        // If not found by meta, try by post ID
        if (empty($tickets) && is_numeric($ticket_id)) {
            $ticket = get_post($ticket_id);
            if ($ticket && $ticket->post_type === 'support_ticket') {
                $tickets = array($ticket);
            }
        }
       
        if (empty($tickets)) {
            return '<div class="support-ticket-container"><div class="support-ticket-card"><div class="support-ticket-alert support-ticket-alert-error">' . __('Ticket not found.', 'support-ticket-system') . '</div></div></div>';
        }
       
        $ticket = $tickets[0];
        $current_user = wp_get_current_user();
       
        // Check if user can view this ticket
        $can_view = false;
        if (current_user_can('administrator') || current_user_can('support_agent')) {
            $can_view = true;
        } elseif ($ticket->post_author == $current_user->ID) {
            $can_view = true;
        }
       
        if (!$can_view) {
            return '<div class="support-ticket-container"><div class="support-ticket-card"><div class="support-ticket-alert support-ticket-alert-error">' . __('You do not have permission to view this ticket.', 'support-ticket-system') . '</div></div></div>';
        }
       
        // Get ticket metadata
        $ticket_meta = array(
            'ticket_id' => get_post_meta($ticket->ID, 'ticket_id', true) ?: $ticket->ID,
            'order_id' => get_post_meta($ticket->ID, 'order_id', true),
            'order_date' => get_post_meta($ticket->ID, 'order_date', true),
            'product_name' => get_post_meta($ticket->ID, 'product_name', true),
            'license_keys' => get_post_meta($ticket->ID, 'license_keys', true) ?: array(),
            'customer_name' => get_post_meta($ticket->ID, 'customer_name', true),
            'customer_email' => get_post_meta($ticket->ID, 'customer_email', true),
            'status' => get_post_meta($ticket->ID, 'status', true) ?: 'open',
            'priority' => get_post_meta($ticket->ID, 'priority', true) ?: 'medium',
            'last_update' => get_post_meta($ticket->ID, 'last_update', true),
            'attachments' => get_post_meta($ticket->ID, 'attachments', true) ?: array(),
            'assigned_agent' => get_post_meta($ticket->ID, 'assigned_agent', true),
            'issue_category' => get_post_meta($ticket->ID, 'issue_category', true),
            'license_status' => get_post_meta($ticket->ID, 'license_status', true),
            'internal_notes' => get_post_meta($ticket->ID, 'internal_notes', true),
        );
       
        $assigned_agent = $ticket_meta['assigned_agent'] ? get_userdata($ticket_meta['assigned_agent']) : null;
       
        // Get replies
        $replies = get_posts(array(
            'post_type' => 'support_ticket_reply',
            'meta_query' => array(
                array(
                    'key' => 'ticket_id',
                    'value' => $ticket->ID,
                    'compare' => '=',
                ),
            ),
            'orderby' => 'date',
            'order' => 'ASC',
            'posts_per_page' => -1,
        ));
       
        // Get ticket timeline
        $timeline = $this->get_ticket_timeline($ticket->ID);
       
        ob_start();
        ?>
        <div class="support-ticket-system-wrapper">
            <div class="support-ticket-container">
                <div class="support-ticket-card">
                    <div class="support-ticket-header">
                        <h1 class="support-ticket-title"><?php printf(__('Ticket #%s', 'support-ticket-system'), esc_html($ticket_meta['ticket_id'])); ?></h1>
                        <div class="support-ticket-status support-status-<?php echo esc_attr($ticket_meta['status']); ?>">
                            <?php echo esc_html(ucfirst($ticket_meta['status'])); ?>
                        </div>
                    </div>
                   
                    <?php if ($assigned_agent): ?>
                        <div class="support-ticket-assigned-agent">
                            <strong><?php _e('Assigned Support Agent:', 'support-ticket-system'); ?></strong> <?php echo esc_html($assigned_agent->display_name); ?>
                            <?php if (current_user_can('administrator') || current_user_can('support_agent')): ?>
                                <br><small><?php _e('Email:', 'support-ticket-system'); ?> <?php echo esc_html($assigned_agent->user_email); ?></small>
                                <br>
                                <button class="support-remove-agent-btn" data-ticket-id="<?php echo $ticket->ID; ?>">
                                    <?php _e('Remove Agent from Ticket', 'support-ticket-system'); ?>
                                </button>
                            <?php endif; ?>
                        </div>
                    <?php endif; ?>

                    <!-- Agent Assignment (for admins/agents) -->
                    <?php if (current_user_can('administrator') || current_user_can('support_agent')): ?>
                        <?php $this->add_ticket_assignment_interface($ticket->ID); ?>
                    <?php endif; ?>

                    <!-- Internal Notes (for admins/agents) -->
                    <?php if (current_user_can('administrator') || current_user_can('support_agent')): ?>
                        <div class="support-ticket-internal-notes">
                            <h4><?php _e('Internal Notes', 'support-ticket-system'); ?></h4>
                            <textarea id="support-internal-notes" class="support-ticket-form-control" placeholder="<?php _e('Add internal notes here...', 'support-ticket-system'); ?>" data-ticket-id="<?php echo $ticket->ID; ?>"><?php echo esc_textarea($ticket_meta['internal_notes']); ?></textarea>
                            <button type="button" class="support-ticket-btn" id="support-save-notes" data-ticket-id="<?php echo $ticket->ID; ?>"><?php _e('Save Notes', 'support-ticket-system'); ?></button>
                        </div>
                    <?php endif; ?>
                   
                    <div class="support-ticket-message">
                        <div class="support-ticket-message-header">
                            <div class="support-ticket-message-author">
                                <?php echo esc_html($ticket_meta['customer_name'] ?: $current_user->display_name); ?>
                                <?php if ($assigned_agent && $ticket->post_author != $assigned_agent->ID): ?>
                                    <span class="support-ticket-message-agent">(<?php _e('Customer', 'support-ticket-system'); ?>)</span>
                                <?php endif; ?>
                            </div>
                            <div class="support-ticket-message-date"><?php echo esc_html(date('M j, Y H:i', strtotime($ticket->post_date))); ?></div>
                        </div>
                        <div class="support-ticket-message-content">
                            <p><strong><?php _e('Product:', 'support-ticket-system'); ?></strong> <?php echo esc_html($ticket_meta['product_name'] ?: __('Not specified', 'support-ticket-system')); ?></p>
                            <?php if ($ticket_meta['order_id']): ?>
                                <p><strong><?php _e('Order ID:', 'support-ticket-system'); ?></strong> <?php echo esc_html($ticket_meta['order_id']); ?></p>
                            <?php endif; ?>
                            <?php if (!empty($ticket_meta['license_keys'])): ?>
                                <p><strong><?php _e('License Keys:', 'support-ticket-system'); ?></strong>
                                    <?php
                                    if (is_array($ticket_meta['license_keys'])) {
                                        echo esc_html(implode(', ', $ticket_meta['license_keys']));
                                    } else {
                                        echo esc_html($ticket_meta['license_keys']);
                                    }
                                    ?>
                                </p>
                            <?php endif; ?>
                            <?php if ($ticket_meta['issue_category'] === 'license_issue' && $ticket_meta['license_status']): ?>
                                <p><strong><?php _e('License Status:', 'support-ticket-system'); ?></strong>
                                    <span class="support-ticket-license-status license-status-<?php echo esc_attr($ticket_meta['license_status']); ?>">
                                        <?php echo esc_html(ucfirst(str_replace('_', ' ', $ticket_meta['license_status']))); ?>
                                    </span>
                                </p>
                            <?php endif; ?>
                            <p><strong><?php _e('Priority:', 'support-ticket-system'); ?></strong> <span class="support-ticket-priority support-priority-<?php echo esc_attr($ticket_meta['priority']); ?>"><?php echo esc_html(ucfirst($ticket_meta['priority'])); ?></span></p>
                            <p><strong><?php _e('Category:', 'support-ticket-system'); ?></strong> <?php echo esc_html(ucfirst(str_replace('_', ' ', $ticket_meta['issue_category']))); ?></p>
                            <div class="support-ticket-message-content-text">
                                <?php echo wpautop(wp_kses_post($ticket->post_content)); ?>
                            </div>
                        </div>
                        <?php if (!empty($ticket_meta['attachments'])): ?>
                            <div class="support-ticket-attachments">
                                <h4><?php _e('Attachments:', 'support-ticket-system'); ?></h4>
                                <?php foreach ((array)$ticket_meta['attachments'] as $attachment):
                                    $is_video = in_array(pathinfo($attachment['name'], PATHINFO_EXTENSION), ['mp4', 'mov', 'avi', 'webm']);
                                ?>
                                    <?php if ($is_video): ?>
                                        <a href="<?php echo esc_url($attachment['url']); ?>" class="support-ticket-attachment" target="_blank">
                                            <?php echo esc_html($attachment['name']); ?>
                                        </a>
                                    <?php else: ?>
                                        <a href="<?php echo esc_url($attachment['url']); ?>" class="support-ticket-attachment" target="_blank">
                                            <?php echo esc_html($attachment['name']); ?>
                                        </a>
                                    <?php endif; ?>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                    </div>
                   
                    <?php if (!empty($replies)): ?>
                        <h3><?php _e('Conversation', 'support-ticket-system'); ?></h3>
                        <?php foreach ($replies as $reply): ?>
                            <?php
                            $reply_author = get_userdata($reply->post_author);
                            $reply_attachments = get_post_meta($reply->ID, 'attachments', true) ?: array();
                            $is_agent = $reply_author && ($reply_author->has_cap('administrator') || $reply_author->has_cap('support_agent'));
                            ?>
                            <div class="support-ticket-message">
                                <div class="support-ticket-message-header">
                                    <div class="support-ticket-message-author">
                                        <?php echo esc_html($reply_author ? $reply_author->display_name : __('Unknown', 'support-ticket-system')); ?>
                                        <?php if ($is_agent): ?>
                                            <span class="support-ticket-message-agent">(<?php _e('Support Agent', 'support-ticket-system'); ?>)</span>
                                        <?php endif; ?>
                                    </div>
                                    <div class="support-ticket-message-date"><?php echo esc_html(date('M j, Y H:i', strtotime($reply->post_date))); ?></div>
                                </div>
                                <div class="support-ticket-message-content">
                                    <?php echo wpautop(wp_kses_post($reply->post_content)); ?>
                                </div>
                                <?php if (!empty($reply_attachments)): ?>
                                    <div class="support-ticket-attachments">
                                        <h4><?php _e('Attachments:', 'support-ticket-system'); ?></h4>
                                        <?php foreach ((array)$reply_attachments as $attachment):
                                            $is_video = in_array(pathinfo($attachment['name'], PATHINFO_EXTENSION), ['mp4', 'mov', 'avi', 'webm']);
                                        ?>
                                            <?php if ($is_video): ?>
                                                <a href="<?php echo esc_url($attachment['url']); ?>" class="support-ticket-attachment" target="_blank">
                                                    <?php echo esc_html($attachment['name']); ?>
                                                </a>
                                            <?php else: ?>
                                                <a href="<?php echo esc_url($attachment['url']); ?>" class="support-ticket-attachment" target="_blank">
                                                    <?php echo esc_html($attachment['name']); ?>
                                                </a>
                                            <?php endif; ?>
                                        <?php endforeach; ?>
                                    </div>
                                <?php endif; ?>
                            </div>
                        <?php endforeach; ?>
                    <?php endif; ?>

                    <!-- Ticket Timeline -->
                    <?php if (!empty($timeline)): ?>
                        <div class="support-ticket-timeline">
                            <h3><?php _e('Ticket History', 'support-ticket-system'); ?></h3>
                            <?php foreach ($timeline as $event): ?>
                                <div class="support-ticket-timeline-item">
                                    <div class="support-ticket-timeline-date">
                                        <?php echo esc_html(date('M j, Y H:i', strtotime($event['date']))); ?>
                                    </div>
                                    <div class="support-ticket-timeline-content">
                                        <strong><?php echo esc_html($event['description']); ?></strong>
                                        <?php if (isset($event['user'])): ?>
                                            <br><small><?php _e('By:', 'support-ticket-system'); ?> <?php echo esc_html($event['user']->display_name); ?></small>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                   
                    <?php if ($ticket_meta['status'] !== 'closed'): ?>
                        <div class="support-ticket-reply-form">
                            <h3><?php _e('Add Reply', 'support-ticket-system'); ?></h3>
                            <div id="support-ticket-reply-message"></div>
                            <form id="support-ticket-reply-form" enctype="multipart/form-data">
                                <input type="hidden" name="ticket_id" value="<?php echo esc_attr($ticket->ID); ?>">
                               
                                <div class="support-ticket-form-group">
                                    <label for="support-reply-content"><?php _e('Your Reply', 'support-ticket-system'); ?> *</label>
                                    <textarea id="support-reply-content" name="content" class="support-ticket-form-control required" rows="6" required placeholder="<?php _e('Type your reply here', 'support-ticket-system'); ?>"></textarea>
                                </div>
                               
                                <div class="support-ticket-form-group">
                                    <label for="support-reply-attachments"><?php _e('Attachments (Screenshots/Videos)', 'support-ticket-system'); ?></label>
                                    <div class="support-ticket-file-upload">
                                        <input type="file" id="support-reply-attachments" name="attachments[]" class="support-ticket-file-input" multiple accept=".png,.jpg,.jpeg,.pdf,.txt,.mp4,.mov,.avi,.webm">
                                        <small><?php _e('You can upload up to 5 files. Maximum file size: 50MB. Allowed types: PNG, JPG, JPEG, PDF, TXT, MP4, MOV, AVI, WEBM', 'support-ticket-system'); ?></small>
                                        <div class="support-ticket-file-list"></div>
                                    </div>
                                </div>
                               
                                <button type="submit" class="support-ticket-btn support-ticket-btn-primary">
                                    <?php _e('Submit Reply', 'support-ticket-system'); ?>
                                </button>
                            </form>
                        </div>
                       
                        <div class="support-ticket-close-section">
                            <div id="support-ticket-close-message"></div>
                            <button class="support-ticket-btn support-ticket-btn-danger support-ticket-close-btn" data-ticket-id="<?php echo esc_attr($ticket->ID); ?>">
                                <?php _e('Close Ticket', 'support-ticket-system'); ?>
                            </button>
                        </div>
                    <?php else: ?>
                        <div class="support-ticket-alert support-ticket-alert-info">
                            <?php _e('This ticket is closed. You cannot add new replies.', 'support-ticket-system'); ?>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }

    // Helper methods for ticket page functionality
    private function get_user_orders() {
        if (!is_user_logged_in() || !class_exists('WooCommerce')) {
            return array();
        }
       
        $customer_orders = wc_get_orders(array(
            'customer_id' => get_current_user_id(),
            'limit' => -1,
            'orderby' => 'date',
            'order' => 'DESC',
            'status' => array('completed', 'processing'),
        ));
       
        return $customer_orders;
    }
   
    private function get_user_tickets($user_id, $page = 1, $per_page = 10) {
        $args = array(
            'post_type' => 'support_ticket',
            'author' => $user_id,
            'posts_per_page' => $per_page,
            'paged' => $page,
            'orderby' => 'date',
            'order' => 'DESC',
        );
       
        return get_posts($args);
    }
   
    private function get_agent_tickets($agent_id) {
        $current_user = wp_get_current_user();
       
        // If admin, get all tickets
        if (in_array('administrator', $current_user->roles)) {
            $args = array(
                'post_type' => 'support_ticket',
                'posts_per_page' => -1,
                'orderby' => 'date',
                'order' => 'DESC',
            );
        } else {
            // If agent, get tickets assigned to them
            $args = array(
                'post_type' => 'support_ticket',
                'meta_query' => array(
                    array(
                        'key' => 'assigned_agent',
                        'value' => $agent_id,
                        'compare' => '=',
                    ),
                ),
                'posts_per_page' => -1,
                'orderby' => 'date',
                'order' => 'DESC',
            );
        }
       
        return get_posts($args);
    }

    private function get_agent_ticket_metrics($agent_id) {
        $tickets = $this->get_agent_tickets($agent_id);
       
        $metrics = array(
            'total' => count($tickets),
            'open' => 0,
            'closed' => 0,
            'pending' => 0,
        );
       
        foreach ($tickets as $ticket) {
            $status = get_post_meta($ticket->ID, 'status', true);
            if ($status === 'open') {
                $metrics['open']++;
            } elseif ($status === 'closed') {
                $metrics['closed']++;
            } elseif ($status === 'pending') {
                $metrics['pending']++;
            }
        }
       
        return $metrics;
    }
   
    private function get_ticket_view_url($ticket_id) {
        return add_query_arg('id', $ticket_id, home_url('/ticket-view/'));
    }
   
    private function login_required_message() {
        return '<div class="support-ticket-container">
            <div class="support-ticket-card">
                <div class="support-ticket-alert support-ticket-alert-error">
                    <p>' . __('Please log in to access the support system.', 'support-ticket-system') . '</p>
                </div>
                <a href="' . wp_login_url(get_permalink()) . '" class="support-ticket-btn support-ticket-btn-block">
                    ' . __('Login to Continue', 'support-ticket-system') . '
                </a>
            </div>
        </div>';
    }

    private function get_ticket_metrics($user_id = null) {
        $user_id = $user_id ?: get_current_user_id();
       
        $all_tickets = $this->get_user_tickets($user_id);
        $open_tickets = array_filter($all_tickets, function($ticket) {
            return get_post_meta($ticket->ID, 'status', true) === 'open';
        });
       
        $closed_tickets = array_filter($all_tickets, function($ticket) {
            return get_post_meta($ticket->ID, 'status', true) === 'closed';
        });
       
        return array(
            'total' => count($all_tickets),
            'open' => count($open_tickets),
            'closed' => count($closed_tickets),
            'response_rate' => $this->calculate_response_rate($user_id)
        );
    }

    private function calculate_response_rate($user_id) {
        return '95%';
    }

    private function get_ticket_timeline($ticket_id) {
        $timeline = array();
       
        // Ticket creation
        $ticket = get_post($ticket_id);
        $timeline[] = array(
            'date' => $ticket->post_date,
            'action' => 'ticket_created',
            'user' => get_userdata($ticket->post_author),
            'description' => __('Ticket created', 'support-ticket-system')
        );
       
        // Status changes
        $status_changes = get_post_meta($ticket_id, 'status_history', true);
        if ($status_changes) {
            $timeline = array_merge($timeline, $status_changes);
        }
       
        // Agent assignments
        $agent_changes = get_post_meta($ticket_id, 'agent_history', true);
        if ($agent_changes) {
            $timeline = array_merge($timeline, $agent_changes);
        }
       
        usort($timeline, function($a, $b) {
            return strtotime($a['date']) - strtotime($b['date']);
        });
       
        return $timeline;
    }

    public function add_ticket_assignment_interface($ticket_id) {
        if (!current_user_can('administrator') && !current_user_can('support_agent')) {
            return;
        }
       
        // Only get users who have been explicitly added as support agents
        $agents = get_users(array(
            'meta_key' => 'is_explicit_support_agent',
            'meta_value' => true,
            'fields' => array('ID', 'display_name')
        ));
       
        $current_agent = get_post_meta($ticket_id, 'assigned_agent', true);
       
        echo '<div class="support-ticket-assignment">';
        echo '<label for="support-assign-agent">' . __('Assign to:', 'support-ticket-system') . '</label>';
        echo '<select id="support-assign-agent" data-ticket-id="' . $ticket_id . '">';
        echo '<option value="">' . __('Unassigned', 'support-ticket-system') . '</option>';
        foreach ($agents as $agent) {
            $selected = $current_agent == $agent->ID ? 'selected' : '';
            echo '<option value="' . $agent->ID . '" ' . $selected . '>' . esc_html($agent->display_name) . '</option>';
        }
        echo '</select>';
        echo '</div>';
    }
}

// Initialize the ticket page functionality
function support_ticket_page_functions_init() {
    return Support_Ticket_Page_Functions::get_instance();
}
