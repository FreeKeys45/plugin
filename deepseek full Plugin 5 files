File Structure:
support-ticket-system/
├── support-ticket-system.php (Main plugin file)
└── includes/
    └── ticket-page.php (Ticket page functionality)
  File 1: Main Plugin File (support-ticket-system.php)
    <?php
/**
 * Plugin Name: Support Ticket System
 * Plugin URI: https://yourwebsite.com
 * Description: Advanced customer support system with WooCommerce integration
 * Version: 1.4.1
 * Author: Your Company
 * Text Domain: support-ticket-system
 * Requires PHP: 7.4
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// Include the ticket page functionality
require_once plugin_dir_path(__FILE__) . 'includes/ticket-page.php';

class Support_Ticket_System {
   
    private static $instance = null;
   
    public static function get_instance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
   
    public function __construct() {
        add_action('init', array($this, 'init'));
        register_activation_hook(__FILE__, array($this, 'activate'));
        register_deactivation_hook(__FILE__, array($this, 'deactivate'));
       
        // Load text domain for translations
        add_action('plugins_loaded', array($this, 'load_textdomain'));
    }
   
    public function load_textdomain() {
        load_plugin_textdomain('support-ticket-system', false, dirname(plugin_basename(__FILE__)) . '/languages');
    }
   
    public function init() {
        $this->register_post_type();
        $this->register_taxonomies();
        $this->add_roles();
        $this->init_hooks();
        $this->add_my_tickets_endpoint();
        $this->create_support_pages();
    }
   
    private function init_hooks() {
        // Shortcodes
        add_shortcode('support_ticket_form', array($this, 'support_form_shortcode'));
        add_shortcode('support_ticket_dashboard', array($this, 'support_dashboard_shortcode'));
        add_shortcode('support_ticket_view', array($this, 'ticket_view_shortcode'));
        add_shortcode('support_agent_dashboard', array($this, 'agent_dashboard_shortcode'));
       
        // Scripts and styles
        add_action('wp_enqueue_scripts', array($this, 'enqueue_scripts'));
       
        // AJAX handlers
        add_action('wp_ajax_support_submit_ticket', array($this, 'ajax_submit_ticket'));
        add_action('wp_ajax_nopriv_support_submit_ticket', array($this, 'ajax_submit_ticket'));
        add_action('wp_ajax_support_submit_reply', array($this, 'ajax_submit_reply'));
        add_action('wp_ajax_nopriv_support_submit_reply', array($this, 'ajax_submit_reply'));
        add_action('wp_ajax_support_close_ticket', array($this, 'ajax_close_ticket'));
        add_action('wp_ajax_support_assign_agent', array($this, 'ajax_assign_agent'));
        add_action('wp_ajax_support_remove_agent', array($this, 'ajax_remove_agent'));
        add_action('wp_ajax_support_merge_tickets', array($this, 'ajax_merge_tickets'));
        add_action('wp_ajax_support_search_tickets', array($this, 'ajax_search_tickets'));
        add_action('wp_ajax_support_save_internal_notes', array($this, 'ajax_save_internal_notes'));
        add_action('wp_ajax_support_bulk_action', array($this, 'ajax_bulk_action'));
        add_action('wp_ajax_support_add_agent', array($this, 'ajax_add_agent'));
        add_action('wp_ajax_support_remove_agents', array($this, 'ajax_remove_agents'));
        add_action('wp_ajax_support_agent_login', array($this, 'ajax_agent_login'));
        add_action('wp_ajax_nopriv_support_agent_login', array($this, 'ajax_agent_login'));
        add_action('wp_ajax_support_get_order_products', array($this, 'ajax_get_order_products'));
        add_action('wp_ajax_nopriv_support_get_order_products', array($this, 'ajax_get_order_products'));
        add_action('wp_ajax_support_get_license_keys', array($this, 'ajax_get_license_keys'));
        add_action('wp_ajax_nopriv_support_get_license_keys', array($this, 'ajax_get_license_keys'));
       
        // WooCommerce integration - only if WooCommerce is active
        if (class_exists('WooCommerce')) {
            add_action('woocommerce_order_details_after_order_table', array($this, 'add_report_problem_button'));
            add_action('woocommerce_email_after_order_table', array($this, 'add_report_button_to_email'), 10, 4);
            add_filter('woocommerce_account_menu_items', array($this, 'add_my_tickets_menu_item'));
            add_action('init', array($this, 'add_my_tickets_endpoint'));
            add_action('woocommerce_account_my-tickets_endpoint', array($this, 'my_tickets_content'));
        }

        // Admin hooks
        add_action('admin_menu', array($this, 'add_support_agents_menu'));
        add_action('admin_init', array($this, 'handle_agent_management'));
        
        // Add handler for removing support agents
        add_action('admin_post_remove_support_agent', array($this, 'handle_remove_support_agent'));
       
        // Force create pages on init
        add_action('wp_loaded', array($this, 'force_create_pages'));

        // Add admin scripts and styles
        add_action('admin_enqueue_scripts', array($this, 'admin_enqueue_scripts'));
    }

    public function admin_enqueue_scripts($hook) {
        if ('support_ticket_page_support-agents' === $hook ||
            'support_ticket_page_add-support-agent' === $hook ||
            'support_ticket_page_assign-support-agent' === $hook ||
            'support_ticket_page_remove-support-agents' === $hook) {
           
            wp_enqueue_style('support-ticket-admin-css', false);
            wp_add_inline_style('support-ticket-admin-css', $this->get_admin_css());
           
            wp_enqueue_script('support-ticket-admin-js', false, array('jquery'), '1.0', true);
            wp_add_inline_script('support-ticket-admin-js', $this->get_admin_js());
        }
    }

    private function get_admin_css() {
        return "
        .support-agents-wrap { margin: 20px; }
        .support-agents-wrap .card { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .support-agents-wrap table.widefat { border-radius: 8px; overflow: hidden; }
        .support-agents-wrap .form-table th { width: 200px; }
        .support-agent-actions { display: flex; gap: 10px; }
        .support-ticket-loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: support-ticket-spin 1s ease-in-out infinite; }
        @keyframes support-ticket-spin { to { transform: rotate(360deg); } }
        .support-agent-checkbox { margin-right: 10px; }
        .support-agent-bulk-actions { margin: 20px 0; }
        .support-agent-bulk-actions select { margin-right: 10px; }
        .support-agent-notice { padding: 10px 15px; margin: 20px 0; border-radius: 4px; }
        .support-agent-notice-success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .support-agent-notice-error { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .support-remove-agent-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .support-remove-agent-btn:hover { background: #c82333; }
        .support-remove-agent-btn:disabled { background: #6c757d; cursor: not-allowed; }
        ";
    }

    private function get_admin_js() {
        return "
        jQuery(document).ready(function($) {
            // Remove agent from ticket
            $('.support-remove-agent-btn').on('click', function(e) {
                e.preventDefault();
               
                var button = $(this);
                var ticketId = button.data('ticket-id');
                var originalText = button.html();
               
                if (!confirm('Are you sure you want to remove the agent from this ticket?')) {
                    return;
                }
               
                button.prop('disabled', true).html('<span class=\"support-ticket-loading\"></span> Removing...');
               
                $.ajax({
                    url: ajaxurl,
                    type: 'POST',
                    data: {
                        action: 'support_remove_agent',
                        ticket_id: ticketId,
                        nonce: '" . wp_create_nonce('support_ticket_nonce') . "'
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.data.message);
                            button.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        alert('An error occurred. Please try again.');
                        button.prop('disabled', false).html(originalText);
                    }
                });
            });

            // Bulk remove agents - FIXED VERSION
            $('#support-apply-bulk-remove').on('click', function() {
                var selectedAgents = [];
                $('.support-agent-checkbox:checked').each(function() {
                    selectedAgents.push($(this).val());
                });
               
                if (selectedAgents.length === 0) {
                    alert('Please select at least one agent to remove.');
                    return;
                }
               
                var actionType = $('#support-bulk-action-remove').val();
               
                if (!confirm('Are you sure you want to remove the selected agents? This will not delete their WordPress user accounts.')) {
                    return;
                }
               
                var button = $(this);
                var originalText = button.html();
                button.prop('disabled', true).html('<span class=\"support-ticket-loading\"></span> Removing...');
               
                $.ajax({
                    url: ajaxurl,
                    type: 'POST',
                    data: {
                        action: 'support_remove_agents',
                        agent_ids: selectedAgents,
                        action_type: actionType,
                        nonce: '" . wp_create_nonce('support_ticket_nonce') . "'
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.data.message);
                            button.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        alert('An error occurred. Please try again.');
                        button.prop('disabled', false).html(originalText);
                    }
                });
            });

            // Select all checkbox
            $('#support-select-all-agents').on('change', function() {
                $('.support-agent-checkbox').prop('checked', $(this).prop('checked'));
            });
        });
        ";
    }

    public function force_create_pages() {
        if (!get_option('support_ticket_pages_created_v3')) {
            $this->create_support_pages();
            update_option('support_ticket_pages_created_v3', true);
        }
    }

    // Add support agents management menu UNDER SUPPORT TICKETS
    public function add_support_agents_menu() {
        // Main Support Agents menu
        add_submenu_page(
            'edit.php?post_type=support_ticket',
            __('Support Agents', 'support-ticket-system'),
            __('Support Agents', 'support-ticket-system'),
            'manage_options',
            'support-agents',
            array($this, 'support_agents_page')
        );
       
        // Add Support Agent submenu
        add_submenu_page(
            'edit.php?post_type=support_ticket',
            __('Add Support Agent', 'support-ticket-system'),
            __('Add Support Agent', 'support-ticket-system'),
            'manage_options',
            'add-support-agent',
            array($this, 'add_support_agent_page')
        );
       
        // Assign Support Agent submenu
        add_submenu_page(
            'edit.php?post_type=support_ticket',
            __('Assign Support Agent', 'support-ticket-system'),
            __('Assign Support Agent', 'support-ticket-system'),
            'manage_options',
            'assign-support-agent',
            array($this, 'assign_support_agent_page')
        );
       
        // Remove Support Agents submenu
        add_submenu_page(
            'edit.php?post_type=support_ticket',
            __('Remove Support Agents', 'support-ticket-system'),
            __('Remove Support Agents', 'support-ticket-system'),
            'manage_options',
            'remove-support-agents',
            array($this, 'remove_support_agents_page')
        );
    }

    public function support_agents_page() {
        // Check capabilities
        if (!current_user_can('manage_options')) {
            wp_die(__('You do not have sufficient permissions to access this page.', 'support-ticket-system'));
        }

        // Only get users who have been explicitly added as support agents
        $users = get_users(array(
            'meta_key' => 'is_explicit_support_agent',
            'meta_value' => true,
            'fields' => array('ID', 'display_name', 'user_email')
        ));

        $agents = array();
        foreach ($users as $user) {
            // Get the user object with roles
            $user_with_roles = get_userdata($user->ID);
           
            // Safely check if roles exist and are arrays
            if ($user_with_roles && isset($user_with_roles->roles) && is_array($user_with_roles->roles)) {
                $user_roles = $user_with_roles->roles;
                // Add roles to the user object for display
                $user->roles = $user_roles;
                $agents[] = $user;
            }
        }
        ?>
        <div class="wrap support-agents-wrap">
            <h1><?php _e('Support Agents Management', 'support-ticket-system'); ?></h1>
           
            <?php
            // Display admin notices
            if (isset($_GET['message'])) {
                $message_type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : 'success';
                $message = sanitize_text_field($_GET['message']);
                echo '<div class="notice notice-' . esc_attr($message_type) . ' is-dismissible"><p>' . esc_html($message) . '</p></div>';
            }
            ?>
           
            <div class="card">
                <h2><?php _e('Available Support Agents', 'support-ticket-system'); ?></h2>
                <table class="wp-list-table widefat fixed striped">
                    <thead>
                        <tr>
                            <th><?php _e('Name', 'support-ticket-system'); ?></th>
                            <th><?php _e('Email', 'support-ticket-system'); ?></th>
                            <th><?php _e('Role', 'support-ticket-system'); ?></th>
                            <th><?php _e('Assigned Tickets', 'support-ticket-system'); ?></th>
                            <th><?php _e('Actions', 'support-ticket-system'); ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php if (empty($agents)): ?>
                            <tr>
                                <td colspan="5"><?php _e('No support agents found.', 'support-ticket-system'); ?></td>
                            </tr>
                        <?php else: ?>
                            <?php foreach ($agents as $agent):
                                $assigned_tickets = $this->get_agent_ticket_count($agent->ID);
                                $role_names = array();
                                if (isset($agent->roles) && is_array($agent->roles)) {
                                    $role_names = array_map(function($role) {
                                        return ucfirst($role);
                                    }, $agent->roles);
                                } else {
                                    $role_names = array(__('No role', 'support-ticket-system'));
                                }
                            ?>
                                <tr>
                                    <td><?php echo esc_html($agent->display_name); ?></td>
                                    <td><?php echo esc_html($agent->user_email); ?></td>
                                    <td><?php echo implode(', ', $role_names); ?></td>
                                    <td><?php echo $assigned_tickets; ?></td>
                                    <td class="support-agent-actions">
                                        <a href="<?php echo admin_url('edit.php?post_type=support_ticket&assigned_agent=' . $agent->ID); ?>" class="button">
                                            <?php _e('View Tickets', 'support-ticket-system'); ?>
                                        </a>
                                        <a href="<?php echo admin_url('user-edit.php?user_id=' . $agent->ID); ?>" class="button">
                                            <?php _e('Edit User', 'support-ticket-system'); ?>
                                        </a>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
        <?php
    }

    public function add_support_agent_page() {
        // Check capabilities
        if (!current_user_can('manage_options')) {
            wp_die(__('You do not have sufficient permissions to access this page.', 'support-ticket-system'));
        }

        // Handle agent creation
        if (isset($_POST['create_agent']) && check_admin_referer('create_support_agent')) {
            $this->create_support_agent();
        }
        ?>
        <div class="wrap support-agents-wrap">
            <h1><?php _e('Add Support Agent', 'support-ticket-system'); ?></h1>
           
            <?php
            // Display admin notices
            if (isset($_GET['message'])) {
                $message_type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : 'success';
                $message = sanitize_text_field($_GET['message']);
                echo '<div class="notice notice-' . esc_attr($message_type) . ' is-dismissible"><p>' . esc_html($message) . '</p></div>';
            }
            ?>
           
            <div class="card">
                <h2><?php _e('Create New Support Agent', 'support-ticket-system'); ?></h2>
                <form method="post" action="">
                    <?php wp_nonce_field('create_support_agent'); ?>
                    <table class="form-table">
                        <tr>
                            <th scope="row"><label for="agent_username"><?php _e('Username', 'support-ticket-system'); ?> *</label></th>
                            <td><input type="text" name="agent_username" id="agent_username" required class="regular-text"></td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="agent_email"><?php _e('Email', 'support-ticket-system'); ?> *</label></th>
                            <td><input type="email" name="agent_email" id="agent_email" required class="regular-text"></td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="agent_first_name"><?php _e('First Name', 'support-ticket-system'); ?></label></th>
                            <td><input type="text" name="agent_first_name" id="agent_first_name" class="regular-text"></td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="agent_last_name"><?php _e('Last Name', 'support-ticket-system'); ?></label></th>
                            <td><input type="text" name="agent_last_name" id="agent_last_name" class="regular-text"></td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="agent_password"><?php _e('Password', 'support-ticket-system'); ?> *</label></th>
                            <td>
                                <input type="password" name="agent_password" id="agent_password" required class="regular-text">
                                <p class="description"><?php _e('Set a strong password for the new agent.', 'support-ticket-system'); ?></p>
                            </td>
                        </tr>
                    </table>
                    <?php submit_button(__('Create Support Agent', 'support-ticket-system'), 'primary', 'create_agent'); ?>
                </form>
            </div>
        </div>
        <?php
    }

    public function assign_support_agent_page() {
        // Check capabilities
        if (!current_user_can('manage_options')) {
            wp_die(__('You do not have sufficient permissions to access this page.', 'support-ticket-system'));
        }

        // Handle agent assignment
        if (isset($_POST['assign_agent']) && check_admin_referer('assign_support_agent')) {
            $this->assign_support_agent();
        }
        ?>
        <div class="wrap support-agents-wrap">
            <h1><?php _e('Assign Support Agent', 'support-ticket-system'); ?></h1>
           
            <?php
            // Display admin notices
            if (isset($_GET['message'])) {
                $message_type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : 'success';
                $message = sanitize_text_field($_GET['message']);
                echo '<div class="notice notice-' . esc_attr($message_type) . ' is-dismissible"><p>' . esc_html($message) . '</p></div>';
            }
            ?>
           
            <div class="card">
                <h2><?php _e('Assign Existing User as Support Agent', 'support-ticket-system'); ?></h2>
                <form method="post" action="">
                    <?php wp_nonce_field('assign_support_agent'); ?>
                    <table class="form-table">
                        <tr>
                            <th scope="row"><label for="agent_user"><?php _e('User', 'support-ticket-system'); ?> *</label></th>
                            <td>
                                <select name="agent_user" id="agent_user" required class="regular-text">
                                    <option value=""><?php _e('Select a user', 'support-ticket-system'); ?></option>
                                    <?php
                                    $users = get_users(array(
                                        'role__in' => array('administrator', 'editor'),
                                        'fields' => array('ID', 'display_name', 'user_email')
                                    ));
                                   
                                    foreach ($users as $user) {
                                        // Skip if already a support agent
                                        if (get_user_meta($user->ID, 'is_explicit_support_agent', true)) {
                                            continue;
                                        }
                                        echo '<option value="' . $user->ID . '">' . esc_html($user->display_name) . ' (' . esc_html($user->user_email) . ')</option>';
                                    }
                                    ?>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <?php submit_button(__('Assign as Support Agent', 'support-ticket-system'), 'primary', 'assign_agent'); ?>
                </form>
            </div>
        </div>
        <?php
    }

    public function remove_support_agents_page() {
        // Check capabilities
        if (!current_user_can('manage_options')) {
            wp_die(__('You do not have sufficient permissions to access this page.', 'support-ticket-system'));
        }

        // Only get users who have been explicitly added as support agents
        $users = get_users(array(
            'meta_key' => 'is_explicit_support_agent',
            'meta_value' => true,
            'fields' => array('ID', 'display_name', 'user_email')
        ));

        $agents = array();
        foreach ($users as $user) {
            // Get the user object with roles
            $user_with_roles = get_userdata($user->ID);
           
            // Safely check if roles exist and are arrays
            if ($user_with_roles && isset($user_with_roles->roles) && is_array($user_with_roles->roles)) {
                $user_roles = $user_with_roles->roles;
                if (in_array('support_agent', $user_roles)) {
                    // Add roles to the user object for display
                    $user->roles = $user_roles;
                    $agents[] = $user;
                }
            }
        }
        ?>
        <div class="wrap support-agents-wrap">
            <h1><?php _e('Remove Support Agents', 'support-ticket-system'); ?></h1>
           
            <div class="support-agent-notice support-agent-notice-success">
                <p><?php _e('Note: Removing agents here will only remove them from the support ticket system. Their WordPress user accounts will remain active.', 'support-ticket-system'); ?></p>
            </div>
           
            <?php
            // Display admin notices
            if (isset($_GET['message'])) {
                $message_type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : 'success';
                $message = sanitize_text_field($_GET['message']);
                echo '<div class="notice notice-' . esc_attr($message_type) . ' is-dismissible"><p>' . esc_html($message) . '</p></div>';
            }
            ?>
           
            <div class="card">
                <h2><?php _e('Support Agents to Remove', 'support-ticket-system'); ?></h2>
               
                <?php if (empty($agents)): ?>
                    <p><?php _e('No support agents found.', 'support-ticket-system'); ?></p>
                <?php else: ?>
                    <form method="post" action="<?php echo admin_url('admin-post.php'); ?>">
                        <input type="hidden" name="action" value="remove_support_agent">
                        <?php wp_nonce_field('remove_support_agent_action'); ?>
                        
                        <div class="support-agent-bulk-actions">
                            <input type="checkbox" id="support-select-all-agents">
                            <label for="support-select-all-agents"><?php _e('Select All', 'support-ticket-system'); ?></label>
                           
                            <select id="support-bulk-action-remove" name="bulk_action">
                                <option value="remove_role"><?php _e('Remove support agent role', 'support-ticket-system'); ?></option>
                            </select>
                           
                            <button type="submit" id="support-apply-bulk-remove" class="button">
                                <?php _e('Apply', 'support-ticket-system'); ?>
                            </button>
                        </div>
                       
                        <table class="wp-list-table widefat fixed striped">
                            <thead>
                                <tr>
                                    <th class="check-column"><input type="checkbox" id="cb-select-all-1"></th>
                                    <th><?php _e('Name', 'support-ticket-system'); ?></th>
                                    <th><?php _e('Email', 'support-ticket-system'); ?></th>
                                    <th><?php _e('Assigned Tickets', 'support-ticket-system'); ?></th>
                                    <th><?php _e('Actions', 'support-ticket-system'); ?></th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($agents as $agent):
                                    $assigned_tickets = $this->get_agent_ticket_count($agent->ID);
                                ?>
                                    <tr>
                                        <th class="check-column">
                                            <input type="checkbox" name="agent_ids[]" value="<?php echo $agent->ID; ?>" class="support-agent-checkbox">
                                        </th>
                                        <td><?php echo esc_html($agent->display_name); ?></td>
                                        <td><?php echo esc_html($agent->user_email); ?></td>
                                        <td><?php echo $assigned_tickets; ?></td>
                                        <td class="support-agent-actions">
                                            <a href="<?php echo admin_url('edit.php?post_type=support_ticket&assigned_agent=' . $agent->ID); ?>" class="button">
                                                <?php _e('View Tickets', 'support-ticket-system'); ?>
                                            </a>
                                            <a href="<?php echo admin_url('user-edit.php?user_id=' . $agent->ID); ?>" class="button">
                                                <?php _e('Edit User', 'support-ticket-system'); ?>
                                            </a>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </form>
                <?php endif; ?>
            </div>
        </div>
        <?php
    }

    // Handler for removing support agents
    public function handle_remove_support_agent() {
        // Check capabilities
        if (!current_user_can('manage_options')) {
            wp_die(__('You do not have sufficient permissions to perform this action.', 'support-ticket-system'));
        }

        // Verify nonce
        if (!isset($_POST['_wpnonce']) || !wp_verify_nonce($_POST['_wpnonce'], 'remove_support_agent_action')) {
            wp_die(__('Security check failed.', 'support-ticket-system'));
        }

        // Get selected agent IDs
        $agent_ids = isset($_POST['agent_ids']) ? array_map('intval', $_POST['agent_ids']) : array();
        $bulk_action = isset($_POST['bulk_action']) ? sanitize_text_field($_POST['bulk_action']) : 'remove_role';

        if (empty($agent_ids)) {
            $redirect_url = add_query_arg(
                array(
                    'page' => 'remove-support-agents',
                    'message' => urlencode(__('No agents selected.', 'support-ticket-system')),
                    'type' => 'error'
                ),
                admin_url('edit.php?post_type=support_ticket')
            );
            wp_redirect($redirect_url);
            exit;
        }

        $removed_count = 0;

        foreach ($agent_ids as $agent_id) {
            $user = get_userdata($agent_id);
            if (!$user) {
                continue;
            }

            if ($bulk_action === 'remove_role') {
                // Remove support_agent role if user has it
                if (in_array('support_agent', $user->roles)) {
                    $user->remove_role('support_agent');
                }
                // Remove the custom meta field
                delete_user_meta($agent_id, 'is_explicit_support_agent');
                $removed_count++;
            }
        }

        // Redirect with success message
        $redirect_url = add_query_arg(
            array(
                'page' => 'remove-support-agents',
                'message' => urlencode(sprintf(__('%d agents have been processed successfully.', 'support-ticket-system'), $removed_count)),
                'type' => 'success'
            ),
            admin_url('edit.php?post_type=support_ticket')
        );
        wp_redirect($redirect_url);
        exit;
    }

    private function create_support_agent() {
        if (!current_user_can('create_users')) {
            wp_die(__('You do not have permission to create users.', 'support-ticket-system'));
        }

        // Sanitize and validate input
        $username = isset($_POST['agent_username']) ? sanitize_user($_POST['agent_username']) : '';
        $email = isset($_POST['agent_email']) ? sanitize_email($_POST['agent_email']) : '';
        $password = isset($_POST['agent_password']) ? $_POST['agent_password'] : '';
        $first_name = isset($_POST['agent_first_name']) ? sanitize_text_field($_POST['agent_first_name']) : '';
        $last_name = isset($_POST['agent_last_name']) ? sanitize_text_field($_POST['agent_last_name']) : '';

        // Validate required fields
        if (empty($username) || empty($email) || empty($password)) {
            wp_redirect(admin_url('edit.php?post_type=support_ticket&page=add-support-agent&message=' . urlencode(__('All required fields must be filled.', 'support-ticket-system')) . '&type=error'));
            exit;
        }

        // Check if username already exists
        if (username_exists($username)) {
            wp_redirect(admin_url('edit.php?post_type=support_ticket&page=add-support-agent&message=' . urlencode(__('Username already exists.', 'support-ticket-system')) . '&type=error'));
            exit;
        }

        // Check if email already exists
        if (email_exists($email)) {
            wp_redirect(admin_url('edit.php?post_type=support_ticket&page=add-support-agent&message=' . urlencode(__('Email already exists.', 'support-ticket-system')) . '&type=error'));
            exit;
        }

        // Create the user
        $user_id = wp_create_user($username, $password, $email);

        if (is_wp_error($user_id)) {
            wp_redirect(admin_url('edit.php?post_type=support_ticket&page=add-support-agent&message=' . urlencode($user_id->get_error_message()) . '&type=error'));
            exit;
        }

        // Update user details
        $update_data = array(
            'ID' => $user_id,
            'role' => 'support_agent'
        );

        if (!empty($first_name)) {
            $update_data['first_name'] = $first_name;
        }

        if (!empty($last_name)) {
            $update_data['last_name'] = $last_name;
        }

        if (!empty($first_name) && !empty($last_name)) {
            $update_data['display_name'] = $first_name . ' ' . $last_name;
        }

        wp_update_user($update_data);
       
        // Add custom meta to track that this user was explicitly added as a support agent
        update_user_meta($user_id, 'is_explicit_support_agent', true);

        wp_redirect(admin_url('edit.php?post_type=support_ticket&page=add-support-agent&message=' . urlencode(__('Support agent created successfully!', 'support-ticket-system')) . '&type=success'));
        exit;
    }

    private function assign_support_agent() {
        if (!current_user_can('promote_users')) {
            wp_die(__('You do not have permission to assign users.', 'support-ticket-system'));
        }

        // Sanitize and validate input
        $user_id = isset($_POST['agent_user']) ? intval($_POST['agent_user']) : 0;

        // Validate required fields
        if (empty($user_id)) {
            wp_redirect(admin_url('edit.php?post_type=support_ticket&page=assign-support-agent&message=' . urlencode(__('Please select a user.', 'support-ticket-system')) . '&type=error'));
            exit;
        }

        // Get the user
        $user = get_userdata($user_id);
        if (!$user) {
            wp_redirect(admin_url('edit.php?post_type=support_ticket&page=assign-support-agent&message=' . urlencode(__('User not found.', 'support-ticket-system')) . '&type=error'));
            exit;
        }

        // Check if already a support agent
        if (get_user_meta($user_id, 'is_explicit_support_agent', true)) {
            wp_redirect(admin_url('edit.php?post_type=support_ticket&page=assign-support-agent&message=' . urlencode(__('User is already a support agent.', 'support-ticket-system')) . '&type=error'));
            exit;
        }

        // Add support_agent role
        $user->add_role('support_agent');
       
        // Add custom meta to track that this user was explicitly added as a support agent
        update_user_meta($user_id, 'is_explicit_support_agent', true);

        wp_redirect(admin_url('edit.php?post_type=support_ticket&page=assign-support-agent&message=' . urlencode(__('User assigned as support agent successfully!', 'support-ticket-system')) . '&type=success'));
        exit;
    }

    // AJAX handler for adding agents
    public function ajax_add_agent() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!current_user_can('create_users')) {
            wp_send_json_error(array('message' => __('You do not have permission to create users.', 'support-ticket-system')));
        }
       
        // Sanitize and validate input
        $username = isset($_POST['agent_username']) ? sanitize_user($_POST['agent_username']) : '';
        $email = isset($_POST['agent_email']) ? sanitize_email($_POST['agent_email']) : '';
        $password = isset($_POST['agent_password']) ? $_POST['agent_password'] : '';
        $first_name = isset($_POST['agent_first_name']) ? sanitize_text_field($_POST['agent_first_name']) : '';
        $last_name = isset($_POST['agent_last_name']) ? sanitize_text_field($_POST['agent_last_name']) : '';

        // Validate required fields
        if (empty($username) || empty($email) || empty($password)) {
            wp_send_json_error(array('message' => __('All required fields must be filled.', 'support-ticket-system')));
        }

        // Check if username already exists
        if (username_exists($username)) {
            wp_send_json_error(array('message' => __('Username already exists.', 'support-ticket-system')));
        }

        // Check if email already exists
        if (email_exists($email)) {
            wp_send_json_error(array('message' => __('Email already exists.', 'support-ticket-system')));
        }

        // Create the user
        $user_id = wp_create_user($username, $password, $email);

        if (is_wp_error($user_id)) {
            wp_send_json_error(array('message' => $user_id->get_error_message()));
        }

        // Update user details
        $update_data = array(
            'ID' => $user_id,
            'role' => 'support_agent'
        );

        if (!empty($first_name)) {
            $update_data['first_name'] = $first_name;
        }

        if (!empty($last_name)) {
            $update_data['last_name'] = $last_name;
        }

        if (!empty($first_name) && !empty($last_name)) {
            $update_data['display_name'] = $first_name . ' ' . $last_name;
        }

        wp_update_user($update_data);
       
        // Add custom meta to track that this user was explicitly added as a support agent
        update_user_meta($user_id, 'is_explicit_support_agent', true);

        wp_send_json_success(array('message' => __('Support agent created successfully!', 'support-ticket-system')));
    }

    // AJAX handler for removing agents - FIXED VERSION
    public function ajax_remove_agents() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!current_user_can('manage_options')) {
            wp_send_json_error(array('message' => __('You do not have sufficient permissions to perform this action.', 'support-ticket-system')));
        }
       
        $agent_ids = isset($_POST['agent_ids']) ? array_map('intval', $_POST['agent_ids']) : array();
        $action = isset($_POST['action_type']) ? sanitize_text_field($_POST['action_type']) : 'remove_role';
       
        if (empty($agent_ids)) {
            wp_send_json_error(array('message' => __('No agents selected.', 'support-ticket-system')));
        }
       
        $removed_count = 0;
       
        foreach ($agent_ids as $agent_id) {
            $user = get_userdata($agent_id);
            if (!$user) {
                continue;
            }
           
            if ($action === 'remove_role') {
                // Remove support_agent role if user has it
                if (in_array('support_agent', $user->roles)) {
                    $user->remove_role('support_agent');
                }
                // Remove the custom meta field
                delete_user_meta($agent_id, 'is_explicit_support_agent');
                $removed_count++;
            }
        }
       
        wp_send_json_success(array(
            'message' => sprintf(__('%d agents have been processed successfully.', 'support-ticket-system'), $removed_count)
        ));
    }

    private function get_agent_ticket_count($agent_id) {
        $tickets = get_posts(array(
            'post_type' => 'support_ticket',
            'meta_query' => array(
                array(
                    'key' => 'assigned_agent',
                    'value' => $agent_id,
                    'compare' => '='
                )
            ),
            'posts_per_page' => -1,
            'fields' => 'ids'
        ));
       
        return count($tickets);
    }

    public function handle_agent_management() {
        if (!current_user_can('manage_options')) {
            return;
        }
       
        // Handle agent assignment from admin
        if (isset($_POST['assign_agent_nonce']) && wp_verify_nonce($_POST['assign_agent_nonce'], 'assign_agent')) {
            $ticket_id = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
            $agent_id = isset($_POST['agent_id']) ? intval($_POST['agent_id']) : 0;
           
            if ($ticket_id && $agent_id) {
                update_post_meta($ticket_id, 'assigned_agent', $agent_id);
                update_post_meta($ticket_id, 'last_update', current_time('mysql'));
               
                wp_redirect(admin_url('edit.php?post_type=support_ticket&page=support-agents&message=' . urlencode(__('Agent assigned successfully!', 'support-ticket-system')) . '&type=success'));
                exit;
            }
        }
    }

    // Create necessary pages on activation
    public function create_support_pages() {
        $pages = array(
            'submit-ticket' => array(
                'title' => 'Create a Ticket',
                'content' => '[support_ticket_form]',
                'parent' => 0
            ),
            'my-tickets' => array(
                'title' => 'My Tickets',
                'content' => '[support_ticket_dashboard]',
                'parent' => 0
            ),
            'ticket-view' => array(
                'title' => 'View Ticket',
                'content' => '[support_ticket_view]',
                'parent' => 0
            ),
            'agent-dashboard' => array(
                'title' => 'Agent Dashboard',
                'content' => '[support_agent_dashboard]',
                'parent' => 0
            )
        );

        foreach ($pages as $slug => $page) {
            $existing_page = get_page_by_path($slug);
            if (!$existing_page) {
                $page_id = wp_insert_post(array(
                    'post_title' => $page['title'],
                    'post_name' => $slug,
                    'post_content' => $page['content'],
                    'post_status' => 'publish',
                    'post_type' => 'page',
                    'post_parent' => $page['parent']
                ));

                if ($page_id && !is_wp_error($page_id)) {
                    error_log("Support Ticket System: Created page - {$page['title']} (ID: $page_id)");
                }
            } else {
                // Update existing page content
                wp_update_post(array(
                    'ID' => $existing_page->ID,
                    'post_content' => $page['content']
                ));
                error_log("Support Ticket System: Updated page - {$page['title']}");
            }
        }

        flush_rewrite_rules();
    }

    // Add My Tickets endpoint
    public function add_my_tickets_endpoint() {
        add_rewrite_endpoint('my-tickets', EP_ROOT | EP_PAGES);
        flush_rewrite_rules();
    }
   
    public function activate() {
        $this->register_post_type();
        $this->register_taxonomies();
        $this->add_roles();
        $this->create_support_pages();
        flush_rewrite_rules();
       
        // Create upload directory
        $upload_dir = wp_upload_dir();
        $support_ticket_dir = $upload_dir['basedir'] . '/support-tickets';
        if (!file_exists($support_ticket_dir)) {
            wp_mkdir_p($support_ticket_dir);
        }
       
        // Make sure directory is writable
        chmod($support_ticket_dir, 0755);
       
        // Add .htaccess for security
        $htaccess_content = "Order deny,allow\nDeny from all\n<Files ~ \"\\.(jpg|jpeg|png|pdf|txt|mp4|mov|avi|webm)$\">\nOrder allow,deny\nAllow from all\n</Files>";
        @file_put_contents($support_ticket_dir . '/.htaccess', $htaccess_content);
        chmod($support_ticket_dir . '/.htaccess', 0644);
    }
   
    public function deactivate() {
        flush_rewrite_rules();
    }
   
    private function register_post_type() {
        // Register support ticket post type
        $ticket_args = array(
            'labels' => array(
                'name' => __('Support Tickets', 'support-ticket-system'),
                'singular_name' => __('Support Ticket', 'support-ticket-system'),
                'menu_name' => __('Support Tickets', 'support-ticket-system'),
                'all_items' => __('All Tickets', 'support-ticket-system'),
                'add_new' => __('Add New', 'support-ticket-system'),
                'add_new_item' => __('Add New Ticket', 'support-ticket-system'),
                'edit_item' => __('Edit Ticket', 'support-ticket-system'),
                'new_item' => __('New Ticket', 'support-ticket-system'),
                'view_item' => __('View Ticket', 'support-ticket-system'),
                'search_items' => __('Search Tickets', 'support-ticket-system'),
                'not_found' => __('No tickets found', 'support-ticket-system'),
                'not_found_in_trash' => __('No tickets found in Trash', 'support-ticket-system'),
            ),
            'public' => false,
            'show_ui' => true,
            'show_in_menu' => true,
            'query_var' => false,
            'rewrite' => false,
            'capability_type' => 'post',
            'capabilities' => array(
                'create_posts' => false,
            ),
            'map_meta_cap' => true,
            'hierarchical' => false,
            'menu_position' => 25,
            'menu_icon' => 'dashicons-sos',
            'supports' => array('title', 'editor', 'author'),
            'show_in_rest' => false,
        );
       
        register_post_type('support_ticket', $ticket_args);
       
        // Register support reply post type
        $reply_args = array(
            'labels' => array(
                'name' => __('Support Replies', 'support-ticket-system'),
                'singular_name' => __('Support Reply', 'support-ticket-system'),
            ),
            'public' => false,
            'show_ui' => false,
            'query_var' => false,
            'rewrite' => false,
            'capability_type' => 'post',
            'hierarchical' => false,
            'supports' => array('editor', 'author'),
            'show_in_rest' => false,
        );
       
        register_post_type('support_ticket_reply', $reply_args);
    }
   
    private function register_taxonomies() {
        // Status taxonomy
        register_taxonomy('ticket_status', 'support_ticket', array(
            'labels' => array(
                'name' => __('Statuses', 'support-ticket-system'),
                'singular_name' => __('Status', 'support-ticket-system'),
            ),
            'hierarchical' => true,
            'show_ui' => true,
            'show_admin_column' => true,
            'query_var' => false,
            'rewrite' => false,
            'public' => false,
        ));
       
        // Priority taxonomy
        register_taxonomy('ticket_priority', 'support_ticket', array(
            'labels' => array(
                'name' => __('Priorities', 'support-ticket-system'),
                'singular_name' => __('Priority', 'support-ticket-system'),
            ),
            'hierarchical' => true,
            'show_ui' => true,
            'show_admin_column' => true,
            'query_var' => false,
            'rewrite' => false,
            'public' => false,
        ));
       
        // Create default terms
        $this->create_default_terms();
    }
   
    private function create_default_terms() {
        $status_terms = array(
            'open' => __('Open', 'support-ticket-system'),
            'pending' => __('Pending', 'support-ticket-system'),
            'closed' => __('Closed', 'support-ticket-system')
        );
       
        foreach ($status_terms as $slug => $name) {
            if (!term_exists($slug, 'ticket_status')) {
                wp_insert_term($name, 'ticket_status', array('slug' => $slug));
            }
        }
       
        $priority_terms = array(
            'low' => __('Low', 'support-ticket-system'),
            'medium' => __('Medium', 'support-ticket-system'),
            'high' => __('High', 'support-ticket-system'),
            'urgent' => __('Urgent', 'support-ticket-system')
        );
       
        foreach ($priority_terms as $slug => $name) {
            if (!term_exists($slug, 'ticket_priority')) {
                wp_insert_term($name, 'ticket_priority', array('slug' => $slug));
            }
        }
    }
   
    private function add_roles() {
        // Add Support Agent role
        if (!get_role('support_agent')) {
            add_role('support_agent', __('Support Agent', 'support-ticket-system'), array(
                'read' => true,
                'read_support_tickets' => true,
                'edit_support_tickets' => true,
                'edit_others_support_tickets' => true,
                'edit_published_support_tickets' => true,
                'delete_support_tickets' => false,
            ));
        }
       
        // Add capabilities to existing roles
        $roles_to_modify = array('administrator', 'editor', 'support_agent');
       
        foreach ($roles_to_modify as $role_name) {
            $role = get_role($role_name);
            if ($role) {
                $role->add_cap('read_support_ticket');
                $role->add_cap('read_support_tickets');
                $role->add_cap('edit_support_ticket');
                $role->add_cap('edit_support_tickets');
                $role->add_cap('edit_others_support_tickets');
                $role->add_cap('edit_published_support_tickets');
               
                if ($role_name === 'administrator') {
                    $role->add_cap('delete_support_tickets');
                    $role->add_cap('delete_support_ticket');
                    $role->add_cap('delete_others_support_tickets');
                    $role->add_cap('delete_published_support_tickets');
                }
            }
        }
    }

    // Add My Tickets menu to WooCommerce account
    public function add_my_tickets_menu_item($items) {
        $new_items = array();
       
        foreach ($items as $key => $value) {
            $new_items[$key] = $value;
            if ($key === 'orders') {
                $new_items['my-tickets'] = __('My Tickets', 'support-ticket-system');
            }
        }
       
        return $new_items;
    }

    public function my_tickets_content() {
        echo do_shortcode('[support_ticket_dashboard]');
    }
   
    public function enqueue_scripts() {
        global $post;

        $is_wc_account_page = function_exists('is_account_page') && is_account_page();
        $is_wc_checkout = function_exists('is_checkout') && is_checkout();
        $is_wc_thankyou = function_exists('is_order_received_page') && is_order_received_page();
        $has_shortcode = is_a($post, 'WP_Post') && (
            has_shortcode($post->post_content, 'support_ticket_form') ||
            has_shortcode($post->post_content, 'support_ticket_dashboard') ||
            has_shortcode($post->post_content, 'support_ticket_view') ||
            has_shortcode($post->post_content, 'support_agent_dashboard')
        );

        // Also load on any WooCommerce page as a fallback
        $is_woocommerce = function_exists('is_woocommerce') && is_woocommerce();

        if ($has_shortcode || $is_wc_account_page || $is_wc_checkout || $is_wc_thankyou || $is_woocommerce) {
            wp_enqueue_script('jquery');

            // Enqueue CSS as inline style
            wp_register_style('support-ticket-css', false);
            wp_enqueue_style('support-ticket-css');
            wp_add_inline_style('support-ticket-css', $this->get_frontend_css());

            // Enqueue JS
            wp_register_script('support-ticket-js', false, array('jquery'), '1.0', true);
            wp_enqueue_script('support-ticket-js');
            wp_add_inline_script('support-ticket-js', $this->get_frontend_js());

            wp_localize_script('support-ticket-js', 'support_ticket', array(
                'ajax_url' => admin_url('admin-ajax.php'),
                'nonce'    => wp_create_nonce('support_ticket_nonce'),
                'strings'  => array(
                    'loading' => __('Loading...', 'support-ticket-system'),
                    'error' => __('An error occurred. Please try again.', 'support-ticket-system'),
                    'success' => __('Success!', 'support-ticket-system'),
                    'required_field' => __('This field is required.', 'support-ticket-system'),
                    'file_too_big' => __('File is too large. Maximum size is 50MB.', 'support-ticket-system'),
                    'invalid_file_type' => __('Invalid file type. Allowed types: png, jpg, jpeg, pdf, txt, mp4, mov, avi, webm', 'support-ticket-system'),
                )
            ));
        }
    }
   
    private function get_frontend_css() {
        return "
        /* IMPROVED PROFESSIONAL STYLING */
        .support-ticket-system-wrapper { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important; }
        .support-ticket-container { max-width: 1200px; margin: 0 auto; padding: 20px; font-family: inherit; }
        .support-ticket-card { 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            padding: 40px; 
            margin-bottom: 30px; 
            border: 1px solid #e1e8ed; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.3s ease;
        }
        .support-ticket-card:hover {
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .support-ticket-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 4px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .support-ticket-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 35px; 
            padding-bottom: 20px; 
            border-bottom: 2px solid #f0f4f8; 
        }
        .support-ticket-title { 
            font-size: 32px; 
            font-weight: 700; 
            color: #2d3748; 
            margin: 0; 
        }
        .support-ticket-btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            text-decoration: none; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.3s ease; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3); 
            position: relative; 
            overflow: hidden; 
        }
        .support-ticket-btn:hover { 
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); 
            color: white; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); 
            text-decoration: none; 
        }
        .support-ticket-btn:active { 
            transform: translateY(0); 
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); 
        }
        .support-ticket-btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .support-ticket-btn-secondary { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .support-ticket-btn-danger { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
        .support-ticket-btn-block { display: block; width: 100%; text-align: center; }
        .support-ticket-form-group { margin-bottom: 25px; }
        .support-ticket-form-control { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: all 0.3s; 
            box-sizing: border-box; 
            background: #fafbfc;
        }
        .support-ticket-form-control:focus { 
            border-color: #667eea; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
            background: #fff;
        }
        .support-ticket-form-control.error { border-color: #e53e3e; }
        .support-ticket-alert { 
            padding: 16px 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border-left: 4px solid; 
            font-weight: 500;
        }
        .support-ticket-alert-success { background: #f0fff4; border-color: #48bb78; color: #22543d; }
        .support-ticket-alert-error { background: #fff5f5; border-color: #f56565; color: #742a2a; }
        .support-ticket-alert-info { background: #ebf8ff; border-color: #4299e1; color: #2b6cb0; }
        .support-ticket-list { display: grid; gap: 15px; }
        .support-ticket-item { 
            display: grid; 
            grid-template-columns: auto 1fr auto auto auto auto; 
            gap: 15px; 
            align-items: center; 
            padding: 20px; 
            background: #f8fafc; 
            border-radius: 10px; 
            border: 1px solid #e2e8f0; 
            transition: all 0.3s; 
        }
        .support-ticket-item:hover { 
            background: #edf2f7; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }
        .support-ticket-id { font-weight: 700; color: #2d3748; font-size: 14px; }
        .support-ticket-product { color: #4a5568; font-weight: 500; }
        .support-ticket-customer { color: #4a5568; font-size: 14px; }
        .support-ticket-agent { color: #718096; font-size: 14px; }
        .support-ticket-status { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .support-status-open { background: #c6f6d5; color: #22543d; }
        .support-status-pending { background: #fefcbf; color: #744210; }
        .support-status-closed { background: #fed7d7; color: #742a2a; }
        .support-ticket-priority { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .support-priority-low { background: #e6fffa; color: #234e52; }
        .support-priority-medium { background: #fefcbf; color: #744210; }
        .support-priority-high { background: #fed7d7; color: #742a2a; }
        .support-priority-urgent { background: #fed7d7; color: #742a2a; border: 1px solid #e53e3e; }
        .support-ticket-date { color: #718096; font-size: 14px; }
        .support-ticket-message { 
            background: #fff; 
            border-radius: 10px; 
            padding: 25px; 
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
        }
        .support-ticket-message-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #e2e8f0; 
        }
        .support-ticket-message-author { 
            font-weight: 700; 
            color: #2d3748; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .support-ticket-message-agent { 
            background: #667eea; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 600; 
        }
        .support-ticket-message-date { color: #718096; font-size: 14px; }
        .support-ticket-message-content { line-height: 1.7; color: #4a5568; }
        .support-ticket-attachments { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0; }
        .support-ticket-attachment { 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            background: #f7fafc; 
            border: 1px solid #e2e8f0; 
            border-radius: 6px; 
            color: #4a5568; 
            text-decoration: none; 
            margin-right: 10px; 
            margin-bottom: 10px; 
            font-size: 14px; 
            transition: all 0.3s; 
        }
        .support-ticket-attachment:hover { 
            background: #edf2f7; 
            color: #2d3748; 
            text-decoration: none; 
            transform: translateY(-1px);
        }
        .support-ticket-file-upload { margin-top: 10px; }
        .support-ticket-file-list { margin-top: 10px; }
        .support-ticket-file-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 10px 12px; 
            background: #f7fafc; 
            border: 1px solid #e2e8f0; 
            border-radius: 6px; 
            margin-bottom: 8px; 
        }
        .support-ticket-file-name { flex: 1; font-size: 14px; }
        .support-ticket-file-remove { 
            color: #e53e3e; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px; 
            padding: 4px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .support-ticket-file-remove:hover { 
            color: #c53030; 
            background: #fed7d7;
        }
        .support-ticket-loading { 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            border: 2px solid #ffffff; 
            border-radius: 50%; 
            border-top-color: transparent; 
            animation: support-ticket-spin 1s ease-in-out infinite; 
        }
        @keyframes support-ticket-spin { to { transform: rotate(360deg); } }
        .support-ticket-no-tickets { text-align: center; padding: 50px; color: #718096; }
        .support-ticket-assigned-agent { 
            background: #ebf8ff; 
            padding: 18px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border-left: 4px solid #4299e1; 
        }
        .support-ticket-reply-form { 
            background: #f8fafc; 
            padding: 25px; 
            border-radius: 10px; 
            margin-top: 30px; 
            border: 1px solid #e2e8f0; 
        }
        .support-ticket-close-section { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        .support-ticket-submit-title { text-align: center; margin-bottom: 40px; }
        .support-ticket-submit-title h1 { 
            font-size: 36px; 
            font-weight: 700; 
            color: #2d3748; 
            margin: 0; 
        }
        .support-ticket-order-info { 
            background: #f0fff4; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border-left: 4px solid #48bb78; 
        }
        .support-ticket-license-status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .license-status-invalid { background: #fed7d7; color: #742a2a; }
        .license-status-revoked { background: #fed7d7; color: #742a2a; }
        .license-status-duplicate { background: #fefcbf; color: #744210; }
        .license-status-expired { background: #fed7d7; color: #742a2a; }
        .license-status-activation_limit { background: #fed7d7; color: #742a2a; }
        .support-ticket-welcome { margin-right: 15px; font-weight: 600; color: #4a5568; }
        .support-ticket-login-links { text-align: center; margin-top: 20px; }
        .support-ticket-login-links a { color: #667eea; text-decoration: none; font-weight: 500; }
        .support-ticket-login-links a:hover { text-decoration: underline; }

        /* Improved Need Help Section */
        .support-ticket-help-section-email { 
            background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%); 
            border: 2px solid #fbd38d; 
            border-radius: 12px; 
            padding: 30px; 
            margin: 30px 0; 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            font-family: inherit; 
        }
        .support-ticket-help-section-email h3 { 
            color: #744210; 
            margin-bottom: 15px; 
            font-size: 22px; 
            font-weight: 700; 
            margin-top: 0; 
        }
        .support-ticket-help-section-email p { 
            color: #744210; 
            margin-bottom: 20px; 
            font-size: 16px; 
            line-height: 1.6; 
        }
        .support-ticket-btn-report-email { 
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); 
            color: white !important; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            font-size: 14px; 
            text-decoration: none; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 10px rgba(237, 137, 54, 0.3); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            position: relative; 
            overflow: hidden; 
        }
        .support-ticket-btn-report-email:hover { 
            background: linear-gradient(135deg, #dd6b20 0%, #ed8936 100%); 
            color: white !important; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.4); 
            text-decoration: none; 
        }
        .support-ticket-btn-icon { font-size: 18px; }

        /* Enhanced Filters and Search */
        .support-ticket-filters { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            align-items: center;
        }
        .support-ticket-filters select { 
            padding: 10px 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 6px; 
            background: white; 
            font-size: 14px;
            min-width: 150px;
        }
        .support-ticket-quick-actions { display: flex; gap: 5px; justify-content: center; }
        .support-ticket-quick-btn { 
            background: none; 
            border: 1px solid #e2e8f0; 
            border-radius: 4px; 
            padding: 6px 10px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all 0.3s;
        }
        .support-ticket-quick-btn:hover { background: #f7fafc; transform: scale(1.05); }
        .support-ticket-bulk-actions { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            align-items: center; 
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .support-ticket-metrics { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 30px; 
        }
        .support-ticket-metric-card { 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        .support-ticket-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .support-ticket-metric-value { font-size: 2.2em; font-weight: 700; color: #667eea; margin-bottom: 5px; }
        .support-ticket-metric-label { color: #718096; font-size: 0.9em; font-weight: 500; }
        .support-ticket-internal-notes { 
            background: #fffaf0; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            border-left: 4px solid #ed8936; 
        }
        .support-ticket-search { margin-bottom: 20px; }
        .support-ticket-search input { 
            width: 100%; 
            max-width: 400px; 
            padding: 12px 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 6px; 
            font-size: 14px;
        }
        .support-ticket-timeline { margin-top: 30px; }
        .support-ticket-timeline-item { 
            display: flex; 
            margin-bottom: 15px; 
            padding: 18px; 
            background: #f7fafc; 
            border-radius: 8px; 
            border-left: 4px solid #667eea; 
            transition: all 0.3s;
        }
        .support-ticket-timeline-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }
        .support-ticket-timeline-date { font-weight: 600; min-width: 140px; color: #4a5568; font-size: 14px; }
        .support-ticket-timeline-content { flex: 1; }
        .support-ticket-pagination { display: flex; justify-content: center; gap: 10px; margin-top: 30px; }
        .support-ticket-pagination button { 
            padding: 8px 16px; 
            border: 1px solid #e2e8f0; 
            background: white; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .support-ticket-pagination button.active { background: #667eea; color: white; }
        .support-ticket-pagination button:hover:not(.active) { background: #f7fafc; }
        .support-ticket-assignment { 
            margin-bottom: 20px; 
            padding: 18px; 
            background: #f0fff4; 
            border-radius: 8px; 
            border: 1px solid #c6f6d5;
        }
        .support-ticket-checkbox { margin-right: 10px; }

        /* Improved License Key Fields */
        .support-license-key-group { 
            margin-bottom: 25px; 
            padding: 20px; 
            background: #f8fafc; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
        }
        .support-license-key-group label { display: block; margin-bottom: 10px; font-weight: 600; color: #2d3748; }
        .support-license-key-description { margin-bottom: 15px; color: #4a5568; font-size: 14px; line-height: 1.5; }
        .support-license-key-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
            align-items: center; 
        }
        .support-license-key-input { flex: 1; }
        .support-license-key-remove { 
            color: #e53e3e; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 18px; 
            background: none; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 4px; 
            transition: background-color 0.3s; 
        }
        .support-license-key-remove:hover { background: #fed7d7; color: #c53030; }
        .support-license-key-add { 
            background: #48bb78; 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
        }
        .support-license-key-add:hover { background: #38a169; transform: translateY(-1px); }

        /* Responsive design */
        @media (max-width: 768px) {
            .support-ticket-card { padding: 25px 20px; }
            .support-ticket-header { flex-direction: column; gap: 20px; text-align: center; }
            .support-ticket-item { grid-template-columns: 1fr; text-align: center; gap: 10px; }
            .support-ticket-message-header { flex-direction: column; gap: 10px; text-align: center; }
            .support-ticket-help-section-email { padding: 20px; }
            .support-ticket-help-section-email h3 { font-size: 20px; }
            .support-ticket-filters { flex-direction: column; align-items: stretch; }
            .support-ticket-metrics { grid-template-columns: 1fr; }
            .support-license-key-row { flex-direction: column; }
            .support-ticket-bulk-actions { flex-direction: column; align-items: stretch; }
            .support-ticket-timeline-item { flex-direction: column; gap: 10px; }
            .support-ticket-timeline-date { min-width: auto; }
        }

        /* Better spacing for ticket timeline */
        .support-ticket-timeline-item { margin-bottom: 15px; padding: 20px; }
        .support-ticket-timeline-date { padding-right: 20px; }
        .support-ticket-timeline-content { padding-left: 20px; border-left: 2px solid #e2e8f0; }

        /* Better spacing for user info */
        .support-ticket-message-header { margin-bottom: 20px; padding-bottom: 20px; }
        .support-ticket-message-author { font-size: 16px; }
        .support-ticket-message-date { font-size: 14px; }

        /* Improved form styling for Create Ticket page */
        .support-ticket-form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .support-ticket-form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }
        .support-ticket-form-section h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .support-ticket-form-note {
            background: #ebf8ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #4299e1;
            font-size: 14px;
            color: #2b6cb0;
        }
        ";
    }
   
    private function get_frontend_js() {
        ob_start(); ?>
        <script>
        jQuery(document).ready(function($) {
            // OPTIMIZED Ticket form submission - FASTER LOADING
            $('#support-ticket-form').on('submit', function(e) {
                e.preventDefault();
               
                var form = $(this);
                var submitBtn = form.find('button[type="submit"]');
                var originalText = submitBtn.html();
                var formData = new FormData(form[0]);
               
                console.log('Support Ticket: Form submission started');
               
                // Quick validation
                var isValid = true;
                var missingFields = [];
                form.find('.required').each(function() {
                    if (!$(this).val()) {
                        isValid = false;
                        $(this).addClass('error');
                        missingFields.push($(this).attr('name'));
                    } else {
                        $(this).removeClass('error');
                    }
                });
               
                if (!isValid) {
                    $('#support-ticket-form-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.required_field + ' Missing: ' + missingFields.join(', ') + '</div>');
                    return;
                }
               
                // Quick file validation
                var fileInputs = form.find('input[type="file"]');
                var validFiles = true;
               
                fileInputs.each(function() {
                    var files = this.files;
                    if (files.length > 0) {
                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                           
                            if (file.size > 50 * 1024 * 1024) {
                                validFiles = false;
                                $('#support-ticket-form-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.file_too_big + '</div>');
                                return false;
                            }
                           
                            var allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf', 'text/plain', 'video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm'];
                            if (allowedTypes.indexOf(file.type) === -1) {
                                validFiles = false;
                                $('#support-ticket-form-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.invalid_file_type + '</div>');
                                return false;
                            }
                        }
                    }
                });
               
                if (!validFiles) {
                    return;
                }
               
                formData.append('action', 'support_submit_ticket');
                formData.append('nonce', support_ticket.nonce);
               
                console.log('Support Ticket: Sending AJAX request');
                submitBtn.prop('disabled', true).html('<span class="support-ticket-loading"></span> ' + support_ticket.strings.loading);
               
                // Optimized AJAX with shorter timeout
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    timeout: 15000, // Reduced to 15 seconds
                    success: function(response) {
                        console.log('Support Ticket: AJAX response received', response);
                        if (response.success) {
                            $('#support-ticket-form-message').html('<div class="support-ticket-alert support-ticket-alert-success">' + response.data.message + '</div>');
                            form[0].reset();
                            $('.support-ticket-file-list').empty();
                            if (response.data.redirect_url) {
                                setTimeout(function() {
                                    window.location.href = response.data.redirect_url;
                                }, 1000); // Reduced to 1 second
                            }
                        } else {
                            console.error('Support Ticket: AJAX error response', response);
                            $('#support-ticket-form-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + response.data.message + '</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Support Ticket: AJAX request failed:', error);
                        $('#support-ticket-form-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.error + '</div>');
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });
           
            // OPTIMIZED Reply form submission
            $('#support-ticket-reply-form').on('submit', function(e) {
                e.preventDefault();
               
                var form = $(this);
                var submitBtn = form.find('button[type="submit"]');
                var originalText = submitBtn.html();
                var formData = new FormData(form[0]);
               
                // Quick validation
                if (!$('#support-reply-content').val()) {
                    $('#support-ticket-reply-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.required_field + '</div>');
                    return;
                }
               
                // Quick file validation
                var fileInputs = form.find('input[type="file"]');
                var validFiles = true;
               
                fileInputs.each(function() {
                    var files = this.files;
                    for (var i = 0; i < files.length; i++) {
                        var file = files[i];
                       
                        if (file.size > 50 * 1024 * 1024) {
                            validFiles = false;
                            $('#support-ticket-reply-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.file_too_big + '</div>');
                            return false;
                        }
                       
                        var allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf', 'text/plain', 'video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm'];
                        if (allowedTypes.indexOf(file.type) === -1) {
                            validFiles = false;
                            $('#support-ticket-reply-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.invalid_file_type + '</div>');
                            return false;
                        }
                    }
                });
               
                if (!validFiles) {
                    return;
                }
               
                formData.append('action', 'support_submit_reply');
                formData.append('nonce', support_ticket.nonce);
               
                submitBtn.prop('disabled', true).html('<span class="support-ticket-loading"></span> ' + support_ticket.strings.loading);
               
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    timeout: 15000,
                    success: function(response) {
                        if (response.success) {
                            $('#support-ticket-reply-message').html('<div class="support-ticket-alert support-ticket-alert-success">' + response.data.message + '</div>');
                            form[0].reset();
                            $('.support-ticket-file-list').empty();
                            // Faster reload
                            setTimeout(function() {
                                window.location.reload();
                            }, 800);
                        } else {
                            $('#support-ticket-reply-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + response.data.message + '</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        $('#support-ticket-reply-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.error + '</div>');
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });
           
            // Close ticket - OPTIMIZED
            $('.support-ticket-close-btn').on('click', function(e) {
                e.preventDefault();
               
                var ticketId = $(this).data('ticket-id');
                var button = $(this);
                var originalText = button.html();
               
                if (!confirm('Are you sure you want to close this ticket?')) {
                    return;
                }
               
                button.prop('disabled', true).html('<span class="support-ticket-loading"></span> Closing...');
               
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: {
                        action: 'support_close_ticket',
                        ticket_id: ticketId,
                        nonce: support_ticket.nonce
                    },
                    timeout: 10000,
                    success: function(response) {
                        if (response.success) {
                            $('#support-ticket-close-message').html('<div class="support-ticket-alert support-ticket-alert-success">' + response.data.message + '</div>');
                            setTimeout(function() {
                                window.location.reload();
                            }, 800);
                        } else {
                            $('#support-ticket-close-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + response.data.message + '</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        $('#support-ticket-close-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.error + '</div>');
                    },
                    complete: function() {
                        button.prop('disabled', false).html(originalText);
                    }
                });
            });

            // Agent login form submission - OPTIMIZED
            $('#support-agent-login-form').on('submit', function(e) {
                e.preventDefault();
               
                var form = $(this);
                var submitBtn = form.find('button[type="submit"]');
                var originalText = submitBtn.html();
               
                submitBtn.prop('disabled', true).html('<span class="support-ticket-loading"></span> ' + support_ticket.strings.loading);
               
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: {
                        action: 'support_agent_login',
                        log: $('#agent-username').val(),
                        pwd: $('#agent-password').val(),
                        rememberme: $('input[name="rememberme"]').is(':checked') ? 'forever' : '',
                        nonce: support_ticket.nonce
                    },
                    timeout: 10000,
                    success: function(response) {
                        if (response.success) {
                            $('#support-agent-login-message').html('<div class="support-ticket-alert support-ticket-alert-success">' + response.data.message + '</div>');
                            setTimeout(function() {
                                window.location.href = response.data.redirect;
                            }, 800);
                        } else {
                            $('#support-agent-login-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + response.data.message + '</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        $('#support-agent-login-message').html('<div class="support-ticket-alert support-ticket-alert-error">' + support_ticket.strings.error + '</div>');
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // Show license key selection when issue category is license issue
            $('#support-issue-category').on('change', function() {
                var category = $(this).val();
                var licenseSection = $('.support-ticket-license-section');
                var licenseStatusSection = $('.support-ticket-license-status-section');
               
                if (category === 'license_issue') {
                    licenseSection.show();
                    licenseStatusSection.show();
                    $('#support-license-status').prop('required', true);
                } else {
                    licenseSection.hide();
                    licenseStatusSection.hide();
                    $('#support-license-status').prop('required', false);
                }
            });

            // Update product dropdown when order changes
            $('#support-order-id').on('change', function() {
                var orderId = $(this).val();
                var productSelect = $('#support-product-name');
               
                if (!orderId) {
                    productSelect.html('<option value=""><?php _e('Select a product', 'support-ticket-system'); ?></option>');
                    return;
                }
               
                // Load products for this order
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: {
                        action: 'support_get_order_products',
                        order_id: orderId,
                        nonce: support_ticket.nonce
                    },
                    timeout: 8000,
                    success: function(response) {
                        if (response.success && response.data.products) {
                            productSelect.empty();
                            productSelect.append('<option value=""><?php _e('Select a product', 'support-ticket-system'); ?></option>');
                           
                            $.each(response.data.products, function(index, product) {
                                productSelect.append('<option value="' + product.name + '">' + product.name + '</option>');
                            });
                        }
                    }
                });
            });
           
            // Ticket filtering
            $('#support-status-filter, #support-priority-filter').on('change', function() {
                var status = $('#support-status-filter').val();
                var priority = $('#support-priority-filter').val();
               
                $('.support-ticket-item').each(function() {
                    var itemStatus = $(this).find('.support-ticket-status').text().toLowerCase();
                    var itemPriority = $(this).find('.support-ticket-priority').text().toLowerCase();
                   
                    var showItem = true;
                   
                    if (status && itemStatus !== status) {
                        showItem = false;
                    }
                   
                    if (priority && itemPriority !== priority) {
                        showItem = false;
                    }
                   
                    $(this).toggle(showItem);
                });
            });

            // Quick actions
            $('.support-ticket-quick-btn').on('click', function() {
                var action = $(this).data('action');
                var ticketId = $(this).data('ticket');
               
                switch(action) {
                    case 'view':
                        window.location.href = $('.support-ticket-item[data-ticket="' + ticketId + '"] .support-ticket-btn').attr('href');
                        break;
                    case 'close':
                        if (confirm('Are you sure you want to close this ticket?')) {
                            $.ajax({
                                url: support_ticket.ajax_url,
                                type: 'POST',
                                data: {
                                    action: 'support_close_ticket',
                                    ticket_id: ticketId,
                                    nonce: support_ticket.nonce
                                },
                                timeout: 8000,
                                success: function(response) {
                                    if (response.success) {
                                        location.reload();
                                    }
                                }
                            });
                        }
                        break;
                }
            });

            // Search functionality
            $('#support-ticket-search').on('input', function() {
                var searchTerm = $(this).val().toLowerCase();
               
                if (searchTerm.length < 2) {
                    $('.support-ticket-item').show();
                    return;
                }
               
                $('.support-ticket-item').each(function() {
                    var ticketText = $(this).text().toLowerCase();
                    $(this).toggle(ticketText.indexOf(searchTerm) > -1);
                });
            });

            // Bulk actions
            $('#support-apply-bulk').on('click', function() {
                var action = $('#support-bulk-action').val();
                var selectedTickets = [];
               
                $('.support-ticket-checkbox:checked').each(function() {
                    selectedTickets.push($(this).val());
                });
               
                if (selectedTickets.length === 0) {
                    alert('Please select tickets to perform bulk action.');
                    return;
                }
               
                if (action === 'close') {
                    if (confirm('Are you sure you want to close ' + selectedTickets.length + ' tickets?')) {
                        $.ajax({
                            url: support_ticket.ajax_url,
                            type: 'POST',
                            data: {
                                action: 'support_bulk_action',
                                tickets: selectedTickets,
                                bulk_action: 'close',
                                nonce: support_ticket.nonce
                            },
                            timeout: 10000,
                            success: function(response) {
                                if (response.success) {
                                    location.reload();
                                }
                            }
                        });
                    }
                }
            });

            // Internal notes
            $('#support-save-notes').on('click', function() {
                var notes = $('#support-internal-notes').val();
                var ticketId = $(this).data('ticket-id');
               
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: {
                        action: 'support_save_internal_notes',
                        ticket_id: ticketId,
                        notes: notes,
                        nonce: support_ticket.nonce
                    },
                    timeout: 8000,
                    success: function(response) {
                        if (response.success) {
                            alert('Notes saved successfully.');
                        }
                    }
                });
            });

            // Agent assignment
            $('#support-assign-agent').on('change', function() {
                var agentId = $(this).val();
                var ticketId = $(this).data('ticket-id');
               
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: {
                        action: 'support_assign_agent',
                        ticket_id: ticketId,
                        agent_id: agentId,
                        nonce: support_ticket.nonce
                    },
                    timeout: 8000
                });
            });

            // Remove agent from ticket - FIXED AND OPTIMIZED
            $(document).on('click', '.support-remove-agent-btn', function(e) {
                e.preventDefault();
               
                var button = $(this);
                var ticketId = button.data('ticket-id');
                var originalText = button.html();
               
                if (!confirm('Are you sure you want to remove the agent from this ticket?')) {
                    return;
                }
               
                button.prop('disabled', true).html('<span class="support-ticket-loading"></span> Removing...');
               
                $.ajax({
                    url: support_ticket.ajax_url,
                    type: 'POST',
                    data: {
                        action: 'support_remove_agent',
                        ticket_id: ticketId,
                        nonce: support_ticket.nonce
                    },
                    timeout: 8000,
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.data.message);
                            button.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        alert('An error occurred. Please try again.');
                        button.prop('disabled', false).html(originalText);
                    }
                });
            });
           
            // File upload handling - UPDATED TO BIND FILE INPUT TO DISPLAY SPAN
            $('.support-ticket-file-input').on('change', function() {
                var input = $(this);
                var fileList = input.closest('.support-ticket-form-group').find('.support-ticket-file-list');
                var maxFiles = 5;
                var currentFiles = fileList.find('.support-ticket-file-item').length;
                var newFiles = this.files.length;
               
                if (currentFiles + newFiles > maxFiles) {
                    alert('You can only upload a maximum of ' + maxFiles + ' files.');
                    input.val('');
                    return;
                }
               
                for (var i = 0; i < this.files.length; i++) {
                    var file = this.files[i];
                    var fileItem = $('<div class="support-ticket-file-item">' +
                        '<span class="support-ticket-file-name">' + file.name + ' (' + (file.size / (1024 * 1024)).toFixed(2) + ' MB)</span>' +
                        '<span class="support-ticket-file-remove">&times;</span>' +
                        '</div>');
                    fileList.append(fileItem);
                }
               
                // Store files in a data attribute for later use
                input.data('files', this.files);
            });
           
            // File removal
            $(document).on('click', '.support-ticket-file-remove', function() {
                $(this).closest('.support-ticket-file-item').remove();
            });

            // License Key Management
            var licenseKeyCounter = 1;

            // Add new license key field
            $('.support-license-key-add').on('click', function() {
                var container = $('.support-license-keys-container');
                var newRow = $('<div class="support-license-key-row">' +
                    '<div class="support-license-key-input">' +
                    '<input type="text" name="license_keys[]" class="support-ticket-form-control" placeholder="<?php _e('Enter license key manually', 'support-ticket-system'); ?>">' +
                    '</div>' +
                    '<button type="button" class="support-license-key-remove">&times;</button>' +
                    '</div>');
                container.append(newRow);
                licenseKeyCounter++;
            });

            // Remove license key field
            $(document).on('click', '.support-license-key-remove', function() {
                if ($('.support-license-key-row').length > 1) {
                    $(this).closest('.support-license-key-row').remove();
                } else {
                    $(this).closest('.support-license-key-row').find('input').val('');
                }
            });
           
            // Auto-fill order ID from URL
            var urlParams = new URLSearchParams(window.location.search);
            var orderId = urlParams.get('order_id');
            var productName = urlParams.get('product');
           
            if (orderId) {
                $('#support-order-id').val(orderId).trigger('change');
               
                if (productName) {
                    setTimeout(function() {
                        $('#support-product-name option').each(function() {
                            if ($(this).text() === decodeURIComponent(productName)) {
                                $(this).prop('selected', true);
                                return false;
                            }
                        });
                    }, 500);
                }
            }
        });
        </script>
        <?php
        return ob_get_clean();
    }

    // Add report button to order details and order complete page
    public function add_report_problem_button($order) {
        if (!$order) {
            return;
        }

        if (is_numeric($order)) {
            $order = wc_get_order(intval($order));
            if (!$order) {
                return;
            }
        }

        $current_user_id = get_current_user_id();
        if ($order->get_user_id() && $order->get_user_id() !== $current_user_id && !current_user_can('manage_options')) {
            return;
        }

        $order_id = $order->get_id();
        $report_url = esc_url(home_url('/submit-ticket/?order_id=' . $order_id));

        echo '<div class="support-ticket-help-section-email">';
        echo '<h3>' . __('Need Help?', 'support-ticket-system') . '</h3>';
        echo '<p>' . __('If you have any issues with your purchase, click the button below to report a problem:', 'support-ticket-system') . '</p>';
        echo '<a href="' . $report_url . '" class="support-ticket-btn-report-email">';
        echo '<span class="support-ticket-btn-icon">🔧</span> ';
        echo esc_html(__('Report a Problem', 'support-ticket-system'));
        echo '</a>';
        echo '</div>';
    }

    // Add report button to email
    public function add_report_button_to_email($order, $sent_to_admin, $plain_text, $email) {
        if ($sent_to_admin) {
            return;
        }

        $order_id = $order->get_id();
        $report_url = home_url('/submit-ticket/?order_id=' . $order_id);
       
        if ($plain_text) {
            echo "\n\n" . __('Need Help?', 'support-ticket-system') . "\n";
            echo __('If you have any issues with your purchase, click the link below to report a problem:', 'support-ticket-system') . "\n";
            echo $report_url . "\n\n";
        } else {
            echo '<div style="background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%); border: 2px solid #fbd38d; border-radius: 12px; padding: 30px; margin: 30px 0; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-family: Arial, sans-serif;">';
            echo '<h3 style="color: #744210; margin-bottom: 15px; font-size: 24px; font-weight: 700; margin-top: 0;">' . __('Need Help?', 'support-ticket-system') . '</h3>';
            echo '<p style="color: #744210; margin-bottom: 20px; font-size: 16px; line-height: 1.6;">' . __('If you have any issues with your purchase, click the button below to report a problem:', 'support-ticket-system') . '</p>';
            echo '<a href="' . esc_url($report_url) . '" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white !important; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(237, 137, 54, 0.4); text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden;">';
            echo '<span style="font-size: 18px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">🔧</span>';
            echo __('Report a Problem', 'support-ticket-system');
            echo '</a>';
            echo '</div>';
        }
    }

    // AJAX handler for closing tickets - OPTIMIZED
    public function ajax_close_ticket() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!is_user_logged_in()) {
            wp_send_json_error(array('message' => __('You must be logged in to close a ticket.', 'support-ticket-system')));
        }
       
        $ticket_id = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
        $ticket = get_post($ticket_id);
       
        if (!$ticket || $ticket->post_type !== 'support_ticket') {
            wp_send_json_error(array('message' => __('Invalid ticket.', 'support-ticket-system')));
        }
       
        // Check if user can close this ticket
        $can_close = false;
        if (current_user_can('administrator') || current_user_can('support_agent') || $ticket->post_author == get_current_user_id()) {
            $can_close = true;
        }
       
        if (!$can_close) {
            wp_send_json_error(array('message' => __('You do not have permission to close this ticket.', 'support-ticket-system')));
        }
       
        // Update ticket status - optimized database calls
        update_post_meta($ticket_id, 'status', 'closed');
        update_post_meta($ticket_id, 'last_update', current_time('mysql'));
        wp_set_object_terms($ticket_id, 'closed', 'ticket_status');
       
        // Send email notification (non-blocking)
        $this->send_ticket_closed_emails($ticket_id);
       
        wp_send_json_success(array(
            'message' => __('Ticket has been closed successfully.', 'support-ticket-system'),
        ));
    }

    // AJAX handler for assigning agents - OPTIMIZED
    public function ajax_assign_agent() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!current_user_can('administrator') && !current_user_can('support_agent')) {
            wp_send_json_error(array('message' => __('You do not have permission to assign agents.', 'support-ticket-system')));
        }
       
        $ticket_id = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
        $agent_id = isset($_POST['agent_id']) ? intval($_POST['agent_id']) : 0;
       
        update_post_meta($ticket_id, 'assigned_agent', $agent_id);
        update_post_meta($ticket_id, 'last_update', current_time('mysql'));
       
        wp_send_json_success(array(
            'message' => __('Agent assigned successfully.', 'support-ticket-system'),
        ));
    }

    // AJAX handler for removing agents from tickets - FIXED AND OPTIMIZED
    public function ajax_remove_agent() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!current_user_can('administrator') && !current_user_can('support_agent')) {
            wp_send_json_error(array('message' => __('You do not have permission to remove agents.', 'support-ticket-system')));
        }
       
        $ticket_id = isset($_POST['ticket_id']) ? intval($_POST['ticket_id']) : 0;
        $ticket = get_post($ticket_id);
       
        if (!$ticket || $ticket->post_type !== 'support_ticket') {
            wp_send_json_error(array('message' => __('Invalid ticket.', 'support-ticket-system')));
        }
       
        // Remove agent from ticket
        update_post_meta($ticket_id, 'assigned_agent', '');
        update_post_meta($ticket_id, 'last_update', current_time('mysql'));
       
        wp_send_json_success(array(
            'message' => __('Agent removed from ticket successfully.', 'support-ticket-system'),
        ));
    }

    // AJAX handler for agent login - OPTIMIZED
    public function ajax_agent_login() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        $username = isset($_POST['log']) ? sanitize_user($_POST['log']) : '';
        $password = isset($_POST['pwd']) ? $_POST['pwd'] : '';
        $remember = isset($_POST['rememberme']) ? true : false;
       
        if (empty($username) || empty($password)) {
            wp_send_json_error(array('message' => __('Please enter both username and password.', 'support-ticket-system')));
        }
       
        $user = wp_authenticate($username, $password);
       
        if (is_wp_error($user)) {
            wp_send_json_error(array('message' => __('Invalid username or password.', 'support-ticket-system')));
        }
       
        // Check if user has agent or admin role
        if (!in_array('support_agent', $user->roles) && !in_array('administrator', $user->roles)) {
            wp_send_json_error(array('message' => __('You do not have permission to access the agent dashboard.', 'support-ticket-system')));
        }
       
        // Log the user in
        wp_set_current_user($user->ID);
        wp_set_auth_cookie($user->ID, $remember);
       
        wp_send_json_success(array(
            'message' => __('Login successful. Redirecting...', 'support-ticket-system'),
            'redirect' => home_url('/agent-dashboard/')
        ));
    }

    // AJAX handler for getting order products - OPTIMIZED
    public function ajax_get_order_products() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!is_user_logged_in()) {
            wp_send_json_error(array('message' => __('You must be logged in.', 'support-ticket-system')));
        }
       
        $order_id = isset($_POST['order_id']) ? intval($_POST['order_id']) : 0;
        $order = wc_get_order($order_id);
       
        if (!$order || $order->get_user_id() !== get_current_user_id()) {
            wp_send_json_error(array('message' => __('Invalid order.', 'support-ticket-system')));
        }
       
        $products = array();
        foreach ($order->get_items() as $item) {
            $product = $item->get_product();
            if ($product) {
                $products[] = array(
                    'name' => $product->get_name(),
                    'id' => $product->get_id(),
                    'quantity' => $item->get_quantity()
                );
            }
        }
       
        wp_send_json_success(array('products' => $products));
    }

    // AJAX handler for getting license keys - OPTIMIZED
    public function ajax_get_license_keys() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!is_user_logged_in()) {
            wp_send_json_error(array('message' => __('You must be logged in.', 'support-ticket-system')));
        }
       
        $order_id = isset($_POST['order_id']) ? intval($_POST['order_id']) : 0;
        $product_name = isset($_POST['product_name']) ? sanitize_text_field($_POST['product_name']) : '';
       
        $order = wc_get_order($order_id);
       
        if (!$order || $order->get_user_id() !== get_current_user_id()) {
            wp_send_json_error(array('message' => __('Invalid order.', 'support-ticket-system')));
        }
       
        $license_keys = array();
        foreach ($order->get_items() as $item) {
            $product = $item->get_product();
            if ($product && $product->get_name() === $product_name) {
                $quantity = $item->get_quantity();
               
                if ($quantity > 1) {
                    for ($i = 1; $i <= $quantity; $i++) {
                        $key = $item->get_meta('_license_key_' . $i);
                        if (!$key) {
                            $key = $item->get_meta('license_key_' . $i);
                        }
                        if ($key) {
                            $license_keys[] = $key;
                        }
                    }
                   
                    if (empty($license_keys)) {
                        $key_string = $item->get_meta('_license_keys');
                        if (!$key_string) {
                            $key_string = $item->get_meta('license_keys');
                        }
                        if ($key_string) {
                            $keys = explode(',', $key_string);
                            $keys = array_map('trim', $keys);
                            $license_keys = array_merge($license_keys, $keys);
                        }
                    }
                }
               
                if (empty($license_keys)) {
                    $license_key = $item->get_meta('_license_key');
                    if (!$license_key) {
                        $license_key = $item->get_meta('license_key');
                    }
                    if ($license_key) {
                        $license_keys[] = $license_key;
                    }
                }
               
                break;
            }
        }
       
        wp_send_json_success(array('license_keys' => $license_keys));
    }

    // AJAX handler for submitting tickets - FIXED WITH MULTIPLE FILE UPLOAD SUPPORT
    public function ajax_submit_ticket() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!is_user_logged_in()) {
            wp_send_json_error(array('message' => __('You must be logged in to submit a ticket.', 'support-ticket-system')));
        }
       
        $current_user = wp_get_current_user();
       
        // Validate required fields
        $required_fields = array('order_id', 'product_name', 'issue_category', 'description', 'customer_name', 'customer_email');
        foreach ($required_fields as $field) {
            if (empty($_POST[$field])) {
                wp_send_json_error(array('message' => sprintf(__('Please fill in all required fields. Missing: %s', 'support-ticket-system'), $field)));
            }
        }

        // Validate license status if it's a license issue
        if ($_POST['issue_category'] === 'license_issue' && empty($_POST['license_status'])) {
            wp_send_json_error(array('message' => __('Please select a license key status for license issues.', 'support-ticket-system')));
        }
       
        // License keys are now optional
        $license_keys = array();
        if (isset($_POST['license_keys']) && is_array($_POST['license_keys'])) {
            foreach ($_POST['license_keys'] as $key) {
                $key = sanitize_text_field($key);
                if (!empty($key)) {
                    $license_keys[] = $key;
                }
            }
        }
       
        // Validate order ownership
        $order_id = intval($_POST['order_id']);
        $order = wc_get_order($order_id);
       
        if (!$order) {
            wp_send_json_error(array('message' => __('Invalid order.', 'support-ticket-system')));
        }
       
        if ($order->get_user_id() !== $current_user->ID) {
            wp_send_json_error(array('message' => __('You do not have permission to create a ticket for this order.', 'support-ticket-system')));
        }
       
        // Generate unique ticket ID
        $ticket_id = $this->generate_unique_ticket_id();
       
        // Create ticket post
        $ticket_data = array(
            'post_title' => sprintf(__('Ticket #%s - %s', 'support-ticket-system'), $ticket_id, sanitize_text_field($_POST['product_name'])),
            'post_content' => wp_kses_post($_POST['description']),
            'post_status' => 'publish',
            'post_author' => $current_user->ID,
            'post_type' => 'support_ticket',
        );
       
        $ticket_post_id = wp_insert_post($ticket_data);
       
        if (is_wp_error($ticket_post_id)) {
            wp_send_json_error(array('message' => __('Failed to create ticket. Please try again.', 'support-ticket-system')));
        }
       
        // Save ticket metadata
        update_post_meta($ticket_post_id, 'ticket_id', $ticket_id);
        update_post_meta($ticket_post_id, 'order_id', $order_id);
        update_post_meta($ticket_post_id, 'order_date', $order->get_date_created()->format('Y-m-d H:i:s'));
        update_post_meta($ticket_post_id, 'product_name', sanitize_text_field($_POST['product_name']));
        update_post_meta($ticket_post_id, 'issue_category', sanitize_text_field($_POST['issue_category']));
        update_post_meta($ticket_post_id, 'customer_name', sanitize_text_field($_POST['customer_name']));
        update_post_meta($ticket_post_id, 'customer_email', sanitize_email($_POST['customer_email']));
        update_post_meta($ticket_post_id, 'status', 'open');
        update_post_meta($ticket_post_id, 'priority', sanitize_text_field($_POST['priority']));
        update_post_meta($ticket_post_id, 'last_update', current_time('mysql'));
       
        // Save license status if it's a license issue
        if ($_POST['issue_category'] === 'license_issue' && !empty($_POST['license_status'])) {
            update_post_meta($ticket_post_id, 'license_status', sanitize_text_field($_POST['license_status']));
        }
       
        // Save license keys if provided
        if (!empty($license_keys)) {
            update_post_meta($ticket_post_id, 'license_keys', $license_keys);
        }
       
        // Handle file uploads - FIXED MULTIPLE FILE UPLOAD
        $attachments = array();
        if (!empty($_FILES['attachments'])) {
            $attachments = $this->handle_file_uploads($_FILES['attachments'], $ticket_id);
            if (!empty($attachments)) {
                update_post_meta($ticket_post_id, 'attachments', $attachments);
            }
        }
       
        // Set taxonomies
        wp_set_object_terms($ticket_post_id, 'open', 'ticket_status');
        wp_set_object_terms($ticket_post_id, sanitize_text_field($_POST['priority']), 'ticket_priority');
   
        // Send emails to both buyer and seller
        $this->send_ticket_creation_emails($ticket_post_id, $ticket_id, $current_user, $order);
   
        wp_send_json_success(array(
            'message' => sprintf(__('Your ticket #%s has been created successfully. You will receive a confirmation email shortly.', 'support-ticket-system'), $ticket_id),
            'redirect_url' => $this->get_ticket_view_url($ticket_id),
            'ticket_id' => $ticket_id
        ));
    }

    // AJAX handler for submitting replies - FIXED WITH MULTIPLE FILE UPLOAD SUPPORT
    public function ajax_submit_reply() {
        check_ajax_referer('support_ticket_nonce', 'nonce');
       
        if (!is_user_logged_in()) {
            wp_send_json_error(array('message' => __('You must be logged in to submit a reply.', 'support-ticket-system')));
        }
       
        $current_user = wp_get_current_user();
       
        // Validate required fields
        if (empty($_POST['ticket_id']) || empty($_POST['content'])) {
            wp_send_json_error(array('message' => __('Please fill in all required fields.', 'support-ticket-system')));
        }
       
        $ticket_id = intval($_POST['ticket_id']);
        $ticket = get_post($ticket_id);
       
        if (!$ticket || $ticket->post_type !== 'support_ticket') {
            wp_send_json_error(array('message' => __('Invalid ticket.', 'support-ticket-system')));
        }
       
        // Check if user can reply to this ticket
        $can_reply = false;
        if (current_user_can('administrator') || current_user_can('support_agent')) {
            $can_reply = true;
        } elseif ($ticket->post_author == $current_user->ID) {
            $can_reply = true;
        }
       
        if (!$can_reply) {
            wp_send_json_error(array('message' => __('You do not have permission to reply to this ticket.', 'support-ticket-system')));
        }
       
        // Check if ticket is closed
        $status = get_post_meta($ticket_id, 'status', true);
        if ($status === 'closed') {
            wp_send_json_error(array('message' => __('This ticket is closed. You cannot add new replies.', 'support-ticket-system')));
        }
       
        // Create reply post
        $reply_data = array(
            'post_title' => sprintf(__('Reply to Ticket #%s', 'support-ticket-system'), get_post_meta($ticket_id, 'ticket_id', true)),
            'post_content' => wp_kses_post($_POST['content']),
            'post_status' => 'publish',
            'post_author' => $current_user->ID,
            'post_type' => 'support_ticket_reply',
        );
       
        $reply_id = wp_insert_post($reply_data);
       
        if (is_wp_error($reply_id)) {
            wp_send_json_error(array('message' => __('Failed to submit reply. Please try again.', 'support-ticket-system')));
        }
       
        // Save reply metadata
        update_post_meta($reply_id, 'ticket_id', $ticket_id);
       
        // Handle file uploads - FIXED MULTIPLE FILE UPLOAD
        $attachments = array();
        if (!empty($_FILES['attachments'])) {
            $attachments = $this->handle_file_uploads($_FILES['attachments'], get_post_meta($ticket_id, 'ticket_id', true) . '_reply_' . $reply_id);
            if (!empty($attachments)) {
                update_post_meta($reply_id, 'attachments', $attachments);
            }
        }
       
        // Update ticket last update
        update_post_meta($ticket_id, 'last_update', current_time('mysql'));
       
        // Send email notification to both parties
        $this->send_reply_notification_emails($ticket_id, $reply_id, $current_user);
       
        wp_send_json_success(array(
            'message' => __('Your reply has been submitted successfully.', 'support-ticket-system'),
        ));
    }

    // FIXED: Handle multiple file uploads properly
    private function handle_file_uploads($files, $prefix) {
        $attachments = array();
        $upload_dir = wp_upload_dir();
        $support_ticket_dir = $upload_dir['basedir'] . '/support-tickets';
       
        if (!file_exists($support_ticket_dir)) {
            wp_mkdir_p($support_ticket_dir);
        }
       
        // Make sure directory is writable
        if (!is_writable($support_ticket_dir)) {
            chmod($support_ticket_dir, 0755);
        }
       
        // Handle multiple files
        $file_count = count($files['name']);
        
        for ($i = 0; $i < $file_count; $i++) {
            if ($files['error'][$i] === UPLOAD_ERR_OK) {
                $file_tmp = $files['tmp_name'][$i];
                $file_name = sanitize_file_name($files['name'][$i]);
                $file_size = $files['size'][$i];
               
                // Validate file size (50MB max)
                if ($file_size > 50 * 1024 * 1024) {
                    continue; // Skip this file
                }
               
                // Validate file type
                $allowed_types = array('png', 'jpg', 'jpeg', 'pdf', 'txt', 'mp4', 'mov', 'avi', 'webm');
                $file_ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                if (!in_array($file_ext, $allowed_types)) {
                    continue; // Skip this file
                }
               
                // Generate unique filename
                $unique_name = $prefix . '_' . $i . '_' . time() . '.' . $file_ext;
                $file_path = $support_ticket_dir . '/' . $unique_name;
               
                // Move file to our directory
                if (move_uploaded_file($file_tmp, $file_path)) {
                    // Make sure file is readable
                    chmod($file_path, 0644);
                   
                    $attachments[] = array(
                        'name' => $file_name,
                        'path' => $file_path,
                        'url' => $upload_dir['baseurl'] . '/support-tickets/' . $unique_name,
                        'size' => $file_size,
                    );
                }
            }
        }
       
        return $attachments;
    }

    // Send ticket closed emails
    private function send_ticket_closed_emails($ticket_id) {
        $ticket = get_post($ticket_id);
        $ticket_number = get_post_meta($ticket_id, 'ticket_id', true);
        $ticket_author = get_userdata($ticket->post_author);
        $assigned_agent_id = get_post_meta($ticket_id, 'assigned_agent', true);
       
        $site_name = get_bloginfo('name');
        $site_url = home_url();
        $ticket_url = $this->get_ticket_view_url($ticket_number);
       
        // Email to customer
        $customer_subject = sprintf(__('Support Ticket #%s Closed', 'support-ticket-system'), $ticket_number);
        $customer_message = $this->get_ticket_closed_email_template($ticket_number, true, $ticket_url, $site_name, $site_url);
        $headers = array('Content-Type: text/html; charset=UTF-8');
       
        wp_mail($ticket_author->user_email, $customer_subject, $customer_message, $headers);
       
        // Email to assigned agent if exists
        if ($assigned_agent_id) {
            $agent = get_userdata($assigned_agent_id);
            if ($agent) {
                $agent_subject = sprintf(__('Ticket #%s Closed', 'support-ticket-system'), $ticket_number);
                $agent_message = $this->get_ticket_closed_email_template($ticket_number, false, $ticket_url, $site_name, $site_url);
                wp_mail($agent->user_email, $agent_subject, $agent_message, $headers);
            }
        }
       
        // Email to admin
        $admin_email = get_option('admin_email');
        wp_mail($admin_email, $customer_subject, $customer_message, $headers);
    }

    private function get_ticket_closed_email_template($ticket_number, $is_customer, $ticket_url, $site_name, $site_url) {
        if ($is_customer) {
            $title = sprintf(__('Your Support Ticket #%s Has Been Closed', 'support-ticket-system'), $ticket_number);
            $intro = __('Your support ticket has been closed. If you need further assistance, please feel free to open a new ticket.', 'support-ticket-system');
        } else {
            $title = sprintf(__('Support Ticket #%s Closed', 'support-ticket-system'), $ticket_number);
            $intro = __('A support ticket has been closed.', 'support-ticket-system');
        }
       
        ob_start();
        ?>
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title><?php echo esc_html($title); ?></title>
        </head>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h1 style="color: #38a169; margin: 0 0 10px 0;"><?php echo esc_html($title); ?></h1>
                <p style="margin: 0;"><?php echo esc_html($intro); ?></p>
            </div>
           
            <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <h2 style="color: #2d3748; margin-top: 0;"><?php _e('Ticket Information', 'support-ticket-system'); ?></h2>
                <p><strong><?php _e('Ticket ID:', 'support-ticket-system'); ?></strong> #<?php echo esc_html($ticket_number); ?></p>
                <p><strong><?php _e('Status:', 'support-ticket-system'); ?></strong> <span style="color: #38a169; font-weight: bold;"><?php _e('Closed', 'support-ticket-system'); ?></span></p>
            </div>
           
            <div style="text-align: center; margin-bottom: 20px;">
                <a href="<?php echo esc_url($ticket_url); ?>" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;"><?php _e('View Ticket', 'support-ticket-system'); ?></a>
            </div>
           
            <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; color: #6b7280; font-size: 14px;">
                <p><?php printf(__('© %s %s. All rights reserved.', 'support-ticket-system'), date('Y'), esc_html($site_name)); ?></p>
                <p><?php printf(__('This email was sent from %s', 'support-ticket-system'), '<a href="' . esc_url($site_url) . '">' . esc_html($site_url) . '</a>'); ?></p>
            </div>
        </body>
        </html>
        <?php
        return ob_get_clean();
    }
   
    // Send ticket creation emails
    private function send_ticket_creation_emails($ticket_post_id, $ticket_number, $user, $order) {
        $ticket = get_post($ticket_post_id);
        $ticket_meta = array(
            'product_name' => get_post_meta($ticket_post_id, 'product_name', true),
            'order_id' => get_post_meta($ticket_post_id, 'order_id', true),
            'priority' => get_post_meta($ticket_post_id, 'priority', true),
            'description' => $ticket->post_content,
            'attachments' => get_post_meta($ticket_post_id, 'attachments', true) ?: array(),
        );
       
        $site_name = get_bloginfo('name');
        $site_url = home_url();
        $ticket_url = $this->get_ticket_view_url($ticket_number);
       
        // Email to customer
        $customer_subject = sprintf(__('Support Ticket #%s Created', 'support-ticket-system'), $ticket_number);
        $customer_message = $this->get_ticket_creation_email_template($ticket_number, $ticket_meta, true, $ticket_url, $site_name, $site_url);
        $headers = array('Content-Type: text/html; charset=UTF-8');
       
        // Get attachment paths for email - FIXED TO PROPERLY HANDLE MULTIPLE FILES
        $attachment_paths = array();
        if (!empty($ticket_meta['attachments'])) {
            foreach ($ticket_meta['attachments'] as $attachment) {
                $attachment_paths[] = $attachment['path'];
            }
        }
       
        wp_mail($user->user_email, $customer_subject, $customer_message, $headers, $attachment_paths);
       
        // Email to admin/support agents
        $admin_subject = sprintf(__('New Support Ticket #%s', 'support-ticket-system'), $ticket_number);
        $admin_message = $this->get_ticket_creation_email_template($ticket_number, $ticket_meta, false, $ticket_url, $site_name, $site_url);
       
        $admin_email = get_option('admin_email');
        wp_mail($admin_email, $admin_subject, $admin_message, $headers, $attachment_paths);
       
        // Also send to support agents if they exist
        $support_agents = get_users(array('role' => 'support_agent'));
        foreach ($support_agents as $agent) {
            wp_mail($agent->user_email, $admin_subject, $admin_message, $headers, $attachment_paths);
        }
       
        // Send to shop manager/seller
        $shop_manager = get_user_by('email', get_option('woocommerce_email_from_address'));
        if ($shop_manager && $shop_manager->user_email !== $admin_email) {
            wp_mail($shop_manager->user_email, $admin_subject, $admin_message, $headers, $attachment_paths);
        }
    }
   
    private function send_reply_notification_emails($ticket_id, $reply_id, $reply_author) {
        $ticket = get_post($ticket_id);
        $reply = get_post($reply_id);
        $ticket_number = get_post_meta($ticket_id, 'ticket_id', true);
        $ticket_author = get_userdata($ticket->post_author);
        $assigned_agent_id = get_post_meta($ticket_id, 'assigned_agent', true);
       
        $site_name = get_bloginfo('name');
        $site_url = home_url();
        $ticket_url = $this->get_ticket_view_url($ticket_number);
       
        // Get reply attachments - FIXED TO PROPERLY HANDLE MULTIPLE FILES
        $reply_attachments = get_post_meta($reply_id, 'attachments', true) ?: array();
        $attachment_paths = array();
        if (!empty($reply_attachments)) {
            foreach ($reply_attachments as $attachment) {
                $attachment_paths[] = $attachment['path'];
            }
        }
       
        // Email to ticket author if reply is from admin/agent
        if (current_user_can('administrator') || current_user_can('support_agent')) {
            $customer_subject = sprintf(__('New Reply to Your Support Ticket #%s', 'support-ticket-system'), $ticket_number);
            $customer_message = $this->get_reply_notification_email_template($ticket_number, $reply, true, $ticket_url, $site_name, $site_url);
            $headers = array('Content-Type: text/html; charset=UTF-8');
           
            wp_mail($ticket_author->user_email, $customer_subject, $customer_message, $headers, $attachment_paths);
        }
        // Email to admin/agents if reply is from customer
        else {
            $admin_subject = sprintf(__('New Reply to Support Ticket #%s', 'support-ticket-system'), $ticket_number);
            $admin_message = $this->get_reply_notification_email_template($ticket_number, $reply, false, $ticket_url, $site_name, $site_url);
            $headers = array('Content-Type: text/html; charset=UTF-8');
           
            $admin_email = get_option('admin_email');
            wp_mail($admin_email, $admin_subject, $admin_message, $headers, $attachment_paths);
           
            // Also send to support agents if they exist
            $support_agents = get_users(array('role' => 'support_agent'));
            foreach ($support_agents as $agent) {
                wp_mail($agent->user_email, $admin_subject, $admin_message, $headers, $attachment_paths);
            }
           
            // Send to assigned agent if different
            if ($assigned_agent_id && $assigned_agent_id != get_current_user_id()) {
                $assigned_agent = get_userdata($assigned_agent_id);
                if ($assigned_agent) {
                    wp_mail($assigned_agent->user_email, $admin_subject, $admin_message, $headers, $attachment_paths);
                }
            }
           
            // Send to shop manager/seller
            $shop_manager = get_user_by('email', get_option('woocommerce_email_from_address'));
            if ($shop_manager && $shop_manager->user_email !== $admin_email) {
                wp_mail($shop_manager->user_email, $admin_subject, $admin_message, $headers, $attachment_paths);
            }
        }
    }
   
    private function get_ticket_creation_email_template($ticket_number, $ticket_meta, $is_customer, $ticket_url, $site_name, $site_url) {
        if ($is_customer) {
            $title = sprintf(__('Your Support Ticket #%s Has Been Created', 'support-ticket-system'), $ticket_number);
            $intro = __('Thank you for contacting our support team. Your ticket has been created and we will get back to you as soon as possible.', 'support-ticket-system');
        } else {
            $title = sprintf(__('New Support Ticket #%s', 'support-ticket-system'), $ticket_number);
            $intro = __('A new support ticket has been submitted. Please review and respond as needed.', 'support-ticket-system');
        }
       
        ob_start();
        ?>
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title><?php echo esc_html($title); ?></title>
        </head>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h1 style="color: #3b82f6; margin: 0 0 10px 0;"><?php echo esc_html($title); ?></h1>
                <p style="margin: 0;"><?php echo esc_html($intro); ?></p>
            </div>
           
            <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <h2 style="color: #2d3748; margin-top: 0;"><?php _e('Ticket Details', 'support-ticket-system'); ?></h2>
                <p><strong><?php _e('Ticket ID:', 'support-ticket-system'); ?></strong> #<?php echo esc_html($ticket_number); ?></p>
                <p><strong><?php _e('Product:', 'support-ticket-system'); ?></strong> <?php echo esc_html($ticket_meta['product_name']); ?></p>
                <p><strong><?php _e('Order ID:', 'support-ticket-system'); ?></strong> <?php echo esc_html($ticket_meta['order_id']); ?></p>
                <p><strong><?php _e('Priority:', 'support-ticket-system'); ?></strong> <?php echo esc_html(ucfirst($ticket_meta['priority'])); ?></p>
                <p><strong><?php _e('Description:', 'support-ticket-system'); ?></strong></p>
                <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-top: 10px;">
                    <?php echo wpautop(wp_kses_post($ticket_meta['description'])); ?>
                </div>
                
                <?php if (!empty($ticket_meta['attachments'])): ?>
                    <p><strong><?php _e('Attachments:', 'support-ticket-system'); ?></strong></p>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-top: 10px;">
                        <?php foreach ((array)$ticket_meta['attachments'] as $attachment): ?>
                            <div style="margin-bottom: 10px;">
                                <a href="<?php echo esc_url($attachment['url']); ?>" style="color: #3b82f6; text-decoration: none;" target="_blank">
                                    <?php echo esc_html($attachment['name']); ?>
                                </a>
                            </div>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>
            </div>
           
            <div style="text-align: center; margin-bottom: 20px;">
                <a href="<?php echo esc_url($ticket_url); ?>" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;"><?php _e('View Ticket', 'support-ticket-system'); ?></a>
            </div>
           
            <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; color: #6b7280; font-size: 14px;">
                <p><?php printf(__('© %s %s. All rights reserved.', 'support-ticket-system'), date('Y'), esc_html($site_name)); ?></p>
                <p><?php printf(__('This email was sent from %s', 'support-ticket-system'), '<a href="' . esc_url($site_url) . '">' . esc_html($site_url) . '</a>'); ?></p>
            </div>
        </body>
        </html>
        <?php
        return ob_get_clean();
    }
   
    private function get_reply_notification_email_template($ticket_number, $reply, $is_customer, $ticket_url, $site_name, $site_url) {
        $reply_author = get_userdata($reply->post_author);
        $reply_attachments = get_post_meta($reply->ID, 'attachments', true) ?: array();
       
        if ($is_customer) {
            $title = sprintf(__('New Reply to Your Support Ticket #%s', 'support-ticket-system'), $ticket_number);
            $intro = sprintf(__('There is a new reply to your support ticket from %s.', 'support-ticket-system'), $reply_author->display_name);
        } else {
            $title = sprintf(__('New Reply to Support Ticket #%s', 'support-ticket-system'), $ticket_number);
            $intro = sprintf(__('There is a new reply to the support ticket from %s.', 'support-ticket-system'), $reply_author->display_name);
        }
       
        ob_start();
        ?>
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title><?php echo esc_html($title); ?></title>
        </head>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h1 style="color: #3b82f6; margin: 0 0 10px 0;"><?php echo esc_html($title); ?></h1>
                <p style="margin: 0;"><?php echo esc_html($intro); ?></p>
            </div>
           
            <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <h2 style="color: #2d3748; margin-top: 0;"><?php _e('Reply Details', 'support-ticket-system'); ?></h2>
                <p><strong><?php _e('Ticket ID:', 'support-ticket-system'); ?></strong> #<?php echo esc_html($ticket_number); ?></p>
                <p><strong><?php _e('From:', 'support-ticket-system'); ?></strong> <?php echo esc_html($reply_author->display_name); ?></p>
                <p><strong><?php _e('Date:', 'support-ticket-system'); ?></strong> <?php echo esc_html(date('M j, Y H:i', strtotime($reply->post_date))); ?></p>
                <p><strong><?php _e('Message:', 'support-ticket-system'); ?></strong></p>
                <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-top: 10px;">
                    <?php echo wpautop(wp_kses_post($reply->post_content)); ?>
                </div>
                
                <?php if (!empty($reply_attachments)): ?>
                    <p><strong><?php _e('Attachments:', 'support-ticket-system'); ?></strong></p>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-top: 10px;">
                        <?php foreach ((array)$reply_attachments as $attachment): ?>
                            <div style="margin-bottom: 10px;">
                                <a href="<?php echo esc_url($attachment['url']); ?>" style="color: #3b82f6; text-decoration: none;" target="_blank">
                                    <?php echo esc_html($attachment['name']); ?>
                                </a>
                            </div>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>
            </div>
           
            <div style="text-align: center; margin-bottom: 20px;">
                <a href="<?php echo esc_url($ticket_url); ?>" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;"><?php _e('View Ticket', 'support-ticket-system'); ?></a>
            </div>
           
            <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; color: #6b7280; font-size: 14px;">
                <p><?php printf(__('© %s %s. All rights reserved.', 'support-ticket-system'), date('Y'), esc_html($site_name)); ?></p>
                <p><?php printf(__('This email was sent from %s', 'support-ticket-system'), '<a href="' . esc_url($site_url) . '">' . esc_html($site_url) . '</a>'); ?></p>
            </div>
        </body>
        </html>
        <?php
        return ob_get_clean();
    }
   
    private function get_user_orders() {
        if (!is_user_logged_in() || !class_exists('WooCommerce')) {
            return array();
        }
       
        $customer_orders = wc_get_orders(array(
            'customer_id' => get_current_user_id(),
            'limit' => -1,
            'orderby' => 'date',
            'order' => 'DESC',
            'status' => array('completed', 'processing'),
        ));
       
        return $customer_orders;
    }
   
    private function get_user_tickets($user_id, $page = 1, $per_page = 10) {
        $args = array(
            'post_type' => 'support_ticket',
            'author' => $user_id,
            'posts_per_page' => $per_page,
            'paged' => $page,
            'orderby' => 'date',
            'order' => 'DESC',
        );
       
        return get_posts($args);
    }
   
    private function get_agent_tickets($agent_id) {
        $current_user = wp_get_current_user();
       
        // If admin, get all tickets
        if (in_array('administrator', $current_user->roles)) {
            $args = array(
                'post_type' => 'support_ticket',
                'posts_per_page' => -1,
                'orderby' => 'date',
                'order' => 'DESC',
            );
        } else {
            // If agent, get tickets assigned to them
            $args = array(
                'post_type' => 'support_ticket',
                'meta_query' => array(
                    array(
                        'key' => 'assigned_agent',
                        'value' => $agent_id,
                        'compare' => '=',
                    ),
                ),
                'posts_per_page' => -1,
                'orderby' => 'date',
                'order' => 'DESC',
            );
        }
       
        return get_posts($args);
    }

    private function get_agent_ticket_metrics($agent_id) {
        $tickets = $this->get_agent_tickets($agent_id);
       
        $metrics = array(
            'total' => count($tickets),
            'open' => 0,
            'closed' => 0,
            'pending' => 0,
        );
       
        foreach ($tickets as $ticket) {
            $status = get_post_meta($ticket->ID, 'status', true);
            if ($status === 'open') {
                $metrics['open']++;
            } elseif ($status === 'closed') {
                $metrics['closed']++;
            } elseif ($status === 'pending') {
                $metrics['pending']++;
            }
        }
       
        return $metrics;
    }
   
    private function get_ticket_view_url($ticket_id) {
        return add_query_arg('id', $ticket_id, home_url('/ticket-view/'));
    }
   
    private function login_required_message() {
        return '<div class="support-ticket-container">
            <div class="support-ticket-card">
                <div class="support-ticket-alert support-ticket-alert-error">
                    <p>' . __('Please log in to access the support system.', 'support-ticket-system') . '</p>
                </div>
                <a href="' . wp_login_url(get_permalink()) . '" class="support-ticket-btn support-ticket-btn-block">
                    ' . __('Login to Continue', 'support-ticket-system') . '
                </a>
            </div>
        </div>';
    }

    // NEW HELPER METHODS

    private function get_ticket_metrics($user_id = null) {
        $user_id = $user_id ?: get_current_user_id();
       
        $all_tickets = $this->get_user_tickets($user_id);
        $open_tickets = array_filter($all_tickets, function($ticket) {
            return get_post_meta($ticket->ID, 'status', true) === 'open';
        });
       
        $closed_tickets = array_filter($all_tickets, function($ticket) {
            return get_post_meta($ticket->ID, 'status', true) === 'closed';
        });
       
        return array(
            'total' => count($all_tickets),
            'open' => count($open_tickets),
            'closed' => count($closed_tickets),
            'response_rate' => $this->calculate_response_rate($user_id)
        );
    }

    private function calculate_response_rate($user_id) {
        return '95%';
    }

    private function get_ticket_timeline($ticket_id) {
        $timeline = array();
       
        // Ticket creation
        $ticket = get_post($ticket_id);
        $timeline[] = array(
            'date' => $ticket->post_date,
            'action' => 'ticket_created',
            'user' => get_userdata($ticket->post_author),
            'description' => __('Ticket created', 'support-ticket-system')
        );
       
        // Status changes
        $status_changes = get_post_meta($ticket_id, 'status_history', true);
        if ($status_changes) {
            $timeline = array_merge($timeline, $status_changes);
        }
       
        // Agent assignments
        $agent_changes = get_post_meta($ticket_id, 'agent_history', true);
        if ($agent_changes) {
            $timeline = array_merge($timeline, $agent_changes);
        }
       
        usort($timeline, function($a, $b) {
            return strtotime($a['date']) - strtotime($b['date']);
        });
       
        return $timeline;
    }

    public function add_ticket_assignment_interface($ticket_id) {
        if (!current_user_can('administrator') && !current_user_can('support_agent')) {
            return;
        }
       
        // Only get users who have been explicitly added as support agents
        $agents = get_users(array(
            'meta_key' => 'is_explicit_support_agent',
            'meta_value' => true,
            'fields' => array('ID', 'display_name')
        ));
       
        $current_agent = get_post_meta($ticket_id, 'assigned_agent', true);
       
        echo '<div class="support-ticket-assignment">';
        echo '<label for="support-assign-agent">' . __('Assign to:', 'support-ticket-system') . '</label>';
        echo '<select id="support-assign-agent" data-ticket-id="' . $ticket_id . '">';
        echo '<option value="">' . __('Unassigned', 'support-ticket-system') . '</option>';
        foreach ($agents as $agent) {
            $selected = $current_agent == $agent->ID ? 'selected' : '';
            echo '<option value="' . $agent->ID . '" ' . $selected . '>' . esc_html($agent->display_name) . '</option>';
        }
        echo '</select>';
        echo '</div>';
    }

    // Helper methods
    private function generate_unique_ticket_id() {
        do {
            $ticket_id = 'TS' . str_pad(mt_rand(1, 99999), 5, '0', STR_PAD_LEFT);
            $existing = get_posts(array(
                'post_type' => 'support_ticket',
                'meta_query' => array(
                    array(
                        'key' => 'ticket_id',
                        'value' => $ticket_id,
                        'compare' => '=',
                    ),
                ),
                'posts_per_page' => 1,
            ));
        } while (!empty($existing));
       
        return $ticket_id;
    }
}

// Initialize the plugin
function support_ticket_system_init() {
    return Support_Ticket_System::get_instance();
}
add_action('plugins_loaded', 'support_ticket_system_init');

// Helper function to get ticket view URL
function support_get_ticket_view_url($ticket_id) {
    $plugin = Support_Ticket_System::get_instance();
    return $plugin->get_ticket_view_url($ticket_id);
}

// Add endpoint for My Tickets
function support_ticket_add_endpoint() {
    add_rewrite_endpoint('my-tickets', EP_PAGES);
}
add_action('init', 'support_ticket_add_endpoint');


File 2 : Ticket Page Functionality (includes/ticket-page.php)
  <?php
// Prevent direct access
if (!defined('WPINC')) {
    die;
}

/**
 * Support Ticket Page Functionality
 */

class SupportTicketPage {
    
    public function __construct() {
        add_shortcode('support_ticket_form', array($this, 'display_ticket_form'));
        add_action('wp_enqueue_scripts', array($this, 'enqueue_styles'));
        add_action('wp_ajax_submit_support_ticket', array($this, 'handle_ajax_ticket_submission'));
        add_action('wp_ajax_nopriv_submit_support_ticket', array($this, 'handle_ajax_ticket_submission'));
    }
    
    public function enqueue_styles() {
        wp_enqueue_style('support-ticket-style', plugin_dir_url(__FILE__) . '../assets/ticket-style.css', array(), '1.0.0');
        wp_enqueue_script('support-ticket-script', plugin_dir_url(__FILE__) . '../assets/ticket-script.js', array('jquery'), '1.0.0', true);
        
        wp_localize_script('support-ticket-script', 'ticket_ajax', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('submit_ticket_nonce')
        ));
    }
    
    public function display_ticket_form() {
        ob_start();
        ?>
        <div class="sts-ticket-page">
            <div class="sts-container">
                <div class="sts-header">
                    <h1><i class="fas fa-life-ring"></i> Create Support Ticket</h1>
                    <p>Fill out the form below to get help with your product</p>
                </div>
                
                <form id="sts-ticket-form" class="sts-ticket-form" method="POST" enctype="multipart/form-data">
                    <?php wp_nonce_field('submit_ticket_action', 'ticket_nonce'); ?>
                    
                    <!-- Customer Information Section -->
                    <div class="sts-form-section">
                        <h3><i class="fas fa-user"></i> Your Information</h3>
                        <div class="sts-form-row">
                            <div class="sts-form-group">
                                <label for="sts_customer_name">Full Name *</label>
                                <input type="text" id="sts_customer_name" name="customer_name" required 
                                       placeholder="Enter your full name">
                                <span class="sts-field-error"></span>
                            </div>
                            
                            <div class="sts-form-group">
                                <label for="sts_customer_email">Email Address *</label>
                                <input type="email" id="sts_customer_email" name="customer_email" required 
                                       placeholder="your@email.com">
                                <span class="sts-field-error"></span>
                            </div>
                        </div>
                        
                        <div class="sts-form-row">
                            <div class="sts-form-group">
                                <label for="sts_customer_phone">Phone Number</label>
                                <input type="tel" id="sts_customer_phone" name="customer_phone" 
                                       placeholder="+1 (555) 123-4567">
                            </div>
                            
                            <div class="sts-form-group">
                                <label for="sts_company">Company Name</label>
                                <input type="text" id="sts_company" name="company" 
                                       placeholder="Your company name (optional)">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Information Section -->
                    <div class="sts-form-section">
                        <h3><i class="fas fa-cube"></i> Product Information</h3>
                        <div class="sts-form-row">
                            <div class="sts-form-group">
                                <label for="sts_product_category">Product Category *</label>
                                <select id="sts_product_category" name="product_category" required>
                                    <option value="">Select Category</option>
                                    <option value="premium-plugin">Premium Plugin</option>
                                    <option value="basic-plugin">Basic Plugin</option>
                                    <option value="premium-theme">Premium Theme</option>
                                    <option value="basic-theme">Basic Theme</option>
                                    <option value="addon">Add-on/Extension</option>
                                    <option value="bundle">Product Bundle</option>
                                    <option value="other">Other</option>
                                </select>
                                <span class="sts-field-error"></span>
                            </div>
                            
                            <div class="sts-form-group">
                                <label for="sts_product_name">Product Name *</label>
                                <select id="sts_product_name" name="product_name" required>
                                    <option value="">Select Product</option>
                                    <optgroup label="Premium Plugins">
                                        <option value="ultimate-seo-pro">Ultimate SEO Pro</option>
                                        <option value="ecommerce-master">Ecommerce Master</option>
                                        <option value="security-shield-pro">Security Shield Pro</option>
                                        <option value="speed-optimizer">Speed Optimizer Pro</option>
                                    </optgroup>
                                    <optgroup label="Basic Plugins">
                                        <option value="seo-basic">SEO Basic</option>
                                        <option value="contact-form-basic">Contact Form Basic</option>
                                        <option value="gallery-basic">Gallery Basic</option>
                                    </optgroup>
                                    <optgroup label="Themes">
                                        <option value="business-pro-theme">Business Pro Theme</option>
                                        <option value="portfolio-theme">Portfolio Theme</option>
                                        <option value="woocommerce-theme">WooCommerce Theme</option>
                                    </optgroup>
                                </select>
                                <span class="sts-field-error"></span>
                            </div>
                        </div>
                        
                        <div class="sts-form-row">
                            <div class="sts-form-group">
                                <label for="sts_license_key">License Key *</label>
                                <input type="text" id="sts_license_key" name="license_key" required 
                                       placeholder="Enter your purchase code or license key">
                                <small class="sts-help-text">You can find this in your purchase confirmation email</small>
                                <span class="sts-field-error"></span>
                            </div>
                            
                            <div class="sts-form-group">
                                <label for="sts_purchase_date">Purchase Date</label>
                                <input type="date" id="sts_purchase_date" name="purchase_date">
                                <small class="sts-help-text">Approximate date of purchase</small>
                            </div>
                        </div>
                        
                        <div class="sts-form-group">
                            <label for="sts_website_url">Website URL *</label>
                            <input type="url" id="sts_website_url" name="website_url" required 
                                   placeholder="https://yourwebsite.com">
                            <span class="sts-field-error"></span>
                        </div>
                    </div>
                    
                    <!-- Issue Details Section -->
                    <div class="sts-form-section">
                        <h3><i class="fas fa-exclamation-circle"></i> Issue Details</h3>
                        
                        <div class="sts-form-row">
                            <div class="sts-form-group">
                                <label for="sts_issue_type">Issue Type *</label>
                                <select id="sts_issue_type" name="issue_type" required>
                                    <option value="">Select Issue Type</option>
                                    <option value="technical">Technical Problem</option>
                                    <option value="installation">Installation Issue</option>
                                    <option value="configuration">Configuration Help</option>
                                    <option value="bug">Bug Report</option>
                                    <option value="feature">Feature Request</option>
                                    <option value="billing">Billing Question</option>
                                    <option value="license">License Activation</option>
                                    <option value="other">Other</option>
                                </select>
                                <span class="sts-field-error"></span>
                            </div>
                            
                            <div class="sts-form-group">
                                <label for="sts_priority">Priority Level *</label>
                                <select id="sts_priority" name="priority" required>
                                    <option value="low">Low - General Question</option>
                                    <option value="medium" selected>Medium - Minor Issue</option>
                                    <option value="high">High - Feature Not Working</option>
                                    <option value="urgent">Urgent - Site Down/Critical</option>
                                </select>
                                <span class="sts-field-error"></span>
                            </div>
                        </div>
                        
                        <div class="sts-form-group">
                            <label for="sts_ticket_subject">Subject *</label>
                            <input type="text" id="sts_ticket_subject" name="ticket_subject" required 
                                   placeholder="Brief description of your issue">
                            <span class="sts-field-error"></span>
                        </div>
                        
                        <div class="sts-form-group">
                            <label for="sts_ticket_description">Detailed Description *</label>
                            <textarea id="sts_ticket_description" name="ticket_description" rows="8" required 
                                      placeholder="Please provide detailed information about your issue. Include steps to reproduce, error messages, and what you were trying to achieve."></textarea>
                            <div class="sts-character-count">
                                <span id="sts_char_count">0</span> characters (minimum 50)
                            </div>
                            <span class="sts-field-error"></span>
                        </div>
                        
                        <div class="sts-form-row">
                            <div class="sts-form-group">
                                <label for="sts_environment">Your Environment</label>
                                <select id="sts_environment" name="environment">
                                    <option value="">Select Environment</option>
                                    <option value="local">Local Development</option>
                                    <option value="staging">Staging Site</option>
                                    <option value="production" selected>Production/Live Site</option>
                                </select>
                            </div>
                            
                            <div class="sts-form-group">
                                <label for="sts_wordpress_version">WordPress Version</label>
                                <input type="text" id="sts_wordpress_version" name="wordpress_version" 
                                       placeholder="e.g., 6.3, 6.4" value="<?php echo get_bloginfo('version'); ?>">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attachments Section -->
                    <div class="sts-form-section">
                        <h3><i class="fas fa-paperclip"></i> Attachments</h3>
                        <div class="sts-form-group">
                            <label for="sts_attachments">Screenshots or Files</label>
                            <div class="sts-file-upload">
                                <input type="file" id="sts_attachments" name="attachments[]" multiple 
                                       accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.log">
                                <div class="sts-file-upload-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>Click to upload files or drag and drop</span>
                                    <small>Maximum file size: 10MB per file. Allowed: images, documents, logs</small>
                                </div>
                            </div>
                            <div id="sts-file-list" class="sts-file-list"></div>
                        </div>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="sts-form-section">
                        <h3><i class="fas fa-info-circle"></i> Additional Information</h3>
                        <div class="sts-form-group">
                            <label for="sts_additional_notes">Additional Notes (Optional)</label>
                            <textarea id="sts_additional_notes" name="additional_notes" rows="4" 
                                      placeholder="Any other information that might help us resolve your issue faster..."></textarea>
                        </div>
                        
                        <div class="sts-form-group sts-checkbox-group">
                            <label class="sts-checkbox">
                                <input type="checkbox" name="agree_terms" required>
                                <span class="sts-checkmark"></span>
                                I agree to the <a href="#" target="_blank">Terms of Service</a> and understand that support is provided according to my license type
                            </label>
                        </div>
                        
                        <div class="sts-form-group sts-checkbox-group">
                            <label class="sts-checkbox">
                                <input type="checkbox" name="share_data" checked>
                                <span class="sts-checkmark"></span>
                                I allow temporary access to my site data for troubleshooting purposes
                            </label>
                        </div>
                    </div>
                    
                    <!-- Submit Section -->
                    <div class="sts-form-section sts-submit-section">
                        <div class="sts-form-actions">
                            <button type="submit" id="sts-submit-btn" class="sts-submit-btn">
                                <i class="fas fa-paper-plane"></i>
                                <span class="sts-btn-text">Submit Ticket</span>
                                <div class="sts-spinner"></div>
                            </button>
                            
                            <button type="reset" class="sts-reset-btn">
                                <i class="fas fa-redo"></i>
                                Clear Form
                            </button>
                        </div>
                        
                        <div class="sts-support-info">
                            <h4><i class="fas fa-clock"></i> Support Hours</h4>
                            <p>Monday - Friday: 9:00 AM - 6:00 PM (Your Timezone)<br>
                            Average Response Time: 2-4 hours during business hours</p>
                        </div>
                    </div>
                </form>
                
                <!-- Success Message -->
                <div id="sts-success-message" class="sts-message sts-success-message" style="display: none;">
                    <div class="sts-message-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="sts-message-content">
                        <h3>Ticket Submitted Successfully!</h3>
                        <p>Your support ticket has been created. We've sent a confirmation to your email.</p>
                        <div class="sts-ticket-info">
                            <strong>Ticket ID: <span id="sts-ticket-id"></span></strong><br>
                            <small>Please keep this ID for reference. We'll get back to you soon.</small>
                        </div>
                        <button id="sts-new-ticket" class="sts-new-ticket-btn">
                            <i class="fas fa-plus"></i> Create Another Ticket
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
    
    public function handle_ajax_ticket_submission() {
        // Verify nonce
        if (!wp_verify_nonce($_POST['nonce'], 'submit_ticket_nonce')) {
            wp_die('Security check failed');
        }
        
        // Validate and sanitize data
        $ticket_data = array(
            'customer_name' => sanitize_text_field($_POST['customer_name']),
            'customer_email' => sanitize_email($_POST['customer_email']),
            'customer_phone' => sanitize_text_field($_POST['customer_phone']),
            'company' => sanitize_text_field($_POST['company']),
            'product_category' => sanitize_text_field($_POST['product_category']),
            'product_name' => sanitize_text_field($_POST['product_name']),
            'license_key' => sanitize_text_field($_POST['license_key']),
            'purchase_date' => sanitize_text_field($_POST['purchase_date']),
            'website_url' => esc_url_raw($_POST['website_url']),
            'issue_type' => sanitize_text_field($_POST['issue_type']),
            'priority' => sanitize_text_field($_POST['priority']),
            'ticket_subject' => sanitize_text_field($_POST['ticket_subject']),
            'ticket_description' => wp_kses_post($_POST['ticket_description']),
            'environment' => sanitize_text_field($_POST['environment']),
            'wordpress_version' => sanitize_text_field($_POST['wordpress_version']),
            'additional_notes' => wp_kses_post($_POST['additional_notes'])
        );
        
        // Create ticket post
        $ticket_id = wp_insert_post(array(
            'post_title' => $ticket_data['ticket_subject'],
            'post_content' => $ticket_data['ticket_description'],
            'post_status' => 'publish',
            'post_type' => 'support_ticket',
            'meta_input' => $ticket_data
        ));
        
        if ($ticket_id && !is_wp_error($ticket_id)) {
            // Handle file uploads
            $this->handle_file_uploads($ticket_id);
            
            // Send confirmation email
            $this->send_confirmation_email($ticket_id, $ticket_data);
            
            wp_send_json_success(array(
                'ticket_id' => $ticket_id,
                'message' => 'Ticket submitted successfully!'
            ));
        } else {
            wp_send_json_error(array(
                'message' => 'Error submitting ticket. Please try again.'
            ));
        }
    }
    
    private function handle_file_uploads($ticket_id) {
        if (!empty($_FILES['attachments'])) {
            require_once(ABSPATH . 'wp-admin/includes/file.php');
            require_once(ABSPATH . 'wp-admin/includes/media.php');
            require_once(ABSPATH . 'wp-admin/includes/image.php');
            
            $attachments = array();
            foreach ($_FILES['attachments']['name'] as $key => $value) {
                if ($_FILES['attachments']['error'][$key] === 0) {
                    $file = array(
                        'name' => $_FILES['attachments']['name'][$key],
                        'type' => $_FILES['attachments']['type'][$key],
                        'tmp_name' => $_FILES['attachments']['tmp_name'][$key],
                        'error' => $_FILES['attachments']['error'][$key],
                        'size' => $_FILES['attachments']['size'][$key]
                    );
                    
                    $upload = wp_handle_upload($file, array('test_form' => false));
                    if (!isset($upload['error'])) {
                        $attachments[] = $upload['url'];
                    }
                }
            }
            
            if (!empty($attachments)) {
                update_post_meta($ticket_id, '_ticket_attachments', $attachments);
            }
        }
    }
    
    private function send_confirmation_email($ticket_id, $ticket_data) {
        $to = $ticket_data['customer_email'];
        $subject = 'Support Ticket Created - Ticket #' . $ticket_id;
        $headers = array('Content-Type: text/html; charset=UTF-8');
        
        $message = "
        <html>
        <head>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #007cba; color: white; padding: 20px; text-align: center; }
                .content { padding: 20px; background: #f9f9f9; }
                .ticket-info { background: white; padding: 15px; border-left: 4px solid #007cba; margin: 10px 0; }
            </style>
        </head>
        <body>
            <div class='container'>
                <div class='header'>
                    <h1>Support Ticket Created</h1>
                </div>
                <div class='content'>
                    <p>Hello {$ticket_data['customer_name']},</p>
                    <p>Thank you for contacting our support team. We have received your ticket and will get back to you shortly.</p>
                    
                    <div class='ticket-info'>
                        <strong>Ticket ID:</strong> #{$ticket_id}<br>
                        <strong>Subject:</strong> {$ticket_data['ticket_subject']}<br>
                        <strong>Product:</strong> {$ticket_data['product_name']}<br>
                        <strong>Priority:</strong> " . ucfirst($ticket_data['priority']) . "<br>
                    </div>
                    
                    <p>You can view your ticket or add additional information by replying to this email.</p>
                    <p>Best regards,<br>Support Team</p>
                </div>
            </div>
        </body>
        </html>";
        
        wp_mail($to, $subject, $message, $headers);
    }
}

// Initialize the ticket page functionality
new SupportTicketPage();


File 3: Create assets/ticket-style.css
/* Support Ticket System Styles */
.sts-ticket-page {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
}

.sts-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.sts-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    text-align: center;
}

.sts-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.2em;
    font-weight: 300;
}

.sts-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1em;
}

.sts-form-section {
    padding: 30px;
    border-bottom: 1px solid #eee;
}

.sts-form-section:last-of-type {
    border-bottom: none;
}

.sts-form-section h3 {
    color: #333;
    margin-bottom: 20px;
    font-size: 1.3em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sts-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.sts-form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
}

.sts-form-group label {
    font-weight: 600;
    margin-bottom: 8px;
    color: #555;
    font-size: 14px;
}

.sts-form-group input,
.sts-form-group select,
.sts-form-group textarea {
    padding: 12px 15px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s ease;
    background: #fff;
}

.sts-form-group input:focus,
.sts-form-group select:focus,
.sts-form-group textarea:focus {
    outline: none;
    border-color: #007cba;
    box-shadow: 0 0 0 3px rgba(0,124,186,0.1);
}

.sts-help-text {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
    font-style: italic;
}

.sts-field-error {
    color: #dc3232;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

.sts-character-count {
    text-align: right;
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

/* File Upload Styles */
.sts-file-upload {
    position: relative;
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    transition: all 0.3s ease;
}

.sts-file-upload:hover {
    border-color: #007cba;
}

.sts-file-upload-label {
    cursor: pointer;
}

.sts-file-upload-label i {
    font-size: 2em;
    color: #007cba;
    margin-bottom: 10px;
}

.sts-file-upload input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.sts-file-list {
    margin-top: 15px;
}

.sts-file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 5px;
}

/* Checkbox Styles */
.sts-checkbox-group {
    margin-bottom: 15px;
}

.sts-checkbox {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    font-weight: normal;
}

.sts-checkbox input {
    margin-right: 10px;
    margin-top: 3px;
}

/* Submit Section */
.sts-submit-section {
    background: #f8f9fa;
    text-align: center;
}

.sts-form-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-bottom: 30px;
}

.sts-submit-btn {
    background: linear-gradient(135deg, #007cba 0%, #005a87 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    position: relative;
    min-width: 160px;
    justify-content: center;
}

.sts-submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,124,186,0.3);
}

.sts-submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.sts-reset-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.sts-reset-btn:hover {
    background: #545b62;
}

.sts-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.sts-support-info {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

.sts-support-info h4 {
    margin: 0 0 10px 0;
    color: #28a745;
    display: flex;
    align-items: center;
    gap: 8px;
}

.sts-support-info p {
    margin: 0;
    color: #666;
    line-height: 1.5;
}

/* Success Message */
.sts-success-message {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
}

.sts-message-icon {
    font-size: 3em;
    color: #28a745;
    margin-bottom: 20px;
}

.sts-ticket-info {
    background: white;
    padding: 15px;
    border-radius: 6px;
    margin: 20px 0;
    border-left: 4px solid #28a745;
}

.sts-new-ticket-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.sts-new-ticket-btn:hover {
    background: #218838;
}

/* Responsive Design */
@media (max-width: 768px) {
    .sts-form-row {
        grid-template-columns: 1fr;
    }
    
    .sts-ticket-page {
        padding: 10px;
    }
    
    .sts-form-section {
        padding: 20px;
    }
    
    .sts-form-actions {
        flex-direction: column;
    }
    
    .sts-submit-btn,
    .sts-reset-btn {
        width: 100%;
        justify-content: center;
    }
}

/* Error States */
.sts-form-group.error input,
.sts-form-group.error select,
.sts-form-group.error textarea {
    border-color: #dc3232;
}

.sts-form-group.error .sts-field-error {
    display: block;
}


File 4: Create assets/ticket-script.js:
jQuery(document).ready(function($) {
    'use strict';

    const ticketForm = {
        init: function() {
            this.bindEvents();
            this.initCharacterCount();
        },

        bindEvents: function() {
            $('#sts-ticket-form').on('submit', this.handleFormSubmit.bind(this));
            $('#sts-ticket_description').on('input', this.updateCharacterCount.bind(this));
            $('#sts_attachments').on('change', this.handleFileSelect.bind(this));
            $('#sts-new-ticket').on('click', this.resetForm.bind(this));
            $('.sts-reset-btn').on('click', this.resetForm.bind(this));
        },

        handleFormSubmit: function(e) {
            e.preventDefault();
            
            if (this.validateForm()) {
                this.submitForm();
            }
        },

        validateForm: function() {
            let isValid = true;
            $('.sts-form-group').removeClass('error');

            // Required fields validation
            $('#sts-ticket-form [required]').each(function() {
                const $field = $(this);
                const $formGroup = $field.closest('.sts-form-group');
                
                if (!$field.val().trim()) {
                    $formGroup.addClass('error');
                    $formGroup.find('.sts-field-error').text('This field is required');
                    isValid = false;
                }
            });

            // Email validation
            const email = $('#sts_customer_email').val();
            if (email && !this.isValidEmail(email)) {
                $('#sts_customer_email').closest('.sts-form-group').addClass('error')
                    .find('.sts-field-error').text('Please enter a valid email address');
                isValid = false;
            }

            // Description length validation
            const description = $('#sts_ticket_description').val();
            if (description && description.length < 50) {
                $('#sts_ticket_description').closest('.sts-form-group').addClass('error')
                    .find('.sts-field-error').text('Description must be at least 50 characters');
                isValid = false;
            }

            return isValid;
        },

        isValidEmail: function(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        },

        submitForm: function() {
            const $submitBtn = $('#sts-submit-btn');
            const $btnText = $submitBtn.find('.sts-btn-text');
            const $spinner = $submitBtn.find('.sts-spinner');
            
            // Show loading state
            $btnText.text('Submitting...');
            $spinner.show();
            $submitBtn.prop('disabled', true);

            const formData = new FormData($('#sts-ticket-form')[0]);
            formData.append('action', 'submit_support_ticket');
            formData.append('nonce', ticket_ajax.nonce);

            $.ajax({
                url: ticket_ajax.ajax_url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: (response) => {
                    if (response.success) {
                        this.showSuccess(response.data.ticket_id);
                    } else {
                        this.showError(response.data.message);
                    }
                },
                error: () => {
                    this.showError('An error occurred. Please try again.');
                },
                complete: () => {
                    $btnText.text('Submit Ticket');
                    $spinner.hide();
                    $submitBtn.prop('disabled', false);
                }
            });
        },

        showSuccess: function(ticketId) {
            $('#sts-ticket-form').hide();
            $('#sts-ticket-id').text(ticketId);
            $('#sts-success-message').show();
        },

        showError: function(message) {
            alert('Error: ' + message);
        },

        initCharacterCount: function() {
            this.updateCharacterCount();
        },

        updateCharacterCount: function() {
            const count = $('#sts_ticket_description').val().length;
            $('#sts_char_count').text(count);
            
            if (count < 50) {
                $('#sts_char_count').css('color', '#dc3232');
            } else {
                $('#sts_char_count').css('color', '#28a745');
            }
        },

        handleFileSelect: function(e) {
            const files = e.target.files;
            const $fileList = $('#sts-file-list');
            $fileList.empty();

            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileItem = $('<div class="sts-file-item"></div>');
                    fileItem.html(`
                        <span>${file.name} (${this.formatFileSize(file.size)})</span>
                        <span class="sts-file-status">Ready to upload</span>
                    `);
                    $fileList.append(fileItem);
                }
            }
        },

        formatFileSize: function(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        resetForm: function() {
            $('#sts-ticket-form')[0].reset();
            $('#sts-file-list').empty();
            $('#sts-success-message').hide();
            $('#sts-ticket-form').show();
            $('.sts-form-group').removeClass('error');
            this.updateCharacterCount();
        }
    };

    // Initialize the ticket form
    ticketForm.init();
});


File 5: create uninstall.php:
<?php
/**
 * Support Ticket System Uninstaller
 * 
 * Fired when the plugin is uninstalled. Removes all plugin data, options, 
 * custom tables, and uploaded files to ensure complete cleanup.
 * 
 * @package SupportTicketSystem
 */

// Prevent direct access
if (!defined('WP_UNINSTALL_PLUGIN')) {
    exit;
}

// Prevent unauthorized access
if (!current_user_can('activate_plugins')) {
    wp_die('You do not have permission to uninstall this plugin.');
}

// Security check - verify the plugin is being uninstalled from the correct location
$plugin_file = 'support-ticket-system/support-ticket-system.php';
if (plugin_basename(__FILE__) !== $plugin_file && $_REQUEST['plugin'] !== $plugin_file) {
    wp_die('Invalid uninstall request.');
}

/**
 * Support Ticket System Uninstall Class
 */
class STS_Uninstaller {
    
    private $wpdb;
    private $upload_dir;
    
    public function __construct() {
        global $wpdb;
        $this->wpdb = $wpdb;
        $this->upload_dir = wp_upload_dir();
        
        $this->cleanup_database();
        $this->cleanup_options();
        $this->cleanup_custom_tables();
        $this->cleanup_uploaded_files();
        $this->cleanup_cron_jobs();
        $this->clear_caches();
        $this->log_uninstall();
    }
    
    /**
     * Clean up all database entries
     */
    private function cleanup_database() {
        // Delete all support ticket custom post types
        $tickets = get_posts(array(
            'post_type' => array('support_ticket', 'sts_ticket'),
            'numberposts' => -1,
            'post_status' => 'any',
            'fields' => 'ids'
        ));
        
        foreach ($tickets as $ticket_id) {
            wp_delete_post($ticket_id, true);
        }
        
        // Delete all ticket replies/comments
        $comments = get_comments(array(
            'type' => 'sts_reply',
            'number' => 0,
            'fields' => 'ids'
        ));
        
        foreach ($comments as $comment_id) {
            wp_delete_comment($comment_id, true);
        }
        
        // Clean up user meta related to the plugin
        $users = get_users(array(
            'fields' => 'ids',
            'meta_query' => array(
                array(
                    'key' => 'sts_',
                    'compare' => 'EXISTS'
                )
            )
        ));
        
        foreach ($users as $user_id) {
            // Delete all user meta starting with 'sts_'
            $user_meta = get_user_meta($user_id);
            foreach ($user_meta as $meta_key => $meta_value) {
                if (strpos($meta_key, 'sts_') === 0) {
                    delete_user_meta($user_id, $meta_key);
                }
            }
        }
    }
    
    /**
     * Clean up all plugin options
     */
    private function cleanup_options() {
        // Main plugin options
        $options = array(
            // Settings options
            'sts_settings',
            'sts_license_settings',
            'sts_email_settings',
            'sts_general_settings',
            'sts_advanced_settings',
            
            // License and activation
            'sts_license_key',
            'sts_license_status',
            'sts_activation_data',
            'sts_license_expires',
            'sts_domain_active',
            
            // Version and setup
            'sts_version',
            'sts_db_version',
            'sts_install_date',
            'sts_activation_date',
            
            // Temporary data
            'sts_setup_wizard',
            'sts_welcome_dismissed',
            'sts_review_dismissed',
            
            // Statistics and analytics
            'sts_ticket_stats',
            'sts_performance_data',
            'sts_usage_stats',
            'sts_dashboard_data',
        );
        
        foreach ($options as $option) {
            delete_option($option);
            delete_site_option($option); // For multisite
        }
        
        // Clean up network options in multisite
        if (is_multisite()) {
            $sites = get_sites();
            foreach ($sites as $site) {
                switch_to_blog($site->blog_id);
                
                foreach ($options as $option) {
                    delete_option($option);
                }
                
                restore_current_blog();
            }
        }
    }
    
    /**
     * Clean up transients and cached data
     */
    private function cleanup_transients() {
        $transients = array(
            // License and update transients
            'sts_license_check',
            'sts_update_check',
            'sts_remote_data',
            
            // Statistics transients
            'sts_ticket_count',
            'sts_open_tickets',
            'sts_closed_tickets',
            'sts_response_time',
            
            // Dashboard transients
            'sts_dashboard_widget',
            'sts_recent_tickets',
            'sts_activity_log',
            
            // System transients
            'sts_system_status',
            'sts_debug_info',
            'sts_performance_cache',
        );
        
        foreach ($transients as $transient) {
            delete_transient($transient);
            delete_site_transient($transient); // For multisite
        }
        
        // Clean up all transients with sts prefix
        $this->wpdb->query(
            "DELETE FROM {$this->wpdb->options} 
            WHERE option_name LIKE '_transient_sts_%' 
            OR option_name LIKE '_transient_timeout_sts_%'"
        );
        
        // For multisite
        $this->wpdb->query(
            "DELETE FROM {$this->wpdb->sitemeta} 
            WHERE meta_key LIKE '_site_transient_sts_%' 
            OR meta_key LIKE '_site_transient_timeout_sts_%'"
        );
    }
    
    /**
     * Clean up custom database tables
     */
    private function cleanup_custom_tables() {
        $tables = array(
            $this->wpdb->prefix . 'sts_tickets',
            $this->wpdb->prefix . 'sts_ticket_meta',
            $this->wpdb->prefix . 'sts_ticket_replies',
            $this->wpdb->prefix . 'sts_attachments',
            $this->wpdb->prefix . 'sts_customers',
            $this->wpdb->prefix . 'sts_products',
            $this->wpdb->prefix . 'sts_licenses',
            $this->wpdb->prefix . 'sts_activity_log',
            $this->wpdb->prefix . 'sts_email_queue',
            $this->wpdb->prefix . 'sts_sessions',
        );
        
        foreach ($tables as $table) {
            if ($this->wpdb->get_var("SHOW TABLES LIKE '$table'") === $table) {
                $this->wpdb->query("DROP TABLE IF EXISTS $table");
            }
        }
        
        // Clean up multisite tables
        if (is_multisite()) {
            $sites = get_sites();
            foreach ($sites as $site) {
                $blog_prefix = $this->wpdb->get_blog_prefix($site->blog_id);
                
                $multisite_tables = array(
                    $blog_prefix . 'sts_tickets',
                    $blog_prefix . 'sts_ticket_meta',
                );
                
                foreach ($multisite_tables as $table) {
                    if ($this->wpdb->get_var("SHOW TABLES LIKE '$table'") === $table) {
                        $this->wpdb->query("DROP TABLE IF EXISTS $table");
                    }
                }
            }
        }
    }
    
    /**
     * Clean up uploaded files and directories
     */
    private function cleanup_uploaded_files() {
        $upload_dirs = array(
            $this->upload_dir['basedir'] . '/support-tickets/',
            $this->upload_dir['basedir'] . '/sts-attachments/',
            $this->upload_dir['basedir'] . '/ticket-uploads/',
            $this->upload_dir['basedir'] . '/sts-logs/',
            $this->upload_dir['basedir'] . '/sts-exports/',
            $this->upload_dir['basedir'] . '/sts-temp/',
        );
        
        foreach ($upload_dirs as $dir) {
            if (file_exists($dir)) {
                $this->delete_directory($dir);
            }
        }
        
        // Clean up any .htaccess files created by the plugin
        $htaccess_files = array(
            $this->upload_dir['basedir'] . '/support-tickets/.htaccess',
            $this->upload_dir['basedir'] . '/sts-attachments/.htaccess',
        );
        
        foreach ($htaccess_files as $file) {
            if (file_exists($file)) {
                @unlink($file);
            }
        }
    }
    
    /**
     * Clean up scheduled cron jobs
     */
    private function cleanup_cron_jobs() {
        $cron_hooks = array(
            'sts_daily_maintenance',
            'sts_license_check',
            'sts_stats_cleanup',
            'sts_email_digest',
            'sts_auto_close_tickets',
            'sts_backup_tickets',
            'sts_performance_optimization',
        );
        
        foreach ($cron_hooks as $hook) {
            wp_clear_scheduled_hook($hook);
            
            // Clear all scheduled events for this hook
            $cron = get_option('cron');
            if (!empty($cron)) {
                foreach ($cron as $timestamp => $cronhooks) {
                    if (isset($cronhooks[$hook])) {
                        unset($cron[$timestamp][$hook]);
                    }
                }
                update_option('cron', $cron);
            }
        }
    }
    
    /**
     * Clear various caches
     */
    private function clear_caches() {
        // Clear WordPress object cache
        wp_cache_flush();
        
        // Clear popular caching plugins
        $this->clear_caching_plugins();
        
        // Clear rewrite rules
        flush_rewrite_rules();
    }
    
    /**
     * Clear popular caching plugins
     */
    private function clear_caching_plugins() {
        // W3 Total Cache
        if (function_exists('w3tc_flush_all')) {
            w3tc_flush_all();
        }
        
        // WP Super Cache
        if (function_exists('wp_cache_clear_cache')) {
            wp_cache_clear_cache();
        }
        
        // WP Rocket
        if (function_exists('rocket_clean_domain')) {
            rocket_clean_domain();
        }
        
        // LiteSpeed Cache
        if (class_exists('LiteSpeed_Cache_API')) {
            LiteSpeed_Cache_API::purge_all();
        }
        
        // Hummingbird
        if (class_exists('Hummingbird\\WP_Hummingbird')) {
            do_action('wphb_clear_page_cache');
        }
        
        // Autoptimize
        if (class_exists('autoptimizeCache')) {
            autoptimizeCache::clearall();
        }
        
        // WP Optimize
        if (class_exists('WP_Optimize')) {
            WP_Optimize()->get_page_cache()->purge();
        }
        
        // Cache Enabler
        if (has_action('ce_clear_cache')) {
            do_action('ce_clear_cache');
        }
        
        // Comet Cache
        if (class_exists('comet_cache')) {
            comet_cache::clear();
        }
        
        // Hyper Cache
        if (class_exists('HyperCache')) {
            do_action('hyper_cache_clean');
        }
    }
    
    /**
     * Log uninstall for debugging (optional)
     */
    private function log_uninstall() {
        // Only log if debugging is enabled
        if (defined('WP_DEBUG') && WP_DEBUG) {
            $log_entry = sprintf(
                "Support Ticket System uninstalled on %s by user %s from IP %s",
                current_time('mysql'),
                get_current_user_id(),
                $_SERVER['REMOTE_ADDR'] ?? 'unknown'
            );
            
            error_log($log_entry);
        }
    }
    
    /**
     * Recursively delete a directory
     */
    private function delete_directory($dir) {
        if (!file_exists($dir)) {
            return true;
        }
        
        if (!is_dir($dir)) {
            return unlink($dir);
        }
        
        foreach (scandir($dir) as $item) {
            if ($item == '.' || $item == '..') {
                continue;
            }
            
            if (!$this->delete_directory($dir . DIRECTORY_SEPARATOR . $item)) {
                return false;
            }
        }
        
        return rmdir($dir);
    }
}

/**
 * Check if we should remove all data or keep it
 */
$remove_all_data = true; // Set to false if you want to keep data

if ($remove_all_data) {
    // Initialize the uninstaller
    new STS_Uninstaller();
    
    // Final cleanup of any remaining options
    $final_cleanup_options = array(
        'sts_uninstall_time',
        'sts_last_backup',
        'sts_migration_data',
    );
    
    foreach ($final_cleanup_options as $option) {
        delete_option($option);
        delete_site_option($option);
    }
}

// Display success message (only in CLI or with debugging)
if (defined('WP_CLI') && WP_CLI) {
    WP_CLI::success('Support Ticket System has been completely uninstalled and all data removed.');
}
