<?php
/**
 * Plugin Name: Support Ticket System
 * Description: A complete support ticket system for OrderSoftwareKeys
 * Version: 1.0.0
 * Author: OrderSoftwareKeys
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// Define plugin constants
define('OSK_SUPPORT_VERSION', '1.0.0');
define('OSK_SUPPORT_POST_TYPE', 'osk_support_ticket');

/**
 * Main plugin class
 */
class OSK_Support_System {
    
    /**
     * Constructor
     */
    public function __construct() {
        add_action('init', array($this, 'register_post_type'));
        add_action('init', array($this, 'register_taxonomies'));
        add_action('add_meta_boxes', array($this, 'add_meta_boxes'));
        add_action('save_post', array($this, 'save_ticket_meta'));
        add_action('wp_enqueue_scripts', array($this, 'enqueue_scripts'));
        add_action('admin_enqueue_scripts', array($this, 'admin_enqueue_scripts'));
        add_shortcode('osk_support_form', array($this, 'render_support_form'));
        add_shortcode('osk_support_dashboard', array($this, 'render_support_dashboard'));
        add_filter('template_include', array($this, 'template_include'));
        add_action('wp_ajax_osk_submit_ticket', array($this, 'ajax_submit_ticket'));
        add_action('wp_ajax_nopriv_osk_submit_ticket', array($this, 'ajax_submit_ticket'));
        add_action('wp_ajax_osk_upload_file', array($this, 'ajax_upload_file'));
        add_action('wp_ajax_nopriv_osk_upload_file', array($this, 'ajax_upload_file'));
        add_action('wp_ajax_osk_add_reply', array($this, 'ajax_add_reply'));
        add_action('wp_ajax_nopriv_osk_add_reply', array($this, 'ajax_add_reply'));
        
        // Activation hook
        register_activation_hook(__FILE__, array($this, 'activate'));
        
        // Rewrite rules for ticket pages
        add_action('init', array($this, 'add_rewrite_rules'));
        add_filter('query_vars', array($this, 'add_query_vars'));
    }
    
    /**
     * Plugin activation
     */
    public function activate() {
        $this->register_post_type();
        $this->register_taxonomies();
        flush_rewrite_rules();
        
        // Create default pages if they don't exist
        $this->create_default_pages();
    }
    
    /**
     * Create default pages
     */
    private function create_default_pages() {
        // Create support dashboard page
        if (!get_page_by_path('requests')) {
            $dashboard_page = array(
                'post_title'    => 'Support Dashboard',
                'post_content'  => '[osk_support_dashboard]',
                'post_status'   => 'publish',
                'post_author'   => 1,
                'post_type'     => 'page',
                'post_name'     => 'requests'
            );
            wp_insert_post($dashboard_page);
        }
        
        // Create submit ticket page
        if (!get_page_by_path('submit-ticket')) {
            $submit_page = array(
                'post_title'    => 'Submit Ticket',
                'post_content'  => '[osk_support_form]',
                'post_status'   => 'publish',
                'post_author'   => 1,
                'post_type'     => 'page',
                'post_name'     => 'submit-ticket'
            );
            wp_insert_post($submit_page);
        }
    }
    
    /**
     * Register custom post type for tickets
     */
    public function register_post_type() {
        $labels = array(
            'name'                  => _x('Support Tickets', 'Post type general name', 'osk-support'),
            'singular_name'         => _x('Support Ticket', 'Post type singular name', 'osk-support'),
            'menu_name'             => _x('Support Tickets', 'Admin Menu text', 'osk-support'),
            'name_admin_bar'        => _x('Support Ticket', 'Add New on Toolbar', 'osk-support'),
            'add_new'               => __('Add New', 'osk-support'),
            'add_new_item'          => __('Add New Ticket', 'osk-support'),
            'new_item'              => __('New Ticket', 'osk-support'),
            'edit_item'             => __('Edit Ticket', 'osk-support'),
            'view_item'             => __('View Ticket', 'osk-support'),
            'all_items'             => __('All Tickets', 'osk-support'),
            'search_items'          => __('Search Tickets', 'osk-support'),
            'parent_item_colon'     => __('Parent Tickets:', 'osk-support'),
            'not_found'             => __('No tickets found.', 'osk-support'),
            'not_found_in_trash'    => __('No tickets found in Trash.', 'osk-support'),
            'featured_image'        => _x('Ticket Cover Image', 'Overrides the "Featured Image" phrase for this post type.', 'osk-support'),
            'set_featured_image'    => _x('Set cover image', 'Overrides the "Set featured image" phrase for this post type.', 'osk-support'),
            'remove_featured_image' => _x('Remove cover image', 'Overrides the "Remove featured image" phrase for this post type.', 'osk-support'),
            'use_featured_image'    => _x('Use as cover image', 'Overrides the "Use as featured image" phrase for this post type.', 'osk-support'),
            'archives'              => _x('Ticket archives', 'The post type archive label used in nav menus.', 'osk-support'),
            'insert_into_item'      => _x('Insert into ticket', 'Overrides the "Insert into post" phrase for this post type.', 'osk-support'),
            'uploaded_to_this_item' => _x('Uploaded to this ticket', 'Overrides the "Uploaded to this post" phrase for this post type.', 'osk-support'),
            'filter_items_list'     => _x('Filter tickets list', 'Screen reader text for the filter links heading on the post type listing screen.', 'osk-support'),
            'items_list_navigation' => _x('Tickets list navigation', 'Screen reader text for the pagination heading on the post type listing screen.', 'osk-support'),
            'items_list'            => _x('Tickets list', 'Screen reader text for the items list heading on the post type listing screen.', 'osk-support'),
        );
        
        $args = array(
            'labels'             => $labels,
            'public'             => true,
            'publicly_queryable' => true,
            'show_ui'            => true,
            'show_in_menu'       => true,
            'query_var'          => true,
            'rewrite'            => array('slug' => 'requests'),
            'capability_type'    => 'post',
            'has_archive'        => false,
            'hierarchical'       => false,
            'menu_position'      => 25,
            'menu_icon'          => 'dashicons-sos',
            'supports'           => array('title', 'editor', 'author', 'comments'),
            'show_in_rest'       => true,
        );
        
        register_post_type(OSK_SUPPORT_POST_TYPE, $args);
    }
    
    /**
     * Register taxonomies
     */
    public function register_taxonomies() {
        // Ticket status taxonomy
        $labels = array(
            'name'              => _x('Ticket Statuses', 'taxonomy general name', 'osk-support'),
            'singular_name'     => _x('Ticket Status', 'taxonomy singular name', 'osk-support'),
            'search_items'      => __('Search Statuses', 'osk-support'),
            'all_items'         => __('All Statuses', 'osk-support'),
            'parent_item'       => __('Parent Status', 'osk-support'),
            'parent_item_colon' => __('Parent Status:', 'osk-support'),
            'edit_item'         => __('Edit Status', 'osk-support'),
            'update_item'       => __('Update Status', 'osk-support'),
            'add_new_item'      => __('Add New Status', 'osk-support'),
            'new_item_name'     => __('New Status Name', 'osk-support'),
            'menu_name'         => __('Status', 'osk-support'),
        );
        
        $args = array(
            'hierarchical'      => false,
            'labels'            => $labels,
            'show_ui'           => true,
            'show_admin_column' => true,
            'query_var'         => true,
            'rewrite'           => array('slug' => 'ticket-status'),
            'show_in_rest'      => true,
        );
        
        register_taxonomy('ticket_status', OSK_SUPPORT_POST_TYPE, $args);
        
        // Create default statuses
        if (!term_exists('Open', 'ticket_status')) {
            wp_insert_term('Open', 'ticket_status');
            wp_insert_term('Pending', 'ticket_status');
            wp_insert_term('Closed', 'ticket_status');
        }
        
        // Ticket priority taxonomy
        $labels = array(
            'name'              => _x('Ticket Priorities', 'taxonomy general name', 'osk-support'),
            'singular_name'     => _x('Ticket Priority', 'taxonomy singular name', 'osk-support'),
            'search_items'      => __('Search Priorities', 'osk-support'),
            'all_items'         => __('All Priorities', 'osk-support'),
            'parent_item'       => __('Parent Priority', 'osk-support'),
            'parent_item_colon' => __('Parent Priority:', 'osk-support'),
            'edit_item'         => __('Edit Priority', 'osk-support'),
            'update_item'       => __('Update Priority', 'osk-support'),
            'add_new_item'      => __('Add New Priority', 'osk-support'),
            'new_item_name'     => __('New Priority Name', 'osk-support'),
            'menu_name'         => __('Priority', 'osk-support'),
        );
        
        $args = array(
            'hierarchical'      => false,
            'labels'            => $labels,
            'show_ui'           => true,
            'show_admin_column' => true,
            'query_var'         => true,
            'rewrite'           => array('slug' => 'ticket-priority'),
            'show_in_rest'      => true,
        );
        
        register_taxonomy('ticket_priority', OSK_SUPPORT_POST_TYPE, $args);
        
        // Create default priorities
        if (!term_exists('Low', 'ticket_priority')) {
            wp_insert_term('Low', 'ticket_priority');
            wp_insert_term('Medium', 'ticket_priority');
            wp_insert_term('High', 'ticket_priority');
            wp_insert_term('Urgent', 'ticket_priority');
        }
        
        // Ticket category taxonomy
        $labels = array(
            'name'              => _x('Ticket Categories', 'taxonomy general name', 'osk-support'),
            'singular_name'     => _x('Ticket Category', 'taxonomy singular name', 'osk-support'),
            'search_items'      => __('Search Categories', 'osk-support'),
            'all_items'         => __('All Categories', 'osk-support'),
            'parent_item'       => __('Parent Category', 'osk-support'),
            'parent_item_colon' => __('Parent Category:', 'osk-support'),
            'edit_item'         => __('Edit Category', 'osk-support'),
            'update_item'       => __('Update Category', 'osk-support'),
            'add_new_item'      => __('Add New Category', 'osk-support'),
            'new_item_name'     => __('New Category Name', 'osk-support'),
            'menu_name'         => __('Category', 'osk-support'),
        );
        
        $args = array(
            'hierarchical'      => true,
            'labels'            => $labels,
            'show_ui'           => true,
            'show_admin_column' => true,
            'query_var'         => true,
            'rewrite'           => array('slug' => 'ticket-category'),
            'show_in_rest'      => true,
        );
        
        register_taxonomy('ticket_category', OSK_SUPPORT_POST_TYPE, $args);
        
        // Create default categories
        if (!term_exists('Technical Support', 'ticket_category')) {
            wp_insert_term('Technical Support', 'ticket_category');
            wp_insert_term('Billing', 'ticket_category');
            wp_insert_term('Account', 'ticket_category');
        }
    }
    
    /**
     * Add meta boxes for ticket information
     */
    public function add_meta_boxes() {
        add_meta_box(
            'osk_ticket_details',
            __('Ticket Details', 'osk-support'),
            array($this, 'render_ticket_details_meta_box'),
            OSK_SUPPORT_POST_TYPE,
            'normal',
            'high'
        );
        
        add_meta_box(
            'osk_customer_info',
            __('Customer Information', 'osk-support'),
            array($this, 'render_customer_info_meta_box'),
            OSK_SUPPORT_POST_TYPE,
            'side',
            'default'
        );
    }
    
    /**
     * Render ticket details meta box
     */
    public function render_ticket_details_meta_box($post) {
        // Add nonce for security
        wp_nonce_field('osk_save_ticket_meta', 'osk_ticket_meta_nonce');
        
        // Get current values
        $order_number = get_post_meta($post->ID, '_osk_order_number', true);
        $product = get_post_meta($post->ID, '_osk_product', true);
        
        // Output HTML
        echo '<div class="osk-meta-field">';
        echo '<label for="osk_order_number">' . __('Order Number:', 'osk-support') . '</label>';
        echo '<input type="text" id="osk_order_number" name="osk_order_number" value="' . esc_attr($order_number) . '" class="widefat">';
        echo '</div>';
        
        echo '<div class="osk-meta-field">';
        echo '<label for="osk_product">' . __('Product:', 'osk-support') . '</label>';
        echo '<select id="osk_product" name="osk_product" class="widefat">';
        echo '<option value="">' . __('Select a product', 'osk-support') . '</option>';
        echo '<option value="adobe" ' . selected($product, 'adobe', false) . '>' . __('Adobe Creative Cloud', 'osk-support') . '</option>';
        echo '<option value="autodesk" ' . selected($product, 'autodesk', false) . '>' . __('Autodesk AutoCAD', 'osk-support') . '</option>';
        echo '<option value="msoffice" ' . selected($product, 'msoffice', false) . '>' . __('Microsoft Office', 'osk-support') . '</option>';
        echo '<option value="norton" ' . selected($product, 'norton', false) . '>' . __('Norton Antivirus', 'osk-support') . '</option>';
        echo '<option value="kaspersky" ' . selected($product, 'kaspersky', false) . '>' . __('Kaspersky Internet Security', 'osk-support') . '</option>';
        echo '<option value="other" ' . selected($product, 'other', false) . '>' . __('Other Software', 'osk-support') . '</option>';
        echo '</select>';
        echo '</div>';
    }
    
    /**
     * Render customer information meta box
     */
    public function render_customer_info_meta_box($post) {
        // Get current values
        $customer_name = get_post_meta($post->ID, '_osk_customer_name', true);
        $customer_email = get_post_meta($post->ID, '_osk_customer_email', true);
        $customer_phone = get_post_meta($post->ID, '_osk_customer_phone', true);
        
        // Output HTML
        echo '<div class="osk-meta-field">';
        echo '<label for="osk_customer_name">' . __('Customer Name:', 'osk-support') . '</label>';
        echo '<input type="text" id="osk_customer_name" name="osk_customer_name" value="' . esc_attr($customer_name) . '" class="widefat">';
        echo '</div>';
        
        echo '<div class="osk-meta-field">';
        echo '<label for="osk_customer_email">' . __('Customer Email:', 'osk-support') . '</label>';
        echo '<input type="email" id="osk_customer_email" name="osk_customer_email" value="' . esc_attr($customer_email) . '" class="widefat">';
        echo '</div>';
        
        echo '<div class="osk-meta-field">';
        echo '<label for="osk_customer_phone">' . __('Customer Phone:', 'osk-support') . '</label>';
        echo '<input type="text" id="osk_customer_phone" name="osk_customer_phone" value="' . esc_attr($customer_phone) . '" class="widefat">';
        echo '</div>';
    }
    
    /**
     * Save ticket meta data
     */
    public function save_ticket_meta($post_id) {
        // Check if our nonce is set
        if (!isset($_POST['osk_ticket_meta_nonce']) || !wp_verify_nonce($_POST['osk_ticket_meta_nonce'], 'osk_save_ticket_meta')) {
            return;
        }
        
        // Check if the current user has permission to edit the post
        if (!current_user_can('edit_post', $post_id)) {
            return;
        }
        
        // Check if this is an autosave
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
            return;
        }
        
        // Save the data
        if (isset($_POST['osk_order_number'])) {
            update_post_meta($post_id, '_osk_order_number', sanitize_text_field($_POST['osk_order_number']));
        }
        
        if (isset($_POST['osk_product'])) {
            update_post_meta($post_id, '_osk_product', sanitize_text_field($_POST['osk_product']));
        }
        
        if (isset($_POST['osk_customer_name'])) {
            update_post_meta($post_id, '_osk_customer_name', sanitize_text_field($_POST['osk_customer_name']));
        }
        
        if (isset($_POST['osk_customer_email'])) {
            update_post_meta($post_id, '_osk_customer_email', sanitize_email($_POST['osk_customer_email']));
        }
        
        if (isset($_POST['osk_customer_phone'])) {
            update_post_meta($post_id, '_osk_customer_phone', sanitize_text_field($_POST['osk_customer_phone']));
        }
    }
    
    /**
     * Enqueue frontend scripts and styles
     */
    public function enqueue_scripts() {
        // Inline CSS
        $css = $this->get_frontend_css();
        wp_register_style('osk-support-frontend', false);
        wp_enqueue_style('osk-support-frontend');
        wp_add_inline_style('osk-support-frontend', $css);
        
        // Inline JavaScript
        $js = $this->get_frontend_js();
        wp_register_script('osk-support-frontend', false, array('jquery'));
        wp_enqueue_script('osk-support-frontend');
        wp_add_inline_script('osk-support-frontend', $js);
        
        // Localize script
        wp_localize_script('osk-support-frontend', 'osk_support', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('osk_support_nonce'),
            'strings' => array(
                'loading' => __('Loading...', 'osk-support'),
                'error' => __('An error occurred. Please try again.', 'osk-support'),
                'success' => __('Success!', 'osk-support'),
                'confirm_close' => __('Are you sure you want to close this ticket?', 'osk-support'),
            )
        ));
    }
    
    /**
     * Enqueue admin scripts and styles
     */
    public function admin_enqueue_scripts($hook) {
        global $post_type;
        
        if ($post_type === OSK_SUPPORT_POST_TYPE) {
            // Inline CSS
            $css = $this->get_admin_css();
            wp_register_style('osk-support-admin', false);
            wp_enqueue_style('osk-support-admin');
            wp_add_inline_style('osk-support-admin', $css);
            
            // Inline JavaScript
            $js = $this->get_admin_js();
            wp_register_script('osk-support-admin', false, array('jquery'));
            wp_enqueue_script('osk-support-admin');
            wp_add_inline_script('osk-support-admin', $js);
        }
    }
    
    /**
     * Get frontend CSS
     */
    private function get_frontend_css() {
        ob_start();
        ?>
        :root {
            --primary: #4A6CF7;
            --primary-dark: #3451DB;
            --secondary: #F7F8FC;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --border: #E2E8F0;
            --success: #48BB78;
            --warning: #ED8936;
            --danger: #F56565;
            --info: #4299E1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: #F7FAFC;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .osk-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .osk-page-title {
            text-align: center;
            margin: 30px 0;
            color: var(--text-primary);
        }

        .osk-page-title h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .osk-page-title p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .osk-ticket-form-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 40px;
        }

        .osk-form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }

        .osk-form-group {
            flex: 1;
            min-width: 300px;
            padding: 0 15px;
            margin-bottom: 20px;
        }

        .osk-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .osk-form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .osk-form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
        }

        select.osk-form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }

        textarea.osk-form-control {
            min-height: 120px;
            resize: vertical;
        }

        .osk-upload-area {
            border: 2px dashed var(--primary);
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            background-color: var(--secondary);
            transition: all 0.3s;
            cursor: pointer;
        }

        .osk-upload-area:hover {
            background-color: #e8f4fd;
        }

        .osk-upload-area i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .osk-upload-area h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .osk-upload-area p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .osk-btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
        }

        .osk-btn:hover {
            background: var(--primary-dark);
        }

        .osk-btn-block {
            display: block;
            width: 100%;
        }

        .osk-btn-upload {
            background: var(--success);
        }

        .osk-btn-upload:hover {
            background: #27ae60;
        }

        .osk-form-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .osk-form-footer p {
            color: var(--text-secondary);
        }

        .osk-form-footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .osk-file-list {
            margin-top: 15px;
        }

        .osk-file-item {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .osk-file-item i {
            color: var(--primary);
            margin-right: 10px;
        }

        .osk-file-name {
            flex: 1;
        }

        .osk-file-remove {
            color: var(--danger);
            cursor: pointer;
        }

        .osk-ticket-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .osk-stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .osk-stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
        }

        .osk-stat-blue {
            background-color: rgba(74, 108, 247, 0.1);
            color: var(--primary);
        }

        .osk-stat-orange {
            background-color: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .osk-stat-green {
            background-color: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }

        .osk-stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .osk-stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .osk-ticket-list {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .osk-ticket-list-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .osk-ticket-list-title {
            font-size: 18px;
            font-weight: 600;
        }

        .osk-ticket-list-body {
            padding: 0;
        }

        .osk-ticket-item {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .osk-ticket-item:hover {
            background-color: var(--secondary);
        }

        .osk-ticket-item:last-child {
            border-bottom: none;
        }

        .osk-ticket-id {
            font-weight: 600;
            color: var(--primary);
            margin-right: 15px;
            min-width: 100px;
        }

        .osk-ticket-subject {
            flex: 1;
            font-weight: 500;
        }

        .osk-ticket-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-right: 15px;
            min-width: 80px;
            text-align: center;
        }

        .osk-status-open {
            background-color: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }

        .osk-status-pending {
            background-color: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .osk-status-closed {
            background-color: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }

        .osk-ticket-date {
            color: var(--text-secondary);
            font-size: 14px;
            min-width: 100px;
            text-align: right;
        }

        .osk-ticket-detail-container {
            display: flex;
            gap: 20px;
        }

        .osk-ticket-conversation {
            flex: 2;
        }

        .osk-ticket-sidebar {
            flex: 1;
            max-width: 350px;
        }

        .osk-conversation-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .osk-conversation-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .osk-conversation-meta {
            display: flex;
            gap: 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .osk-conversation-messages {
            padding: 20px;
        }

        .osk-message {
            margin-bottom: 20px;
            display: flex;
        }

        .osk-message.agent {
            flex-direction: row-reverse;
        }

        .osk-message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 15px;
        }

        .osk-message-content {
            max-width: 70%;
        }

        .osk-message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .osk-message.agent .osk-message-header {
            justify-content: flex-end;
        }

        .osk-message-name {
            font-weight: 600;
            margin-right: 8px;
        }

        .osk-message-time {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .osk-message-bubble {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: 8px;
        }

        .osk-message.agent .osk-message-bubble {
            background-color: var(--primary);
            color: white;
        }

        .osk-message-text {
            margin-bottom: 10px;
        }

        .osk-message-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .osk-attachment {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            border: 1px solid var(--border);
        }

        .osk-attachment i {
            margin-right: 8px;
            color: var(--primary);
        }

        .osk-message-reply {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .osk-reply-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .osk-reply-textarea {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .osk-reply-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .osk-reply-options {
            display: flex;
            gap: 10px;
        }

        .osk-ticket-info {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .osk-info-header {
            padding: 15px 20px;
            background-color: var(--secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .osk-info-body {
            padding: 20px;
        }

        .osk-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .osk-info-row:last-child {
            border-bottom: none;
        }

        .osk-info-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .osk-info-value {
            font-weight: 500;
        }

        .osk-ticket-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .osk-action-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .osk-action-btn:hover {
            background-color: var(--secondary);
        }

        .osk-action-btn i {
            margin-right: 10px;
            color: var(--text-secondary);
        }

        .osk-empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .osk-empty-state-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .osk-empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .osk-empty-state-text {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .osk-alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .osk-alert-success {
            background-color: rgba(72, 187, 120, 0.1);
            color: var(--success);
            border: 1px solid rgba(72, 187, 120, 0.2);
        }

        .osk-alert-error {
            background-color: rgba(245, 101, 101, 0.1);
            color: var(--danger);
            border: 1px solid rgba(245, 101, 101, 0.2);
        }

        .osk-back-link {
            display: inline-flex;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 20px;
        }

        .osk-back-link i {
            margin-right: 8px;
        }

        .osk-back-link:hover {
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .osk-form-group {
                min-width: 100%;
            }
            
            .osk-ticket-stats {
                grid-template-columns: 1fr;
            }
            
            .osk-ticket-detail-container {
                flex-direction: column;
            }
            
            .osk-ticket-sidebar {
                max-width: 100%;
            }
            
            .osk-message-content {
                max-width: 85%;
            }
        }
        <?php
        return ob_get_clean();
    }
    
    /**
     * Get frontend JavaScript
     */
    private function get_frontend_js() {
        ob_start();
        ?>
        jQuery(document).ready(function($) {
            // File upload functionality
            const uploadArea = $('#oskUploadArea');
            const fileInput = $('#oskFileInput');
            const fileList = $('#oskFileList');
            const ticketForm = $('#oskTicketForm');
            
            let uploadedFiles = [];
            
            // Upload area click event
            uploadArea.on('click', function() {
                fileInput.click();
            });
            
            // File input change event
            fileInput.on('change', function(e) {
                handleFiles(e.target.files);
            });
            
            // Drag and drop functionality
            uploadArea.on('dragover', function(e) {
                e.preventDefault();
                uploadArea.css('backgroundColor', '#e1f0ff');
                uploadArea.css('borderColor', '#2980b9');
            });
            
            uploadArea.on('dragleave', function() {
                uploadArea.css('backgroundColor', '#F7F8FC');
                uploadArea.css('borderColor', '#4A6CF7');
            });
            
            uploadArea.on('drop', function(e) {
                e.preventDefault();
                uploadArea.css('backgroundColor', '#F7F8FC');
                uploadArea.css('borderColor', '#4A6CF7');
                
                if (e.originalEvent.dataTransfer.files.length) {
                    handleFiles(e.originalEvent.dataTransfer.files);
                }
            });
            
            // Handle selected files
            function handleFiles(files) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Check file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                        continue;
                    }
                    
                    // Check if we already have 5 files
                    if (uploadedFiles.length >= 5) {
                        alert('Maximum of 5 files allowed.');
                        break;
                    }
                    
                    // Upload file via AJAX
                    const formData = new FormData();
                    formData.append('action', 'osk_upload_file');
                    formData.append('nonce', osk_support.nonce);
                    formData.append('file', file);
                    
                    $.ajax({
                        url: osk_support.ajax_url,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                uploadedFiles.push(response.data.attachment_id);
                                displayFile(response.data.attachment_id, response.data.filename);
                            } else {
                                alert(response.data.message || osk_support.strings.error);
                            }
                        },
                        error: function() {
                            alert(osk_support.strings.error);
                        }
                    });
                }
                
                // Reset file input
                fileInput.val('');
            }
            
            // Display file in the list
            function displayFile(attachmentId, filename) {
                const fileItem = $('<div class="osk-file-item"></div>');
                
                fileItem.html(`
                    <i class="fas fa-file"></i>
                    <div class="osk-file-name">${filename}</div>
                    <div class="osk-file-remove" data-attachment-id="${attachmentId}">
                        <i class="fas fa-times"></i>
                    </div>
                `);
                
                fileList.append(fileItem);
                
                // Add remove event
                const removeBtn = fileItem.find('.osk-file-remove');
                removeBtn.on('click', function() {
                    const attachmentId = $(this).data('attachment-id');
                    uploadedFiles = uploadedFiles.filter(id => id !== attachmentId);
                    fileItem.remove();
                });
            }
            
            // Form submission
            ticketForm.on('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitBtn = $('#oskSubmitTicket');
                const btnText = submitBtn.find('.osk-btn-text');
                const btnLoading = submitBtn.find('.osk-btn-loading');
                
                btnText.hide();
                btnLoading.show();
                submitBtn.prop('disabled', true);
                
                // Get form data
                const formData = {
                    action: 'osk_submit_ticket',
                    nonce: osk_support.nonce,
                    order_number: $('#oskOrderNumber').val(),
                    customer_name: $('#oskCustomerName').val(),
                    customer_email: $('#oskCustomerEmail').val(),
                    product: $('#oskSoftwareProduct').val(),
                    issue_category: $('#oskIssueCategory').val(),
                    priority: $('#oskPriority').val(),
                    issue_description: $('#oskIssueDescription').val(),
                    attachments: uploadedFiles
                };
                
                // Submit form via AJAX
                $.ajax({
                    url: osk_support.ajax_url,
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            const alertHtml = `<div class="osk-alert osk-alert-success">${response.data.message}</div>`;
                            ticketForm.prepend(alertHtml);
                            
                            // Reset form
                            ticketForm[0].reset();
                            fileList.empty();
                            uploadedFiles = [];
                            
                            // Redirect to ticket page after a delay
                            setTimeout(function() {
                                window.location.href = response.data.ticket_url;
                            }, 2000);
                        } else {
                            // Show error message
                            const alertHtml = `<div class="osk-alert osk-alert-error">${response.data.message}</div>`;
                            ticketForm.prepend(alertHtml);
                            
                            // Hide loading state
                            btnText.show();
                            btnLoading.hide();
                            submitBtn.prop('disabled', false);
                        }
                    },
                    error: function() {
                        // Show error message
                        const alertHtml = `<div class="osk-alert osk-alert-error">${osk_support.strings.error}</div>`;
                        ticketForm.prepend(alertHtml);
                        
                        // Hide loading state
                        btnText.show();
                        btnLoading.hide();
                        submitBtn.prop('disabled', false);
                    }
                });
            });
            
            // Reply form submission
            $('#oskReplyForm').on('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitBtn = $('#oskSubmitReply');
                const btnText = submitBtn.find('.osk-btn-text');
                const btnLoading = submitBtn.find('.osk-btn-loading');
                
                btnText.hide();
                btnLoading.show();
                submitBtn.prop('disabled', true);
                
                // Get form data
                const formData = {
                    action: 'osk_add_reply',
                    nonce: osk_support.nonce,
                    ticket_id: $('#oskTicketId').val(),
                    reply_content: $('#oskReplyContent').val(),
                    attachments: window.replyAttachments || []
                };
                
                // Submit form via AJAX
                $.ajax({
                    url: osk_support.ajax_url,
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            const alertHtml = `<div class="osk-alert osk-alert-success">${response.data.message}</div>`;
                            $('#oskReplyForm').prepend(alertHtml);
                            
                            // Reset form
                            $('#oskReplyContent').val('');
                            $('#oskReplyFileList').empty();
                            window.replyAttachments = [];
                            
                            // Reload page to show new reply
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            // Show error message
                            const alertHtml = `<div class="osk-alert osk-alert-error">${response.data.message}</div>`;
                            $('#oskReplyForm').prepend(alertHtml);
                            
                            // Hide loading state
                            btnText.show();
                            btnLoading.hide();
                            submitBtn.prop('disabled', false);
                        }
                    },
                    error: function() {
                        // Show error message
                        const alertHtml = `<div class="osk-alert osk-alert-error">${osk_support.strings.error}</div>`;
                        $('#oskReplyForm').prepend(alertHtml);
                        
                        // Hide loading state
                        btnText.show();
                        btnLoading.hide();
                        submitBtn.prop('disabled', false);
                    }
                });
            });
            
            // Reply file upload
            window.replyAttachments = [];
            
            $('#oskReplyUploadArea').on('click', function() {
                $('#oskReplyFileInput').click();
            });
            
            $('#oskReplyFileInput').on('change', function(e) {
                handleReplyFiles(e.target.files);
            });
            
            $('#oskReplyUploadArea').on('dragover', function(e) {
                e.preventDefault();
                $(this).css('backgroundColor', '#e1f0ff');
                $(this).css('borderColor', '#2980b9');
            });
            
            $('#oskReplyUploadArea').on('dragleave', function() {
                $(this).css('backgroundColor', '#F7F8FC');
                $(this).css('borderColor', '#4A6CF7');
            });
            
            $('#oskReplyUploadArea').on('drop', function(e) {
                e.preventDefault();
                $(this).css('backgroundColor', '#F7F8FC');
                $(this).css('borderColor', '#4A6CF7');
                
                if (e.originalEvent.dataTransfer.files.length) {
                    handleReplyFiles(e.originalEvent.dataTransfer.files);
                }
            });
            
            function handleReplyFiles(files) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Check file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                        continue;
                    }
                    
                    // Check if we already have 5 files
                    if (window.replyAttachments.length >= 5) {
                        alert('Maximum of 5 files allowed.');
                        break;
                    }
                    
                    // Upload file via AJAX
                    const formData = new FormData();
                    formData.append('action', 'osk_upload_file');
                    formData.append('nonce', osk_support.nonce);
                    formData.append('file', file);
                    
                    $.ajax({
                        url: osk_support.ajax_url,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                window.replyAttachments.push(response.data.attachment_id);
                                displayReplyFile(response.data.attachment_id, response.data.filename);
                            } else {
                                alert(response.data.message || osk_support.strings.error);
                            }
                        },
                        error: function() {
                            alert(osk_support.strings.error);
                        }
                    });
                }
                
                // Reset file input
                $('#oskReplyFileInput').val('');
            }
            
            function displayReplyFile(attachmentId, filename) {
                const fileItem = $('<div class="osk-file-item"></div>');
                
                fileItem.html(`
                    <i class="fas fa-file"></i>
                    <div class="osk-file-name">${filename}</div>
                    <div class="osk-file-remove" data-attachment-id="${attachmentId}">
                        <i class="fas fa-times"></i>
                    </div>
                `);
                
                $('#oskReplyFileList').append(fileItem);
                
                // Add remove event
                const removeBtn = fileItem.find('.osk-file-remove');
                removeBtn.on('click', function() {
                    const attachmentId = $(this).data('attachment-id');
                    window.replyAttachments = window.replyAttachments.filter(id => id !== attachmentId);
                    fileItem.remove();
                });
            }
        });
        <?php
        return ob_get_clean();
    }
    
    /**
     * Get admin CSS
     */
    private function get_admin_css() {
        ob_start();
        ?>
        .osk-meta-field {
            margin-bottom: 15px;
        }
        
        .osk-meta-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .osk-meta-field input,
        .osk-meta-field select,
        .osk-meta-field textarea {
            width: 100%;
        }
        <?php
        return ob_get_clean();
    }
    
    /**
     * Get admin JavaScript
     */
    private function get_admin_js() {
        ob_start();
        ?>
        jQuery(document).ready(function($) {
            // Admin-specific JavaScript can be added here
        });
        <?php
        return ob_get_clean();
    }
    
    /**
     * Render support form shortcode
     */
    public function render_support_form() {
        // Get current user info if logged in
        $current_user = wp_get_current_user();
        
        ob_start();
        ?>
        <div class="osk-support-form-container">
            <div class="osk-page-title">
                <h1><?php _e('Report a Problem', 'osk-support'); ?></h1>
                <p><?php _e('Having issues with your software license? We\'re here to help.', 'osk-support'); ?></p>
            </div>

            <div class="osk-ticket-form">
                <form id="oskTicketForm">
                    <div class="osk-form-row">
                        <div class="osk-form-group">
                            <label for="oskOrderNumber"><?php _e('Order Number *', 'osk-support'); ?></label>
                            <input type="text" id="oskOrderNumber" name="order_number" class="osk-form-control" placeholder="<?php _e('e.g. 7949', 'osk-support'); ?>" required>
                        </div>
                        <div class="osk-form-group">
                            <label for="oskCustomerName"><?php _e('Your Name *', 'osk-support'); ?></label>
                            <input type="text" id="oskCustomerName" name="customer_name" class="osk-form-control" placeholder="<?php _e('Enter your full name', 'osk-support'); ?>" value="<?php echo esc_attr($current_user->display_name); ?>" required>
                        </div>
                    </div>
                    
                    <div class="osk-form-row">
                        <div class="osk-form-group">
                            <label for="oskCustomerEmail"><?php _e('Email Address *', 'osk-support'); ?></label>
                            <input type="email" id="oskCustomerEmail" name="customer_email" class="osk-form-control" placeholder="<?php _e('your.email@example.com', 'osk-support'); ?>" value="<?php echo esc_attr($current_user->user_email); ?>" required>
                        </div>
                        <div class="osk-form-group">
                            <label for="oskSoftwareProduct"><?php _e('Software Product *', 'osk-support'); ?></label>
                            <select id="oskSoftwareProduct" name="product" class="osk-form-control" required>
                                <option value=""><?php _e('Select a product', 'osk-support'); ?></option>
                                <option value="adobe"><?php _e('Adobe Creative Cloud', 'osk-support'); ?></option>
                                <option value="autodesk"><?php _e('Autodesk AutoCAD', 'osk-support'); ?></option>
                                <option value="msoffice"><?php _e('Microsoft Office', 'osk-support'); ?></option>
                                <option value="norton"><?php _e('Norton Antivirus', 'osk-support'); ?></option>
                                <option value="kaspersky"><?php _e('Kaspersky Internet Security', 'osk-support'); ?></option>
                                <option value="other"><?php _e('Other Software', 'osk-support'); ?></option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="osk-form-row">
                        <div class="osk-form-group">
                            <label for="oskIssueCategory"><?php _e('Issue Category *', 'osk-support'); ?></label>
                            <select id="oskIssueCategory" name="issue_category" class="osk-form-control" required>
                                <option value=""><?php _e('Select a category', 'osk-support'); ?></option>
                                <option value="invalid-key"><?php _e('Invalid License Key', 'osk-support'); ?></option>
                                <option value="revoke-key"><?php _e('Revoke/Replace Key', 'osk-support'); ?></option>
                                <option value="duplicate-key"><?php _e('Duplicate Key', 'osk-support'); ?></option>
                                <option value="activation-issue"><?php _e('Activation Problem', 'osk-support'); ?></option>
                                <option value="download-issue"><?php _e('Download Problem', 'osk-support'); ?></option>
                                <option value="refund-request"><?php _e('Refund Request', 'osk-support'); ?></option>
                                <option value="other"><?php _e('Other Issue', 'osk-support'); ?></option>
                            </select>
                        </div>
                        <div class="osk-form-group">
                            <label for="oskPriority"><?php _e('Priority Level', 'osk-support'); ?></label>
                            <select id="oskPriority" name="priority" class="osk-form-control">
                                <option value="low"><?php _e('Low', 'osk-support'); ?></option>
                                <option value="medium" selected><?php _e('Medium', 'osk-support'); ?></option>
                                <option value="high"><?php _e('High', 'osk-support'); ?></option>
                                <option value="urgent"><?php _e('Urgent', 'osk-support'); ?></option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="osk-form-group">
                        <label for="oskIssueDescription"><?php _e('Problem Description *', 'osk-support'); ?></label>
                        <textarea id="oskIssueDescription" name="issue_description" class="osk-form-control" placeholder="<?php _e('Please describe your issue in detail...', 'osk-support'); ?>" required></textarea>
                    </div>
                    
                    <div class="osk-form-group">
                        <label><?php _e('Attach Files (Optional)', 'osk-support'); ?></label>
                        <div class="osk-upload-area" id="oskUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3><?php _e('Drag & Drop or Click to Upload', 'osk-support'); ?></h3>
                            <p><?php _e('Supporting documents, screenshots, or error messages (Max: 5 files, 10MB each)', 'osk-support'); ?></p>
                            <button type="button" class="osk-btn osk-btn-upload" id="oskSelectFiles"><?php _e('Select Files', 'osk-support'); ?></button>
                            <input type="file" id="oskFileInput" multiple style="display: none;">
                        </div>
                        <div class="osk-file-list" id="oskFileList"></div>
                    </div>
                    
                    <div class="osk-form-group">
                        <button type="submit" class="osk-btn osk-btn-primary osk-btn-block" id="oskSubmitTicket">
                            <span class="osk-btn-text"><?php _e('Submit Ticket', 'osk-support'); ?></span>
                            <span class="osk-btn-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> <?php _e('Submitting...', 'osk-support'); ?>
                            </span>
                        </button>
                    </div>
                    
                    <div class="osk-form-footer">
                        <p><?php _e('Need immediate assistance? Contact us at', 'osk-support'); ?> <a href="mailto:support@ordersoftwarekeys.com">support@ordersoftwarekeys.com</a></p>
                    </div>
                </form>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
    
    /**
     * Render support dashboard shortcode
     */
    public function render_support_dashboard() {
        // Get current user
        $current_user = wp_get_current_user();
        
        // Get user's tickets
        $user_tickets = get_posts(array(
            'post_type' => OSK_SUPPORT_POST_TYPE,
            'posts_per_page' => -1,
            'meta_query' => array(
                array(
                    'key' => '_osk_customer_email',
                    'value' => $current_user->user_email,
                )
            ),
        ));
        
        ob_start();
        ?>
        <div class="osk-support-dashboard">
            <div class="osk-page-title">
                <h1><?php _e('Support Dashboard', 'osk-support'); ?></h1>
                <p><?php _e('View and manage your support tickets', 'osk-support'); ?></p>
            </div>

            <div class="osk-ticket-stats">
                <div class="osk-stat-card">
                    <div class="osk-stat-icon osk-stat-blue">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div class="osk-stat-value"><?php echo count($user_tickets); ?></div>
                    <div class="osk-stat-label"><?php _e('Total Tickets', 'osk-support'); ?></div>
                </div>
                
                <?php
                $open_tickets = 0;
                $pending_tickets = 0;
                $closed_tickets = 0;
                
                foreach ($user_tickets as $ticket) {
                    $status = wp_get_post_terms($ticket->ID, 'ticket_status');
                    if (!empty($status)) {
                        $status_name = $status[0]->name;
                        if ($status_name === 'Open') {
                            $open_tickets++;
                        } elseif ($status_name === 'Pending') {
                            $pending_tickets++;
                        } elseif ($status_name === 'Closed') {
                            $closed_tickets++;
                        }
                    }
                }
                ?>
                
                <div class="osk-stat-card">
                    <div class="osk-stat-icon osk-stat-orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="osk-stat-value"><?php echo $open_tickets; ?></div>
                    <div class="osk-stat-label"><?php _e('Open Tickets', 'osk-support'); ?></div>
                </div>
                
                <div class="osk-stat-card">
                    <div class="osk-stat-icon osk-stat-green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="osk-stat-value"><?php echo $closed_tickets; ?></div>
                    <div class="osk-stat-label"><?php _e('Closed Tickets', 'osk-support'); ?></div>
                </div>
            </div>

            <div class="osk-ticket-list">
                <div class="osk-ticket-list-header">
                    <h3 class="osk-ticket-list-title"><?php _e('Your Tickets', 'osk-support'); ?></h3>
                    <a href="<?php echo home_url('/submit-ticket/'); ?>" class="osk-btn"><?php _e('Create New Ticket', 'osk-support'); ?></a>
                </div>
                <div class="osk-ticket-list-body">
                    <?php if (empty($user_tickets)) : ?>
                        <div class="osk-empty-state">
                            <div class="osk-empty-state-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <h3 class="osk-empty-state-title"><?php _e('No tickets found', 'osk-support'); ?></h3>
                            <p class="osk-empty-state-text"><?php _e('You haven\'t created any support tickets yet.', 'osk-support'); ?></p>
                            <a href="<?php echo home_url('/submit-ticket/'); ?>" class="osk-btn"><?php _e('Create Your First Ticket', 'osk-support'); ?></a>
                        </div>
                    <?php else : ?>
                        <?php foreach ($user_tickets as $ticket) : ?>
                            <?php
                            $ticket_id = get_post_meta($ticket->ID, '_osk_ticket_id', true);
                            $status = wp_get_post_terms($ticket->ID, 'ticket_status');
                            $status_name = !empty($status) ? $status[0]->name : 'Open';
                            $status_class = 'osk-status-' . strtolower($status_name);
                            ?>
                            <div class="osk-ticket-item">
                                <div class="osk-ticket-id">#<?php echo $ticket_id; ?></div>
                                <div class="osk-ticket-subject"><?php echo $ticket->post_title; ?></div>
                                <div class="osk-ticket-status <?php echo $status_class; ?>"><?php echo $status_name; ?></div>
                                <div class="osk-ticket-date"><?php echo date('M j, Y', strtotime($ticket->post_date)); ?></div>
                            </div>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </div>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
    
    /**
     * Add rewrite rules for ticket pages
     */
    public function add_rewrite_rules() {
        add_rewrite_rule(
            '^requests/([0-9]+)/?$',
            'index.php?post_type=' . OSK_SUPPORT_POST_TYPE . '&ticket_id=$matches[1]&ticket_view=single',
            'top'
        );
    }
    
    /**
     * Add query vars
     */
    public function add_query_vars($query_vars) {
        $query_vars[] = 'ticket_id';
        $query_vars[] = 'ticket_view';
        return $query_vars;
    }
    
    /**
     * Custom template include
     */
    public function template_include($template) {
        if (get_query_var('post_type') === OSK_SUPPORT_POST_TYPE && get_query_var('ticket_view') === 'single') {
            $ticket_id = get_query_var('ticket_id');
            
            // Find the ticket by custom ID
            $tickets = get_posts(array(
                'post_type' => OSK_SUPPORT_POST_TYPE,
                'meta_query' => array(
                    array(
                        'key' => '_osk_ticket_id',
                        'value' => $ticket_id,
                    )
                ),
                'posts_per_page' => 1,
            ));
            
            if (!empty($tickets)) {
                $ticket = $tickets[0];
                
                // Check if the current user is the ticket owner or an admin
                $current_user = wp_get_current_user();
                $customer_email = get_post_meta($ticket->ID, '_osk_customer_email', true);
                
                if ($current_user->user_email === $customer_email || current_user_can('manage_options')) {
                    // Display the ticket
                    echo $this->render_single_ticket($ticket);
                    return;
                }
            }
            
            // If ticket not found or user doesn't have access, redirect to dashboard
            wp_redirect(home_url('/requests/'));
            exit;
        }
        
        return $template;
    }
    
    /**
     * Render single ticket view
     */
    private function render_single_ticket($ticket) {
        $ticket_id = get_post_meta($ticket->ID, '_osk_ticket_id', true);
        $customer_name = get_post_meta($ticket->ID, '_osk_customer_name', true);
        $customer_email = get_post_meta($ticket->ID, '_osk_customer_email', true);
        $order_number = get_post_meta($ticket->ID, '_osk_order_number', true);
        $product = get_post_meta($ticket->ID, '_osk_product', true);
        
        $status = wp_get_post_terms($ticket->ID, 'ticket_status');
        $status_name = !empty($status) ? $status[0]->name : 'Open';
        
        $priority = wp_get_post_terms($ticket->ID, 'ticket_priority');
        $priority_name = !empty($priority) ? $priority[0]->name : 'Medium';
        
        // Get ticket replies (comments)
        $replies = get_comments(array(
            'post_id' => $ticket->ID,
            'status' => 'approve',
            'type' => 'ticket_reply',
            'orderby' => 'comment_date',
            'order' => 'ASC',
        ));
        
        ob_start();
        ?>
        <!DOCTYPE html>
        <html <?php language_attributes(); ?>>
        <head>
            <meta charset="<?php bloginfo('charset'); ?>">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title><?php _e('Ticket', 'osk-support'); ?> #<?php echo $ticket_id; ?> - <?php bloginfo('name'); ?></title>
            <?php wp_head(); ?>
        </head>
        <body <?php body_class(); ?>>
            <div class="osk-container">
                <a href="<?php echo home_url('/requests/'); ?>" class="osk-back-link">
                    <i class="fas fa-arrow-left"></i> <?php _e('Back to Dashboard', 'osk-support'); ?>
                </a>
                
                <div class="osk-page-title">
                    <h1><?php _e('Ticket', 'osk-support'); ?> #<?php echo $ticket_id; ?></h1>
                    <p><?php _e('Created on', 'osk-support'); ?> <?php echo date('F j, Y', strtotime($ticket->post_date)); ?> <?php _e('by', 'osk-support'); ?> <?php echo $customer_name; ?></p>
                </div>

                <div class="osk-ticket-detail-container">
                    <div class="osk-ticket-conversation">
                        <div class="osk-ticket-list">
                            <div class="osk-conversation-header">
                                <h3 class="osk-conversation-title"><?php echo $ticket->post_title; ?></h3>
                                <div class="osk-conversation-meta">
                                    <span><i class="fas fa-user"></i> <?php echo $customer_name; ?></span>
                                    <span><i class="fas fa-calendar"></i> <?php echo date('M j, Y', strtotime($ticket->post_date)); ?></span>
                                </div>
                            </div>
                            <div class="osk-conversation-messages">
                                <div class="osk-message">
                                    <div class="osk-message-avatar"><?php echo substr($customer_name, 0, 2); ?></div>
                                    <div class="osk-message-content">
                                        <div class="osk-message-header">
                                            <div class="osk-message-name"><?php echo $customer_name; ?></div>
                                            <div class="osk-message-time"><?php echo date('M j, Y, g:i a', strtotime($ticket->post_date)); ?></div>
                                        </div>
                                        <div class="osk-message-bubble">
                                            <div class="osk-message-text">
                                                <?php echo wpautop($ticket->post_content); ?>
                                            </div>
                                            <?php
                                            $attachments = get_post_meta($ticket->ID, '_osk_attachments', true);
                                            if (!empty($attachments) && is_array($attachments)) :
                                            ?>
                                                <div class="osk-message-attachments">
                                                    <?php foreach ($attachments as $attachment_id) : ?>
                                                        <?php
                                                        $attachment_url = wp_get_attachment_url($attachment_id);
                                                        $attachment_filename = basename($attachment_url);
                                                        $attachment_type = wp_check_filetype($attachment_url);
                                                        $icon = 'fa-file';
                                                        
                                                        if (strpos($attachment_type['type'], 'image') !== false) {
                                                            $icon = 'fa-file-image';
                                                        } elseif (strpos($attachment_type['type'], 'pdf') !== false) {
                                                            $icon = 'fa-file-pdf';
                                                        } elseif (strpos($attachment_type['type'], 'text') !== false) {
                                                            $icon = 'fa-file-alt';
                                                        }
                                                        ?>
                                                        <a href="<?php echo $attachment_url; ?>" class="osk-attachment" target="_blank">
                                                            <i class="fas <?php echo $icon; ?>"></i>
                                                            <?php echo $attachment_filename; ?>
                                                        </a>
                                                    <?php endforeach; ?>
                                                </div>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                </div>
                                
                                <?php foreach ($replies as $reply) : ?>
                                    <?php
                                    $is_admin = $reply->user_id > 0;
                                    $reply_attachments = get_comment_meta($reply->comment_ID, '_osk_attachments', true);
                                    ?>
                                    <div class="osk-message <?php echo $is_admin ? 'agent' : ''; ?>">
                                        <div class="osk-message-avatar">
                                            <?php echo $is_admin ? 'AD' : substr($customer_name, 0, 2); ?>
                                        </div>
                                        <div class="osk-message-content">
                                            <div class="osk-message-header">
                                                <div class="osk-message-name">
                                                    <?php echo $is_admin ? 'Support Agent' : $customer_name; ?>
                                                </div>
                                                <div class="osk-message-time">
                                                    <?php echo date('M j, Y, g:i a', strtotime($reply->comment_date)); ?>
                                                </div>
                                            </div>
                                            <div class="osk-message-bubble">
                                                <div class="osk-message-text">
                                                    <?php echo wpautop($reply->comment_content); ?>
                                                </div>
                                                <?php if (!empty($reply_attachments) && is_array($reply_attachments)) : ?>
                                                    <div class="osk-message-attachments">
                                                        <?php foreach ($reply_attachments as $attachment_id) : ?>
                                                            <?php
                                                            $attachment_url = wp_get_attachment_url($attachment_id);
                                                            $attachment_filename = basename($attachment_url);
                                                            $attachment_type = wp_check_filetype($attachment_url);
                                                            $icon = 'fa-file';
                                                            
                                                            if (strpos($attachment_type['type'], 'image') !== false) {
                                                                $icon = 'fa-file-image';
                                                            } elseif (strpos($attachment_type['type'], 'pdf') !== false) {
                                                                $icon = 'fa-file-pdf';
                                                            } elseif (strpos($attachment_type['type'], 'text') !== false) {
                                                                $icon = 'fa-file-alt';
                                                            }
                                                            ?>
                                                            <a href="<?php echo $attachment_url; ?>" class="osk-attachment" target="_blank">
                                                                <i class="fas <?php echo $icon; ?>"></i>
                                                                <?php echo $attachment_filename; ?>
                                                            </a>
                                                        <?php endforeach; ?>
                                                    </div>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                            
                            <?php if ($status_name !== 'Closed') : ?>
                                <div class="osk-message-reply">
                                    <form id="oskReplyForm">
                                        <input type="hidden" id="oskTicketId" value="<?php echo $ticket->ID; ?>">
                                        <textarea id="oskReplyContent" class="osk-reply-textarea" placeholder="<?php _e('Type your reply...', 'osk-support'); ?>" required></textarea>
                                        <div class="osk-reply-actions">
                                            <div class="osk-reply-options">
                                                <div class="osk-upload-area" id="oskReplyUploadArea" style="padding: 10px; border: 1px dashed var(--border); background-color: var(--secondary); cursor: pointer; display: inline-block;">
                                                    <i class="fas fa-paperclip"></i> <?php _e('Attach Files', 'osk-support'); ?>
                                                    <input type="file" id="oskReplyFileInput" multiple style="display: none;">
                                                </div>
                                                <div class="osk-file-list" id="oskReplyFileList"></div>
                                            </div>
                                            <div>
                                                <button type="submit" class="osk-btn" id="oskSubmitReply">
                                                    <span class="osk-btn-text"><?php _e('Send Reply', 'osk-support'); ?></span>
                                                    <span class="osk-btn-loading" style="display: none;">
                                                        <i class="fas fa-spinner fa-spin"></i> <?php _e('Sending...', 'osk-support'); ?>
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            <?php endif; ?>
                        </div>
                    </div>
                    
                    <div class="osk-ticket-sidebar">
                        <div class="osk-ticket-info">
                            <div class="osk-info-header"><?php _e('Ticket Information', 'osk-support'); ?></div>
                            <div class="osk-info-body">
                                <div class="osk-info-row">
                                    <div class="osk-info-label"><?php _e('Status', 'osk-support'); ?></div>
                                    <div class="osk-info-value">
                                        <span class="osk-ticket-status osk-status-<?php echo strtolower($status_name); ?>"><?php echo $status_name; ?></span>
                                    </div>
                                </div>
                                <div class="osk-info-row">
                                    <div class="osk-info-label"><?php _e('Priority', 'osk-support'); ?></div>
                                    <div class="osk-info-value"><?php echo $priority_name; ?></div>
                                </div>
                                <div class="osk-info-row">
                                    <div class="osk-info-label"><?php _e('Order Number', 'osk-support'); ?></div>
                                    <div class="osk-info-value"><?php echo $order_number; ?></div>
                                </div>
                                <div class="osk-info-row">
                                    <div class="osk-info-label"><?php _e('Product', 'osk-support'); ?></div>
                                    <div class="osk-info-value"><?php echo $this->get_product_name($product); ?></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="osk-ticket-info">
                            <div class="osk-info-header"><?php _e('Customer Information', 'osk-support'); ?></div>
                            <div class="osk-info-body">
                                <div class="osk-info-row">
                                    <div class="osk-info-label"><?php _e('Name', 'osk-support'); ?></div>
                                    <div class="osk-info-value"><?php echo $customer_name; ?></div>
                                </div>
                                <div class="osk-info-row">
                                    <div class="osk-info-label"><?php _e('Email', 'osk-support'); ?></div>
                                    <div class="osk-info-value"><?php echo $customer_email; ?></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php wp_footer(); ?>
        </body>
        </html>
        <?php
        return ob_get_clean();
    }
    
    /**
     * Get product name from value
     */
    private function get_product_name($product_value) {
        $products = array(
            'adobe' => __('Adobe Creative Cloud', 'osk-support'),
            'autodesk' => __('Autodesk AutoCAD', 'osk-support'),
            'msoffice' => __('Microsoft Office', 'osk-support'),
            'norton' => __('Norton Antivirus', 'osk-support'),
            'kaspersky' => __('Kaspersky Internet Security', 'osk-support'),
            'other' => __('Other Software', 'osk-support'),
        );
        
        return isset($products[$product_value]) ? $products[$product_value] : $product_value;
    }
    
    /**
     * AJAX submit ticket
     */
    public function ajax_submit_ticket() {
        // Verify nonce
        if (!wp_verify_nonce($_POST['nonce'], 'osk_support_nonce')) {
            wp_send_json_error(array('message' => __('Security check failed', 'osk-support')));
        }
        
        // Sanitize and validate form data
        $order_number = sanitize_text_field($_POST['order_number']);
        $customer_name = sanitize_text_field($_POST['customer_name']);
        $customer_email = sanitize_email($_POST['customer_email']);
        $product = sanitize_text_field($_POST['product']);
        $issue_category = sanitize_text_field($_POST['issue_category']);
        $priority = sanitize_text_field($_POST['priority']);
        $issue_description = wp_kses_post($_POST['issue_description']);
        
        // Validate required fields
        if (empty($order_number) || empty($customer_name) || empty($customer_email) || 
            empty($product) || empty($issue_category) || empty($issue_description)) {
            wp_send_json_error(array('message' => __('Please fill in all required fields.', 'osk-support')));
        }
        
        // Create ticket post
        $ticket_id = wp_insert_post(array(
            'post_title'   => $issue_category . ' - ' . $order_number,
            'post_content' => $issue_description,
            'post_status'  => 'publish',
            'post_author'  => 1,
            'post_type'    => OSK_SUPPORT_POST_TYPE,
        ));
        
        if (is_wp_error($ticket_id)) {
            wp_send_json_error(array('message' => __('Failed to create ticket. Please try again.', 'osk-support')));
        }
        
        // Set ticket status to Open
        wp_set_post_terms($ticket_id, 'Open', 'ticket_status');
        
        // Set ticket priority
        wp_set_post_terms($ticket_id, $priority, 'ticket_priority');
        
        // Set ticket category
        wp_set_post_terms($ticket_id, $issue_category, 'ticket_category');
        
        // Save ticket meta
        update_post_meta($ticket_id, '_osk_order_number', $order_number);
        update_post_meta($ticket_id, '_osk_customer_name', $customer_name);
        update_post_meta($ticket_id, '_osk_customer_email', $customer_email);
        update_post_meta($ticket_id, '_osk_product', $product);
        
        // Generate unique ticket ID (6 digits)
        $unique_id = $this->generate_unique_ticket_id();
        update_post_meta($ticket_id, '_osk_ticket_id', $unique_id);
        
        // Handle file attachments
        if (!empty($_POST['attachments'])) {
            $attachments = array_map('intval', $_POST['attachments']);
            update_post_meta($ticket_id, '_osk_attachments', $attachments);
        }
        
        // Send notification email to customer
        $this->send_notification_email($ticket_id, 'customer_new_ticket');
        
        // Send notification email to admin
        $this->send_notification_email($ticket_id, 'admin_new_ticket');
        
        // Return success response with ticket URL
        $ticket_url = home_url('/requests/' . $unique_id . '/');
        wp_send_json_success(array(
            'message' => __('Ticket submitted successfully!', 'osk-support'),
            'ticket_id' => $unique_id,
            'ticket_url' => $ticket_url
        ));
    }
    
    /**
     * AJAX upload file
     */
    public function ajax_upload_file() {
        // Verify nonce
        if (!wp_verify_nonce($_POST['nonce'], 'osk_support_nonce')) {
            wp_die(__('Security check failed', 'osk-support'));
        }
        
        // Check if file was uploaded
        if (!isset($_FILES['file']) || $_FILES['file']['error'] !== UPLOAD_ERR_OK) {
            wp_send_json_error(array('message' => __('File upload failed.', 'osk-support')));
        }
        
        // Check file size (10MB max)
        $max_size = 10 * 1024 * 1024; // 10MB
        if ($_FILES['file']['size'] > $max_size) {
            wp_send_json_error(array('message' => __('File is too large. Maximum size is 10MB.', 'osk-support')));
        }
        
        // Check file type
        $allowed_types = array('image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'text/plain');
        $file_type = wp_check_filetype(basename($_FILES['file']['name']));
        
        if (!in_array($file_type['type'], $allowed_types)) {
            wp_send_json_error(array('message' => __('File type not allowed.', 'osk-support')));
        }
        
        // Upload file
        $uploaded_file = wp_handle_upload($_FILES['file'], array('test_form' => false));
        
        if (isset($uploaded_file['error'])) {
            wp_send_json_error(array('message' => $uploaded_file['error']));
        }
        
        // Create attachment
        $attachment_id = wp_insert_attachment(array(
            'post_mime_type' => $uploaded_file['type'],
            'post_title' => basename($uploaded_file['file']),
            'post_content' => '',
            'post_status' => 'inherit'
        ), $uploaded_file['file']);
        
        if (is_wp_error($attachment_id)) {
            wp_send_json_error(array('message' => __('Failed to create attachment.', 'osk-support')));
        }
        
        // Generate attachment metadata
        require_once(ABSPATH . 'wp-admin/includes/image.php');
        $attachment_data = wp_generate_attachment_metadata($attachment_id, $uploaded_file['file']);
        wp_update_attachment_metadata($attachment_id, $attachment_data);
        
        // Return success response
        wp_send_json_success(array(
            'attachment_id' => $attachment_id,
            'filename' => basename($uploaded_file['file']),
            'url' => wp_get_attachment_url($attachment_id)
        ));
    }
    
    /**
     * AJAX add reply
     */
    public function ajax_add_reply() {
        // Verify nonce
        if (!wp_verify_nonce($_POST['nonce'], 'osk_support_nonce')) {
            wp_die(__('Security check failed', 'osk-support'));
        }
        
        // Get ticket ID
        $ticket_id = intval($_POST['ticket_id']);
        if (!$ticket_id) {
            wp_send_json_error(array('message' => __('Invalid ticket ID.', 'osk-support')));
        }
        
        // Get reply content
        $reply_content = wp_kses_post($_POST['reply_content']);
        if (empty($reply_content)) {
            wp_send_json_error(array('message' => __('Reply content cannot be empty.', 'osk-support')));
        }
        
        // Get user info
        $current_user = wp_get_current_user();
        $is_admin = current_user_can('manage_options');
        
        // Create reply comment
        $comment_data = array(
            'comment_post_ID' => $ticket_id,
            'comment_author' => $is_admin ? $current_user->display_name : get_post_meta($ticket_id, '_osk_customer_name', true),
            'comment_author_email' => $is_admin ? $current_user->user_email : get_post_meta($ticket_id, '_osk_customer_email', true),
            'comment_content' => $reply_content,
            'comment_type' => 'ticket_reply',
            'user_id' => $is_admin ? $current_user->ID : 0,
            'comment_approved' => 1,
        );
        
        $comment_id = wp_insert_comment($comment_data);
        
        if (is_wp_error($comment_id)) {
            wp_send_json_error(array('message' => __('Failed to add reply. Please try again.', 'osk-support')));
        }
        
        // Handle file attachments
        if (!empty($_POST['attachments'])) {
            $attachments = array_map('intval', $_POST['attachments']);
            update_comment_meta($comment_id, '_osk_attachments', $attachments);
        }
        
        // Update ticket last activity
        update_post_meta($ticket_id, '_osk_last_activity', current_time('mysql'));
        
        // Send notification email
        if ($is_admin) {
            $this->send_notification_email($ticket_id, 'customer_reply');
        } else {
            $this->send_notification_email($ticket_id, 'admin_reply');
        }
        
        // Return success response
        wp_send_json_success(array(
            'message' => __('Reply added successfully.', 'osk-support'),
            'comment_id' => $comment_id
        ));
    }
    
    /**
     * Generate unique ticket ID
     */
    private function generate_unique_ticket_id() {
        // Generate a random 6-digit number
        $ticket_id = sprintf('%06d', mt_rand(100000, 999999));
        
        // Check if it's already in use
        $existing_ticket = get_posts(array(
            'post_type' => OSK_SUPPORT_POST_TYPE,
            'meta_query' => array(
                array(
                    'key' => '_osk_ticket_id',
                    'value' => $ticket_id,
                )
            ),
            'posts_per_page' => 1,
        ));
        
        // If it's already in use, generate a new one
        if (!empty($existing_ticket)) {
            return $this->generate_unique_ticket_id();
        }
        
        return $ticket_id;
    }
    
    /**
     * Send notification email
     */
    private function send_notification_email($ticket_id, $type) {
        $ticket = get_post($ticket_id);
        $ticket_id_display = get_post_meta($ticket_id, '_osk_ticket_id', true);
        $customer_name = get_post_meta($ticket_id, '_osk_customer_name', true);
        $customer_email = get_post_meta($ticket_id, '_osk_customer_email', true);
        $ticket_url = home_url('/requests/' . $ticket_id_display . '/');
        
        $subject = '';
        $message = '';
        $to = '';
        
        switch ($type) {
            case 'customer_new_ticket':
                $subject = sprintf(__('Support Ticket #%s Created', 'osk-support'), $ticket_id_display);
                $message = sprintf(
                    __('Hello %s,

Your support ticket #%s has been created successfully.

You can view your ticket here: %s

We will respond to your ticket as soon as possible.

Thank you,
OrderSoftwareKeys Support Team', 'osk-support'),
                    $customer_name,
                    $ticket_id_display,
                    $ticket_url
                );
                $to = $customer_email;
                break;
                
            case 'admin_new_ticket':
                $subject = sprintf(__('New Support Ticket #%s', 'osk-support'), $ticket_id_display);
                $message = sprintf(
                    __('A new support ticket has been created:

Ticket ID: #%s
Customer: %s (%s)
Subject: %s

View ticket: %s', 'osk-support'),
                    $ticket_id_display,
                    $customer_name,
                    $customer_email,
                    $ticket->post_title,
                    $ticket_url
                );
                $to = get_option('admin_email');
                break;
                
            case 'customer_reply':
                $subject = sprintf(__('New Reply to Ticket #%s', 'osk-support'), $ticket_id_display);
                $message = sprintf(
                    __('Hello %s,

There is a new reply to your support ticket #%s.

View ticket: %s

Thank you,
OrderSoftwareKeys Support Team', 'osk-support'),
                    $customer_name,
                    $ticket_id_display,
                    $ticket_url
                );
                $to = $customer_email;
                break;
                
            case 'admin_reply':
                $subject = sprintf(__('New Reply to Ticket #%s', 'osk-support'), $ticket_id_display);
                $message = sprintf(
                    __('A new reply has been added to ticket #%s:

Customer: %s (%s)

View ticket: %s', 'osk-support'),
                    $ticket_id_display,
                    $customer_name,
                    $customer_email,
                    $ticket_url
                );
                $to = get_option('admin_email');
                break;
        }
        
        if (!empty($to) && !empty($subject) && !empty($message)) {
            $headers = array('Content-Type: text/html; charset=UTF-8');
            wp_mail($to, $subject, nl2br($message), $headers);
        }
    }
}

// Initialize the plugin
new OSK_Support_System();
